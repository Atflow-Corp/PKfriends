import{j as e}from"./index-B2apw5Xw.js";import{C as t,d as a,a as n,b as r,c as i}from"./card-B9Kwb8SV.js";import{B as s}from"./button-CNch1c_D.js";import{r as d}from"./react-vendor-B8CcSR15.js";import{H as l}from"./Header-ByXwxB6y.js";import{j as o,P as m,p as u,k as c,l as g,E as p}from"./html2canvas.esm-BecFnliz.js";import{s as f,S as h}from"./storage-GRehWpHF.js";import{j as x,D as w}from"./ui-vendor-CU6wz7s2.js";const v=()=>{var v,S;const[N,T]=d.useState(""),[D,j]=d.useState(""),[y,I]=d.useState([]),[b,$]=d.useState([]),[C,A]=d.useState([]),_=new URLSearchParams("undefined"!=typeof window?window.location.search:"").get("patientId"),{patient:O,prescription:R,tdmResult:U,tdmExtraSeries:M,prescriptionInfo:J,inputTOXI:k}=(({patientId:e,drugName:t})=>{const[a,n]=d.useState(null),[r,i]=d.useState(null),[s,l]=d.useState(null),[o,m]=d.useState(null),[u,c]=d.useState(null),[g,p]=d.useState(void 0),[x,w]=d.useState(!0);return d.useEffect(()=>{e&&t?(()=>{try{const r=(f.getJSON(h.patients,[])||[]).map(e=>({...e,createdAt:e.createdAt?new Date(e.createdAt):new Date})).find(t=>t.id===e);r&&n(r);const s=(f.getJSON(h.prescriptions,[])||[]).map(e=>({...e,startDate:e.startDate?new Date(e.startDate):new Date})).find(a=>a.patientId===e&&a.drugName===t);s&&i(s);let d=window.localStorage.getItem(`tdmfriends:tdmResult:${e}:${t}`);d||(d=window.localStorage.getItem(`tdmfriends:tdmResult:${e}`));let o=null;if(d){const n=`tdmfriends:tdmResults:${e}:${t}`,r=window.localStorage.getItem(n);if(r)try{const e=JSON.parse(r);e&&e.length>0&&(o=e.filter(e=>e.timestamp||e.id).sort((e,t)=>{const a=e.timestamp?new Date(e.timestamp).getTime():parseInt(e.id||"0");return(t.timestamp?new Date(t.timestamp).getTime():parseInt(t.id||"0"))-a})[0])}catch(a){}}else{const n=`tdmfriends:tdmResults:${e}:${t}`,r=window.localStorage.getItem(n);if(r)try{const e=JSON.parse(r);e&&e.length>0&&(o=e.filter(e=>e.timestamp||e.id).sort((e,t)=>{const a=e.timestamp?new Date(e.timestamp).getTime():parseInt(e.id||"0");return(t.timestamp?new Date(t.timestamp).getTime():parseInt(t.id||"0"))-a})[0],(null==o?void 0:o.summary)?d=JSON.stringify(o.summary):(null==o?void 0:o.data)&&(d=JSON.stringify(o.data)))}catch(a){}}if(d&&l(JSON.parse(d)),(null==o?void 0:o.dataset)&&Array.isArray(o.dataset)&&o.dataset.length>0){const e=o.dataset[0];void 0!==e.TOXI&&p(e.TOXI)}const u=`tdmfriends:tdmExtraSeries:${e}:${t}`,g=window.localStorage.getItem(u);g&&m(JSON.parse(g));const x=`tdmfriends:prescription:${e}:${t}`,w=window.localStorage.getItem(x);if(w){const e=JSON.parse(w);c({tau:e.tau,amount:e.amount})}}catch(r){}finally{w(!1)}})():w(!1)},[e,t]),{patient:a,prescription:r,tdmResult:s,tdmExtraSeries:o,prescriptionInfo:u,inputTOXI:g,isLoading:x}})({patientId:_,drugName:D});d.useEffect(()=>{(()=>{try{const t=(f.getJSON(h.patients,[])||[]).map(e=>({...e,createdAt:e.createdAt?new Date(e.createdAt):new Date}));I(t);const a=(f.getJSON(h.bloodTests,[])||[]).map(e=>({...e,testDate:e.testDate?new Date(e.testDate):new Date}));$(a);const n=(f.getJSON(h.drugAdministrations,[])||[]).map(e=>({...e,date:e.date?new Date(e.date):new Date}));if(A(n),_)try{const e=window.localStorage.getItem(`tdmfriends:selectedDrug:${_}`);e&&j(e)}catch(e){}}catch(e){}})(),T((new Date).toLocaleString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}))},[_]);return O?e.jsxs("div",{className:"min-h-screen bg-gray-50 dark:bg-background",children:[e.jsx(l,{}),e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsx(t,{className:"mb-6",children:e.jsx(a,{className:"py-4",children:e.jsx("p",{className:"text-sm text-gray-600 dark:text-muted-foreground text-center",children:"Report를 조회한 후 이 탭을 닫고 이전 창으로 복귀하면 계속해서 서비스를 이용하실 수 있습니다."})})}),e.jsx(t,{className:"mb-6",children:e.jsx(n,{children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsxs(r,{className:"text-xl",children:[O.name," 환자의 ",D," TDM 분석 보고서 - 분석일자: ",N]}),e.jsxs(i,{className:"mt-2",children:[O.name," 환자(",O.id,")의 Report를 조회하고 다운로드할 수 있습니다."]})]}),e.jsxs(s,{onClick:async()=>{try{const e=document.getElementById("report-content");if(!e)return void alert("보고서 내용을 찾을 수 없습니다.");const t=document.querySelector("[data-download-button]");t&&(t.disabled=!0,t.textContent="PDF 생성 중...");const a=await g(e,{scale:1.5,useCORS:!0,allowTaint:!0,backgroundColor:"#ffffff",logging:!1,width:e.scrollWidth,height:e.scrollHeight,scrollX:0,scrollY:0}),n=a.toDataURL("image/png",.95),r=new p({orientation:"portrait",unit:"mm",format:"a4"}),i=15,s=210-2*i,d=297-2*i,l=a.width,o=a.height,m=Math.min(s/l,d/o),u=l*m,c=o*m,f=d,h=Math.ceil(c/f);for(let g=0;g<h;g++){g>0&&r.addPage();const e=-g*f,t=g*f;Math.min(f,c-t);r.addImage(n,"PNG",i,i+e,u,c,void 0,"FAST")}const x=`${(null==O?void 0:O.name)||"환자"}_${D||"약품"}_TDM_분석보고서_${(new Date).toISOString().split("T")[0]}.pdf`;r.save(x),t&&(t.disabled=!1,t.textContent="Report Download")}catch(e){alert("PDF 생성 중 오류가 발생했습니다: "+e.message);const t=document.querySelector("[data-download-button]");t&&(t.disabled=!1,t.textContent="Report Download")}},className:"flex items-center gap-2","data-download-button":!0,children:[e.jsx(w,{className:"h-4 w-4"}),"Report Download"]})]})})}),e.jsxs(t,{className:"mb-6",id:"report-content",children:[e.jsx(n,{}),e.jsx(a,{children:e.jsx(o,{currentPatient:O,selectedPrescription:R,latestBloodTest:b.filter(e=>e.patientId===O.id&&e.drugName===D).sort((e,t)=>new Date(t.testDate).getTime()-new Date(e.testDate).getTime())[0]||null,drugAdministrations:C.filter(e=>e.patientId===O.id&&e.drugName===D),isExpanded:!0,onToggleExpanded:()=>{},disableHover:!0})}),e.jsx(a,{className:"pt-6 border-t",children:O&&D?U?e.jsx(m,{showSimulation:!0,currentPatientName:O.name,selectedDrug:D,targetMin:(null==R?void 0:R.tdmTargetValue)?parseFloat((null==(v=R.tdmTargetValue.split("-")[0])?void 0:v.trim())||"0"):null,targetMax:(null==R?void 0:R.tdmTargetValue)?parseFloat((null==(S=R.tdmTargetValue.split("-")[1])?void 0:S.trim())||"0"):null,recentAUC:(null==U?void 0:U.AUC_24_before)||(null==U?void 0:U.AUC_tau_before)||(null==U?void 0:U.AUC24h_before)||(null==U?void 0:U.AUCtau_before)||null,recentMax:(null==U?void 0:U.CMAX_before)||(null==U?void 0:U.CMax_before)||null,recentTrough:(null==U?void 0:U.CTROUGH_before)||(null==U?void 0:U.CTrough_before)||null,predictedAUC:(null==U?void 0:U.AUC_24_after)||(null==U?void 0:U.AUC_tau_after)||(null==U?void 0:U.AUC24h_after)||(null==U?void 0:U.AUCtau_after)||null,predictedMax:(null==U?void 0:U.CMAX_after)||(null==U?void 0:U.CMax_after)||null,predictedTrough:(null==U?void 0:U.CTROUGH_after)||(null==U?void 0:U.CTrough_after)||null,ipredSeries:null==M?void 0:M.ipredSeries,predSeries:null==M?void 0:M.predSeries,observedSeries:null==M?void 0:M.observedSeries,tdmIndication:null==R?void 0:R.indication,tdmTarget:null==R?void 0:R.tdmTarget,tdmTargetValue:null==R?void 0:R.tdmTargetValue,latestAdministration:C.filter(e=>e.patientId===O.id&&e.drugName===D).sort((e,t)=>{const a=new Date(`${e.date}T${e.time}`);return new Date(`${t.date}T${t.time}`).getTime()-a.getTime()})[0]?{dose:C.filter(e=>e.patientId===O.id&&e.drugName===D).sort((e,t)=>{const a=new Date(`${e.date}T${e.time}`);return new Date(`${t.date}T${t.time}`).getTime()-a.getTime()})[0].dose,unit:C.filter(e=>e.patientId===O.id&&e.drugName===D).sort((e,t)=>{const a=new Date(`${e.date}T${e.time}`);return new Date(`${t.date}T${t.time}`).getTime()-a.getTime()})[0].unit,intervalHours:C.filter(e=>e.patientId===O.id&&e.drugName===D).sort((e,t)=>{const a=new Date(`${e.date}T${e.time}`);return new Date(`${t.date}T${t.time}`).getTime()-a.getTime()})[0].intervalHours}:null,drugAdministrations:C.filter(e=>e.patientId===O.id&&e.drugName===D),steadyState:null==U?void 0:U.Steady_state,input_TOXI:void 0!==k?k:(null==U?void 0:U.input_TOXI)??0,tauBefore:(null==J?void 0:J.tau)||((null==R?void 0:R.frequency)?(()=>{const e=R.frequency,t=e.match(/(\d+(?:\.\d+)?)/);if(t){const a=parseFloat(t[1]);return e.includes("주")?24*a*7:a}return null})():null),amountBefore:(null==J?void 0:J.amount)||(null==R?void 0:R.dosage)||null,prescriptionAdditionalInfo:null==R?void 0:R.additionalInfo,renalReplacement:(()=>{try{if(!(null==O?void 0:O.id))return;const e=u(O.id,D);return null==e?void 0:e.renalReplacement}catch{return}})(),patientAge:null==O?void 0:O.age,currentCrCl:(()=>{try{if(!O)return;return c(O.id,O.weight,O.age,"male"===O.gender?1:0,O.height,D).crcl}catch{return}})(),crclHistory:(()=>{try{if(!(null==O?void 0:O.id))return[];const e=window.localStorage.getItem(`tdmfriends:renal:${O.id}`);if(!e)return[];const t=JSON.parse(e),a=[];for(const n of t){const e=(n.result||"").toString(),t=e.match(/(CRCL|eGFR)\s*=\s*([\d.]+)/i);if(t){const e=parseFloat(t[2]);!Number.isNaN(e)&&e>0&&a.push({value:e,date:new Date(n.date)})}else{const t=parseFloat(e.replace(/[^0-9.-]/g,""));!Number.isNaN(t)&&t>0&&a.push({value:t,date:new Date(n.date)})}}return a}catch{return[]}})()}):e.jsxs("div",{className:"text-center py-8 text-gray-500 dark:text-muted-foreground",children:[e.jsx("p",{children:"TDM 분석 결과 데이터가 없습니다."}),e.jsx("p",{className:"text-sm mt-2",children:"시뮬레이션을 먼저 실행해주세요."})]}):null})]})]})]}):e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx(l,{}),e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsx(t,{children:e.jsx(a,{className:"py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx(x,{className:"h-16 w-16 text-muted-foreground mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"환자 정보를 찾을 수 없습니다."}),e.jsxs("p",{className:"text-sm text-gray-500 dark:text-muted-foreground mt-2",children:["URL: ",window.location.href]}),e.jsxs("p",{className:"text-sm text-gray-500 dark:text-muted-foreground",children:["환자 수: ",y.length]})]})})})})]})};export{v as default};
