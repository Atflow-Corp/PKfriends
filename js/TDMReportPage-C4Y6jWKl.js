import{j as e,F as t}from"./index-BmEVsgjj.js";import{C as a,d as i,a as d,b as n,c as s}from"./card-CYPDPc_c.js";import{B as r}from"./button-BZ7ZGOfY.js";import{r as o}from"./react-vendor-B8CcSR15.js";import{H as l}from"./Header-CH2bwGYV.js";import{j as m,e as c,P as u,h as g,s as p,S as x,l as h,E as T}from"./html2canvas.esm-DBIr1B25.js";import{i as w,D as f}from"./ui-vendor-zUX6a0wC.js";const D=()=>{var D,v;const[j,N]=o.useState(null),[$,S]=o.useState(""),[I,b]=o.useState(""),[y,A]=o.useState([]),[M,C]=o.useState([]),[P,R]=o.useState([]),[U,H]=o.useState([]),[O,_]=o.useState(null),[J,B]=o.useState(null),[E,F]=o.useState(null);o.useEffect(()=>{(()=>{try{const t=(p.getJSON(x.patients,[])||[]).map(e=>({...e,createdAt:e.createdAt?new Date(e.createdAt):new Date}));A(t);const a=(p.getJSON(x.prescriptions,[])||[]).map(e=>({...e,startDate:e.startDate?new Date(e.startDate):new Date}));C(a);const i=(p.getJSON(x.bloodTests,[])||[]).map(e=>({...e,testDate:e.testDate?new Date(e.testDate):new Date}));R(i);const d=(p.getJSON(x.drugAdministrations,[])||[]).map(e=>({...e,date:e.date?new Date(e.date):new Date}));H(d);const n=new URLSearchParams(window.location.search).get("patientId");if(n&&t.length>0){const i=t.find(e=>e.id===n);i&&N(i);try{const t=window.localStorage.getItem(`tdmfriends:selectedDrug:${n}`);if(t){b(t);const i=a.find(e=>e.patientId===n&&e.drugName===t);i&&_(i);try{const e=window.localStorage.getItem(`tdmfriends:tdmResults:${n}:${t}`);if(e){const t=JSON.parse(e);B(t)}}catch(e){}try{const e=window.localStorage.getItem(`tdmfriends:tdmExtraSeries:${n}:${t}`);if(e){const t=JSON.parse(e);F(t)}}catch(e){}}}catch(e){}}}catch(e){}})(),S((new Date).toLocaleString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}))},[]);return j?e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx(l,{}),e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsx(a,{className:"mb-6",children:e.jsx(i,{className:"py-4",children:e.jsx("p",{className:"text-sm text-gray-600 text-center",children:"Report를 조회한 후 이 탭을 닫고 이전 창으로 복귀하면 계속해서 서비스를 이용하실 수 있습니다."})})}),e.jsx(a,{className:"mb-6",children:e.jsx(d,{children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsxs(n,{className:"text-xl",children:[j.name," 환자의 ",I," TDM 분석 보고서 - 분석일자: ",$]}),e.jsxs(s,{className:"mt-2",children:[j.name," 환자(",j.id,")의 Report를 조회하고 다운로드할 수 있습니다."]})]}),e.jsxs(r,{onClick:async()=>{try{const e=document.getElementById("report-content");if(!e)return void alert("보고서 내용을 찾을 수 없습니다.");const t=document.querySelector("[data-download-button]");t&&(t.disabled=!0,t.textContent="PDF 생성 중...");const a=await h(e,{scale:1.5,useCORS:!0,allowTaint:!0,backgroundColor:"#ffffff",logging:!1,width:e.scrollWidth,height:e.scrollHeight,scrollX:0,scrollY:0}),i=a.toDataURL("image/png",.95),d=new T({orientation:"portrait",unit:"mm",format:"a4"}),n=15,s=210-2*n,r=297-2*n,o=a.width,l=a.height,m=Math.min(s/o,r/l),c=o*m,u=l*m,g=r,p=Math.ceil(u/g);for(let h=0;h<p;h++){h>0&&d.addPage();const e=-h*g,t=h*g;Math.min(g,u-t);d.addImage(i,"PNG",n,n+e,c,u,void 0,"FAST")}const x=`${(null==j?void 0:j.name)||"환자"}_${I||"약품"}_TDM_분석보고서_${(new Date).toISOString().split("T")[0]}.pdf`;d.save(x),t&&(t.disabled=!1,t.textContent="Report Download")}catch(e){alert("PDF 생성 중 오류가 발생했습니다: "+e.message);const t=document.querySelector("[data-download-button]");t&&(t.disabled=!1,t.textContent="Report Download")}},className:"flex items-center gap-2","data-download-button":!0,children:[e.jsx(f,{className:"h-4 w-4"}),"Report Download"]})]})})}),e.jsxs(a,{className:"mb-6",id:"report-content",children:[e.jsx(d,{}),e.jsx(i,{children:e.jsx(m,{currentPatient:j,selectedPrescription:O,latestBloodTest:P.filter(e=>e.patientId===j.id&&e.drugName===I).sort((e,t)=>new Date(t.testDate).getTime()-new Date(e.testDate).getTime())[0]||null,drugAdministrations:U.filter(e=>e.patientId===j.id&&e.drugName===I),isExpanded:!0,onToggleExpanded:()=>{},disableHover:!0})}),e.jsx(i,{children:e.jsx(c,{selectedDrug:I,tdmIndication:null==O?void 0:O.indication,tdmTarget:null==O?void 0:O.tdmTarget,tdmTargetValue:null==O?void 0:O.tdmTargetValue,latestAdministration:U.filter(e=>e.patientId===j.id&&e.drugName===I).sort((e,t)=>new Date(`${e.date}T${e.time}`).getTime()-new Date(`${t.date}T${t.time}`).getTime()).slice(-1)[0]?{dose:U.filter(e=>e.patientId===j.id&&e.drugName===I).sort((e,t)=>new Date(`${e.date}T${e.time}`).getTime()-new Date(`${t.date}T${t.time}`).getTime()).slice(-1)[0].dose,unit:U.filter(e=>e.patientId===j.id&&e.drugName===I).sort((e,t)=>new Date(`${e.date}T${e.time}`).getTime()-new Date(`${t.date}T${t.time}`).getTime()).slice(-1)[0].unit,intervalHours:U.filter(e=>e.patientId===j.id&&e.drugName===I).sort((e,t)=>new Date(`${e.date}T${e.time}`).getTime()-new Date(`${t.date}T${t.time}`).getTime()).slice(-1)[0].intervalHours}:null,recentAUC:null==J?void 0:J.recentAUC,recentMax:null==J?void 0:J.recentMax,recentTrough:null==J?void 0:J.recentTrough,predictedAUC:null==J?void 0:J.predictedAUC,predictedMax:null==J?void 0:J.predictedMax,predictedTrough:null==J?void 0:J.predictedTrough,commentTitle:"TDM friends Comments",showSteadyStateComment:!0})}),e.jsx(i,{children:e.jsx(u,{showSimulation:!1,currentPatientName:null==j?void 0:j.name,selectedDrug:I,targetMin:null==J?void 0:J.targetMin,targetMax:null==J?void 0:J.targetMax,recentAUC:null==J?void 0:J.recentAUC,recentMax:null==J?void 0:J.recentMax,recentTrough:null==J?void 0:J.recentTrough,predictedAUC:null==J?void 0:J.predictedAUC,predictedMax:null==J?void 0:J.predictedMax,predictedTrough:null==J?void 0:J.predictedTrough,ipredSeries:null==E?void 0:E.ipredSeries,predSeries:null==E?void 0:E.predSeries,observedSeries:null==E?void 0:E.observedSeries,tdmIndication:null==O?void 0:O.indication,tdmTarget:null==O?void 0:O.tdmTarget,tdmTargetValue:null==O?void 0:O.tdmTargetValue,latestAdministration:U.filter(e=>e.patientId===j.id&&e.drugName===I).sort((e,t)=>new Date(`${e.date}T${e.time}`).getTime()-new Date(`${t.date}T${t.time}`).getTime()).slice(-1)[0]?{dose:U.filter(e=>e.patientId===j.id&&e.drugName===I).sort((e,t)=>new Date(`${e.date}T${e.time}`).getTime()-new Date(`${t.date}T${t.time}`).getTime()).slice(-1)[0].dose,unit:U.filter(e=>e.patientId===j.id&&e.drugName===I).sort((e,t)=>new Date(`${e.date}T${e.time}`).getTime()-new Date(`${t.date}T${t.time}`).getTime()).slice(-1)[0].unit,intervalHours:U.filter(e=>e.patientId===j.id&&e.drugName===I).sort((e,t)=>new Date(`${e.date}T${e.time}`).getTime()-new Date(`${t.date}T${t.time}`).getTime()).slice(-1)[0].intervalHours}:null,drugAdministrations:U.filter(e=>e.patientId===j.id&&e.drugName===I).map(e=>({id:e.id,patientId:e.patientId,drugName:e.drugName,date:e.date,time:e.time})),tauBefore:j&&I?null==(D=g({patients:y,prescriptions:M,bloodTests:P,drugAdministrations:U,selectedPatientId:j.id,selectedDrugName:I}))?void 0:D.input_tau_before:void 0,amountBefore:j&&I?null==(v=g({patients:y,prescriptions:M,bloodTests:P,drugAdministrations:U,selectedPatientId:j.id,selectedDrugName:I}))?void 0:v.input_amount_before:void 0})})]})]}),e.jsx(t,{})]}):e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx(l,{}),e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsx(a,{children:e.jsx(i,{className:"py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx(w,{className:"h-16 w-16 text-muted-foreground mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"환자 정보를 찾을 수 없습니다."}),e.jsxs("p",{className:"text-sm text-gray-500 mt-2",children:["URL: ",window.location.href]}),e.jsxs("p",{className:"text-sm text-gray-500",children:["환자 수: ",y.length]})]})})})}),e.jsx(t,{})]})};export{D as default};
