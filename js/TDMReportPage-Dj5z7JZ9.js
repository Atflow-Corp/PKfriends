import{j as e,F as t}from"./index-CxsksZ-V.js";import{C as a,d as i,a as d,b as n,c as s}from"./card-r-E7rfrn.js";import{B as r}from"./button-Cjc9qdBB.js";import{r as l}from"./react-vendor-B8CcSR15.js";import{H as o}from"./Header-BGFVPHiY.js";import{f as m,e as c,P as u,s as g,S as p,h as x,E as h}from"./html2canvas.esm-XJ6XzZc8.js";import{i as T,D as w}from"./ui-vendor-zUX6a0wC.js";const f=()=>{const[f,D]=l.useState(null),[v,j]=l.useState(""),[N,$]=l.useState(""),[S,I]=l.useState([]),[y,b]=l.useState([]),[M,A]=l.useState([]),[C,R]=l.useState([]),[U,P]=l.useState(null),[H,O]=l.useState(null),[J,E]=l.useState(null);l.useEffect(()=>{(()=>{try{const t=(g.getJSON(p.patients,[])||[]).map(e=>({...e,createdAt:e.createdAt?new Date(e.createdAt):new Date}));I(t);const a=(g.getJSON(p.prescriptions,[])||[]).map(e=>({...e,startDate:e.startDate?new Date(e.startDate):new Date}));b(a);const i=(g.getJSON(p.bloodTests,[])||[]).map(e=>({...e,testDate:e.testDate?new Date(e.testDate):new Date}));A(i);const d=(g.getJSON(p.drugAdministrations,[])||[]).map(e=>({...e,date:e.date?new Date(e.date):new Date}));R(d);const n=new URLSearchParams(window.location.search).get("patientId");if(n&&t.length>0){const i=t.find(e=>e.id===n);i&&D(i);try{const t=window.localStorage.getItem(`tdmfriends:selectedDrug:${n}`);if(t){$(t);const i=a.find(e=>e.patientId===n&&e.drugName===t);i&&P(i);try{const e=window.localStorage.getItem(`tdmfriends:tdmResults:${n}:${t}`);if(e){const t=JSON.parse(e);O(t)}}catch(e){}try{const e=window.localStorage.getItem(`tdmfriends:tdmExtraSeries:${n}:${t}`);if(e){const t=JSON.parse(e);E(t)}}catch(e){}}}catch(e){}}}catch(e){}})(),j((new Date).toLocaleString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}))},[]);return f?e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx(o,{}),e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsx(a,{className:"mb-6",children:e.jsx(i,{className:"py-4",children:e.jsx("p",{className:"text-sm text-gray-600 text-center",children:"Report를 조회한 후 이 탭을 닫고 이전 창으로 복귀하면 계속해서 서비스를 이용하실 수 있습니다."})})}),e.jsx(a,{className:"mb-6",children:e.jsx(d,{children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsxs(n,{className:"text-xl",children:[f.name," 환자의 ",N," TDM 분석 보고서 - 분석일자: ",v]}),e.jsxs(s,{className:"mt-2",children:[f.name," 환자(",f.id,")의 Report를 조회하고 다운로드할 수 있습니다."]})]}),e.jsxs(r,{onClick:async()=>{try{const e=document.getElementById("report-content");if(!e)return void alert("보고서 내용을 찾을 수 없습니다.");const t=document.querySelector("[data-download-button]");t&&(t.disabled=!0,t.textContent="PDF 생성 중...");const a=await x(e,{scale:1.5,useCORS:!0,allowTaint:!0,backgroundColor:"#ffffff",logging:!1,width:e.scrollWidth,height:e.scrollHeight,scrollX:0,scrollY:0}),i=a.toDataURL("image/png",.95),d=new h({orientation:"portrait",unit:"mm",format:"a4"}),n=15,s=210-2*n,r=297-2*n,l=a.width,o=a.height,m=Math.min(s/l,r/o),c=l*m,u=o*m,g=r,p=Math.ceil(u/g);for(let x=0;x<p;x++){x>0&&d.addPage();const e=-x*g,t=x*g;Math.min(g,u-t);d.addImage(i,"PNG",n,n+e,c,u,void 0,"FAST")}const T=`${(null==f?void 0:f.name)||"환자"}_${N||"약품"}_TDM_분석보고서_${(new Date).toISOString().split("T")[0]}.pdf`;d.save(T),t&&(t.disabled=!1,t.textContent="Report Download")}catch(e){alert("PDF 생성 중 오류가 발생했습니다: "+e.message);const t=document.querySelector("[data-download-button]");t&&(t.disabled=!1,t.textContent="Report Download")}},className:"flex items-center gap-2","data-download-button":!0,children:[e.jsx(w,{className:"h-4 w-4"}),"Report Download"]})]})})}),e.jsxs(a,{className:"mb-6",id:"report-content",children:[e.jsx(d,{}),e.jsx(i,{children:e.jsx(m,{currentPatient:f,selectedPrescription:U,latestBloodTest:M.filter(e=>e.patientId===f.id&&e.drugName===N).sort((e,t)=>new Date(t.testDate).getTime()-new Date(e.testDate).getTime())[0]||null,drugAdministrations:C.filter(e=>e.patientId===f.id&&e.drugName===N),isExpanded:!0,onToggleExpanded:()=>{},disableHover:!0})}),e.jsx(i,{children:e.jsx(c,{selectedDrug:N,tdmIndication:null==U?void 0:U.indication,tdmTarget:null==U?void 0:U.tdmTarget,tdmTargetValue:null==U?void 0:U.tdmTargetValue,latestAdministration:C.filter(e=>e.patientId===f.id&&e.drugName===N).sort((e,t)=>new Date(`${e.date}T${e.time}`).getTime()-new Date(`${t.date}T${t.time}`).getTime()).slice(-1)[0]?{dose:C.filter(e=>e.patientId===f.id&&e.drugName===N).sort((e,t)=>new Date(`${e.date}T${e.time}`).getTime()-new Date(`${t.date}T${t.time}`).getTime()).slice(-1)[0].dose,unit:C.filter(e=>e.patientId===f.id&&e.drugName===N).sort((e,t)=>new Date(`${e.date}T${e.time}`).getTime()-new Date(`${t.date}T${t.time}`).getTime()).slice(-1)[0].unit,intervalHours:C.filter(e=>e.patientId===f.id&&e.drugName===N).sort((e,t)=>new Date(`${e.date}T${e.time}`).getTime()-new Date(`${t.date}T${t.time}`).getTime()).slice(-1)[0].intervalHours}:null,recentAUC:null==H?void 0:H.recentAUC,recentMax:null==H?void 0:H.recentMax,recentTrough:null==H?void 0:H.recentTrough,predictedAUC:null==H?void 0:H.predictedAUC,predictedMax:null==H?void 0:H.predictedMax,predictedTrough:null==H?void 0:H.predictedTrough,commentTitle:"TDM friends Comments",showSteadyStateComment:!0})}),e.jsx(i,{children:e.jsx(u,{showSimulation:!1,currentPatientName:null==f?void 0:f.name,selectedDrug:N,targetMin:null==H?void 0:H.targetMin,targetMax:null==H?void 0:H.targetMax,recentAUC:null==H?void 0:H.recentAUC,recentMax:null==H?void 0:H.recentMax,recentTrough:null==H?void 0:H.recentTrough,predictedAUC:null==H?void 0:H.predictedAUC,predictedMax:null==H?void 0:H.predictedMax,predictedTrough:null==H?void 0:H.predictedTrough,ipredSeries:null==J?void 0:J.ipredSeries,predSeries:null==J?void 0:J.predSeries,observedSeries:null==J?void 0:J.observedSeries,tdmIndication:null==U?void 0:U.indication,tdmTarget:null==U?void 0:U.tdmTarget,tdmTargetValue:null==U?void 0:U.tdmTargetValue,latestAdministration:C.filter(e=>e.patientId===f.id&&e.drugName===N).sort((e,t)=>new Date(`${e.date}T${e.time}`).getTime()-new Date(`${t.date}T${t.time}`).getTime()).slice(-1)[0]?{dose:C.filter(e=>e.patientId===f.id&&e.drugName===N).sort((e,t)=>new Date(`${e.date}T${e.time}`).getTime()-new Date(`${t.date}T${t.time}`).getTime()).slice(-1)[0].dose,unit:C.filter(e=>e.patientId===f.id&&e.drugName===N).sort((e,t)=>new Date(`${e.date}T${e.time}`).getTime()-new Date(`${t.date}T${t.time}`).getTime()).slice(-1)[0].unit,intervalHours:C.filter(e=>e.patientId===f.id&&e.drugName===N).sort((e,t)=>new Date(`${e.date}T${e.time}`).getTime()-new Date(`${t.date}T${t.time}`).getTime()).slice(-1)[0].intervalHours}:null,drugAdministrations:C.filter(e=>e.patientId===f.id&&e.drugName===N).map(e=>({id:e.id,patientId:e.patientId,drugName:e.drugName,date:e.date,time:e.time}))})})]})]}),e.jsx(t,{})]}):e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx(o,{}),e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsx(a,{children:e.jsx(i,{className:"py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx(T,{className:"h-16 w-16 text-muted-foreground mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"환자 정보를 찾을 수 없습니다."}),e.jsxs("p",{className:"text-sm text-gray-500 mt-2",children:["URL: ",window.location.href]}),e.jsxs("p",{className:"text-sm text-gray-500",children:["환자 수: ",S.length]})]})})})}),e.jsx(t,{})]})};export{f as default};
