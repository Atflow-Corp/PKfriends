import{j as e,c as t,u as n,a as r,b as i,P as s,d as a,e as o,f as l,g as d,h as c,i as u,A as m,D as f,C as p,k as g,l as h,S as x,m as v,R as b,n as j,o as N}from"./index-EDVtieIG.js";import{r as y,c as w,g as D}from"./react-vendor-B8CcSR15.js";import{u as T,a as S,O as k,C,b as I,T as M,D as R,R as $,c as _,P as E,L as P,S as A,d as O,e as F,f as L,g as V,A as H,h as U,i as K,j as z,k as B,l as W,m as G,n as J,o as q,p as Y,F as X,q as Z}from"./alert-dialog-CgHMtLnq.js";import{C as Q,a as ee,b as te,c as ne,d as re}from"./card-CXWF4oCX.js";import{B as ie}from"./button-FgDF5wvu.js";import{I as se}from"./input-C_mfmqvu.js";import{X as ae,U as oe,T as le,E as de,F as ce,S as ue,C as me,b as fe,d as pe,A as ge,e as he,P as xe,f as ve,g as be,h as je,i as Ne,j as ye,H as we,k as De,l as Te}from"./ui-vendor-DIKnhjRf.js";import{g as Se,s as ke,S as Ce,m as Ie,c as Me,a as Re,b as $e,d as _e,i as Ee,T as Pe,e as Ae,f as Oe,P as Fe,h as Le,E as Ve}from"./html2canvas.esm-CwjFvrQT.js";import{u as He}from"./index-CtqvmGU1.js";function Ue(...e){const t=e[0];if(1===e.length)return t;const n=()=>{const n=e.map(e=>({useScope:e(),scopeName:e.scopeName}));return function(e){const r=n.reduce((t,{useScope:n,scopeName:r})=>({...t,...n(e)[`__scope${r}`]}),{});return y.useMemo(()=>({[`__scope${t.scopeName}`]:r}),[r])}};return n.scopeName=t.scopeName,n}var Ke="rovingFocusGroup.onEntryFocus",ze={bubbles:!1,cancelable:!0},Be="RovingFocusGroup",[We,Ge,Je]=t(Be),[qe,Ye]=function(t,n=[]){let r=[];const i=()=>{const e=r.map(e=>y.createContext(e));return function(n){const r=(null==n?void 0:n[t])||e;return y.useMemo(()=>({[`__scope${t}`]:{...n,[t]:r}}),[n,r])}};return i.scopeName=t,[function(n,i){const s=y.createContext(i),a=r.length;function o(n){const{scope:r,children:i,...o}=n,l=(null==r?void 0:r[t][a])||s,d=y.useMemo(()=>o,Object.values(o));return e.jsx(l.Provider,{value:d,children:i})}return r=[...r,i],o.displayName=n+"Provider",[o,function(e,r){const o=(null==r?void 0:r[t][a])||s,l=y.useContext(o);if(l)return l;if(void 0!==i)return i;throw new Error(`\`${e}\` must be used within \`${n}\``)}]},Ue(i,...n)]}(Be,[Je]),[Xe,Ze]=qe(Be),Qe=y.forwardRef((t,n)=>e.jsx(We.Provider,{scope:t.__scopeRovingFocusGroup,children:e.jsx(We.Slot,{scope:t.__scopeRovingFocusGroup,children:e.jsx(et,{...t,ref:n})})}));Qe.displayName=Be;var et=y.forwardRef((t,o)=>{const{__scopeRovingFocusGroup:l,orientation:d,loop:c=!1,dir:u,currentTabStopId:m,defaultCurrentTabStopId:f,onCurrentTabStopIdChange:p,onEntryFocus:g,preventScrollOnEntryFocus:h=!1,...x}=t,v=y.useRef(null),b=n(o,v),j=T(u),[N=null,w]=r({prop:m,defaultProp:f,onChange:p}),[D,S]=y.useState(!1),k=i(g),C=Ge(l),I=y.useRef(!1),[M,R]=y.useState(0);return y.useEffect(()=>{const e=v.current;if(e)return e.addEventListener(Ke,k),()=>e.removeEventListener(Ke,k)},[k]),e.jsx(Xe,{scope:l,orientation:d,dir:j,loop:c,currentTabStopId:N,onItemFocus:y.useCallback(e=>w(e),[w]),onItemShiftTab:y.useCallback(()=>S(!0),[]),onFocusableItemAdd:y.useCallback(()=>R(e=>e+1),[]),onFocusableItemRemove:y.useCallback(()=>R(e=>e-1),[]),children:e.jsx(s.div,{tabIndex:D||0===M?-1:0,"data-orientation":d,...x,ref:b,style:{outline:"none",...t.style},onMouseDown:a(t.onMouseDown,()=>{I.current=!0}),onFocus:a(t.onFocus,e=>{const t=!I.current;if(e.target===e.currentTarget&&t&&!D){const t=new CustomEvent(Ke,ze);if(e.currentTarget.dispatchEvent(t),!t.defaultPrevented){const e=C().filter(e=>e.focusable);it([e.find(e=>e.active),e.find(e=>e.id===N),...e].filter(Boolean).map(e=>e.ref.current),h)}}I.current=!1}),onBlur:a(t.onBlur,()=>S(!1))})})}),tt="RovingFocusGroupItem",nt=y.forwardRef((t,n)=>{const{__scopeRovingFocusGroup:r,focusable:i=!0,active:o=!1,tabStopId:l,...d}=t,c=S(),u=l||c,m=Ze(tt,r),f=m.currentTabStopId===u,p=Ge(r),{onFocusableItemAdd:g,onFocusableItemRemove:h}=m;return y.useEffect(()=>{if(i)return g(),()=>h()},[i,g,h]),e.jsx(We.ItemSlot,{scope:r,id:u,focusable:i,active:o,children:e.jsx(s.span,{tabIndex:f?0:-1,"data-orientation":m.orientation,...d,ref:n,onMouseDown:a(t.onMouseDown,e=>{i?m.onItemFocus(u):e.preventDefault()}),onFocus:a(t.onFocus,()=>m.onItemFocus(u)),onKeyDown:a(t.onKeyDown,e=>{if("Tab"===e.key&&e.shiftKey)return void m.onItemShiftTab();if(e.target!==e.currentTarget)return;const t=function(e,t,n){const r=function(e,t){return"rtl"!==t?e:"ArrowLeft"===e?"ArrowRight":"ArrowRight"===e?"ArrowLeft":e}(e.key,n);return"vertical"===t&&["ArrowLeft","ArrowRight"].includes(r)||"horizontal"===t&&["ArrowUp","ArrowDown"].includes(r)?void 0:rt[r]}(e,m.orientation,m.dir);if(void 0!==t){if(e.metaKey||e.ctrlKey||e.altKey||e.shiftKey)return;e.preventDefault();let i=p().filter(e=>e.focusable).map(e=>e.ref.current);if("last"===t)i.reverse();else if("prev"===t||"next"===t){"prev"===t&&i.reverse();const s=i.indexOf(e.currentTarget);i=m.loop?(r=s+1,(n=i).map((e,t)=>n[(r+t)%n.length])):i.slice(s+1)}setTimeout(()=>it(i))}var n,r})})})});nt.displayName=tt;var rt={ArrowLeft:"prev",ArrowUp:"prev",ArrowRight:"next",ArrowDown:"next",PageUp:"first",Home:"first",PageDown:"last",End:"last"};function it(e,t=!1){const n=document.activeElement;for(const r of e){if(r===n)return;if(r.focus({preventScroll:t}),document.activeElement!==n)return}}var st=Qe,at=nt,ot="Tabs",[lt,dt]=o(ot,[Ye]),ct=Ye(),[ut,mt]=lt(ot),ft=y.forwardRef((t,n)=>{const{__scopeTabs:i,value:a,onValueChange:o,defaultValue:l,orientation:d="horizontal",dir:c,activationMode:u="automatic",...m}=t,f=T(c),[p,g]=r({prop:a,onChange:o,defaultProp:l});return e.jsx(ut,{scope:i,baseId:S(),value:p,onValueChange:g,orientation:d,dir:f,activationMode:u,children:e.jsx(s.div,{dir:f,"data-orientation":d,...m,ref:n})})});ft.displayName=ot;var pt="TabsList",gt=y.forwardRef((t,n)=>{const{__scopeTabs:r,loop:i=!0,...a}=t,o=mt(pt,r),l=ct(r);return e.jsx(st,{asChild:!0,...l,orientation:o.orientation,dir:o.dir,loop:i,children:e.jsx(s.div,{role:"tablist","aria-orientation":o.orientation,...a,ref:n})})});gt.displayName=pt;var ht="TabsTrigger",xt=y.forwardRef((t,n)=>{const{__scopeTabs:r,value:i,disabled:o=!1,...l}=t,d=mt(ht,r),c=ct(r),u=jt(d.baseId,i),m=Nt(d.baseId,i),f=i===d.value;return e.jsx(at,{asChild:!0,...c,focusable:!o,active:f,children:e.jsx(s.button,{type:"button",role:"tab","aria-selected":f,"aria-controls":m,"data-state":f?"active":"inactive","data-disabled":o?"":void 0,disabled:o,id:u,...l,ref:n,onMouseDown:a(t.onMouseDown,e=>{o||0!==e.button||!1!==e.ctrlKey?e.preventDefault():d.onValueChange(i)}),onKeyDown:a(t.onKeyDown,e=>{[" ","Enter"].includes(e.key)&&d.onValueChange(i)}),onFocus:a(t.onFocus,()=>{const e="manual"!==d.activationMode;f||o||!e||d.onValueChange(i)})})})});xt.displayName=ht;var vt="TabsContent",bt=y.forwardRef((t,n)=>{const{__scopeTabs:r,value:i,forceMount:a,children:o,...d}=t,c=mt(vt,r),u=jt(c.baseId,i),m=Nt(c.baseId,i),f=i===c.value,p=y.useRef(f);return y.useEffect(()=>{const e=requestAnimationFrame(()=>p.current=!1);return()=>cancelAnimationFrame(e)},[]),e.jsx(l,{present:a||f,children:({present:r})=>e.jsx(s.div,{"data-state":f?"active":"inactive","data-orientation":c.orientation,role:"tabpanel","aria-labelledby":u,hidden:!r,id:m,tabIndex:0,...d,ref:n,style:{...t.style,animationDuration:p.current?"0s":void 0},children:r&&o})})});function jt(e,t){return`${e}-trigger-${t}`}function Nt(e,t){return`${e}-content-${t}`}bt.displayName=vt;var yt=gt,wt=xt,Dt=bt;const Tt=ft,St=y.forwardRef(({className:t,...n},r)=>e.jsx(yt,{ref:r,className:d("inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",t),...n}));St.displayName=yt.displayName;const kt=y.forwardRef(({className:t,...n},r)=>e.jsx(wt,{ref:r,className:d("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm","data-[state=active]:bg-primary/90 data-[state=active]:text-white data-[state=active]:shadow-lg data-[state=active]:border data-[state=active]:border-primary dark:data-[state=active]:bg-primary/80 dark:data-[state=active]:text-primary-foreground dark:data-[state=active]:border-primary",t),...n}));kt.displayName=wt.displayName;const Ct=y.forwardRef(({className:t,...n},r)=>e.jsx(Dt,{ref:r,className:d("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",t),...n}));Ct.displayName=Dt.displayName;const It=y.forwardRef(({className:t,...n},r)=>e.jsx("div",{className:"relative w-full overflow-auto",children:e.jsx("table",{ref:r,className:d("w-full caption-bottom text-sm",t),...n})}));It.displayName="Table";const Mt=y.forwardRef(({className:t,...n},r)=>e.jsx("thead",{ref:r,className:d("[&_tr]:border-b",t),...n}));Mt.displayName="TableHeader";const Rt=y.forwardRef(({className:t,...n},r)=>e.jsx("tbody",{ref:r,className:d("[&_tr:last-child]:border-0",t),...n}));Rt.displayName="TableBody";y.forwardRef(({className:t,...n},r)=>e.jsx("tfoot",{ref:r,className:d("border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",t),...n})).displayName="TableFooter";const $t=y.forwardRef(({className:t,...n},r)=>e.jsx("tr",{ref:r,className:d("border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",t),...n}));$t.displayName="TableRow";const _t=y.forwardRef(({className:t,...n},r)=>e.jsx("th",{ref:r,className:d("h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",t),...n}));_t.displayName="TableHead";const Et=y.forwardRef(({className:t,...n},r)=>e.jsx("td",{ref:r,className:d("p-4 align-middle [&:has([role=checkbox])]:pr-0",t),...n}));Et.displayName="TableCell";y.forwardRef(({className:t,...n},r)=>e.jsx("caption",{ref:r,className:d("mt-4 text-sm text-muted-foreground",t),...n})).displayName="TableCaption";const Pt=$,At=_,Ot=E,Ft=y.forwardRef(({className:t,...n},r)=>e.jsx(k,{ref:r,className:d("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",t),...n}));Ft.displayName=k.displayName;const Lt=y.forwardRef(({className:t,children:n,...r},i)=>e.jsxs(Ot,{children:[e.jsx(Ft,{}),e.jsxs(C,{ref:i,className:d("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",t),onOpenAutoFocus:e=>{e.preventDefault();const t=e.currentTarget.querySelector('button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"]):not([disabled])');t&&t.focus()},...r,children:[n,e.jsxs(I,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[e.jsx(ae,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Close"})]})]})]}));Lt.displayName=C.displayName;const Vt=({className:t,...n})=>e.jsx("div",{className:d("flex flex-col space-y-1.5 text-center sm:text-left",t),...n});Vt.displayName="DialogHeader";const Ht=({className:t,...n})=>e.jsx("div",{className:d("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",t),...n});Ht.displayName="DialogFooter";const Ut=y.forwardRef(({className:t,...n},r)=>e.jsx(M,{ref:r,className:d("text-lg font-semibold leading-none tracking-tight",t),...n}));Ut.displayName=M.displayName;const Kt=y.forwardRef(({className:t,...n},r)=>e.jsx(R,{ref:r,className:d("text-sm text-muted-foreground",t),...n}));Kt.displayName=R.displayName;var zt={exports:{}};const Bt=D(zt.exports=function(){var e=1e3,t=6e4,n=36e5,r="millisecond",i="second",s="minute",a="hour",o="day",l="week",d="month",c="quarter",u="year",m="date",f="Invalid Date",p=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,g=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,h={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(e){var t=["th","st","nd","rd"],n=e%100;return"["+e+(t[(n-20)%10]||t[n]||t[0])+"]"}},x=function(e,t,n){var r=String(e);return!r||r.length>=t?e:""+Array(t+1-r.length).join(n)+e},v={s:x,z:function(e){var t=-e.utcOffset(),n=Math.abs(t),r=Math.floor(n/60),i=n%60;return(t<=0?"+":"-")+x(r,2,"0")+":"+x(i,2,"0")},m:function e(t,n){if(t.date()<n.date())return-e(n,t);var r=12*(n.year()-t.year())+(n.month()-t.month()),i=t.clone().add(r,d),s=n-i<0,a=t.clone().add(r+(s?-1:1),d);return+(-(r+(n-i)/(s?i-a:a-i))||0)},a:function(e){return e<0?Math.ceil(e)||0:Math.floor(e)},p:function(e){return{M:d,y:u,w:l,d:o,D:m,h:a,m:s,s:i,ms:r,Q:c}[e]||String(e||"").toLowerCase().replace(/s$/,"")},u:function(e){return void 0===e}},b="en",j={};j[b]=h;var N="$isDayjsObject",y=function(e){return e instanceof S||!(!e||!e[N])},w=function e(t,n,r){var i;if(!t)return b;if("string"==typeof t){var s=t.toLowerCase();j[s]&&(i=s),n&&(j[s]=n,i=s);var a=t.split("-");if(!i&&a.length>1)return e(a[0])}else{var o=t.name;j[o]=t,i=o}return!r&&i&&(b=i),i||!r&&b},D=function(e,t){if(y(e))return e.clone();var n="object"==typeof t?t:{};return n.date=e,n.args=arguments,new S(n)},T=v;T.l=w,T.i=y,T.w=function(e,t){return D(e,{locale:t.$L,utc:t.$u,x:t.$x,$offset:t.$offset})};var S=function(){function h(e){this.$L=w(e.locale,null,!0),this.parse(e),this.$x=this.$x||e.x||{},this[N]=!0}var x=h.prototype;return x.parse=function(e){this.$d=function(e){var t=e.date,n=e.utc;if(null===t)return new Date(NaN);if(T.u(t))return new Date;if(t instanceof Date)return new Date(t);if("string"==typeof t&&!/Z$/i.test(t)){var r=t.match(p);if(r){var i=r[2]-1||0,s=(r[7]||"0").substring(0,3);return n?new Date(Date.UTC(r[1],i,r[3]||1,r[4]||0,r[5]||0,r[6]||0,s)):new Date(r[1],i,r[3]||1,r[4]||0,r[5]||0,r[6]||0,s)}}return new Date(t)}(e),this.init()},x.init=function(){var e=this.$d;this.$y=e.getFullYear(),this.$M=e.getMonth(),this.$D=e.getDate(),this.$W=e.getDay(),this.$H=e.getHours(),this.$m=e.getMinutes(),this.$s=e.getSeconds(),this.$ms=e.getMilliseconds()},x.$utils=function(){return T},x.isValid=function(){return!(this.$d.toString()===f)},x.isSame=function(e,t){var n=D(e);return this.startOf(t)<=n&&n<=this.endOf(t)},x.isAfter=function(e,t){return D(e)<this.startOf(t)},x.isBefore=function(e,t){return this.endOf(t)<D(e)},x.$g=function(e,t,n){return T.u(e)?this[t]:this.set(n,e)},x.unix=function(){return Math.floor(this.valueOf()/1e3)},x.valueOf=function(){return this.$d.getTime()},x.startOf=function(e,t){var n=this,r=!!T.u(t)||t,c=T.p(e),f=function(e,t){var i=T.w(n.$u?Date.UTC(n.$y,t,e):new Date(n.$y,t,e),n);return r?i:i.endOf(o)},p=function(e,t){return T.w(n.toDate()[e].apply(n.toDate("s"),(r?[0,0,0,0]:[23,59,59,999]).slice(t)),n)},g=this.$W,h=this.$M,x=this.$D,v="set"+(this.$u?"UTC":"");switch(c){case u:return r?f(1,0):f(31,11);case d:return r?f(1,h):f(0,h+1);case l:var b=this.$locale().weekStart||0,j=(g<b?g+7:g)-b;return f(r?x-j:x+(6-j),h);case o:case m:return p(v+"Hours",0);case a:return p(v+"Minutes",1);case s:return p(v+"Seconds",2);case i:return p(v+"Milliseconds",3);default:return this.clone()}},x.endOf=function(e){return this.startOf(e,!1)},x.$set=function(e,t){var n,l=T.p(e),c="set"+(this.$u?"UTC":""),f=(n={},n[o]=c+"Date",n[m]=c+"Date",n[d]=c+"Month",n[u]=c+"FullYear",n[a]=c+"Hours",n[s]=c+"Minutes",n[i]=c+"Seconds",n[r]=c+"Milliseconds",n)[l],p=l===o?this.$D+(t-this.$W):t;if(l===d||l===u){var g=this.clone().set(m,1);g.$d[f](p),g.init(),this.$d=g.set(m,Math.min(this.$D,g.daysInMonth())).$d}else f&&this.$d[f](p);return this.init(),this},x.set=function(e,t){return this.clone().$set(e,t)},x.get=function(e){return this[T.p(e)]()},x.add=function(r,c){var m,f=this;r=Number(r);var p=T.p(c),g=function(e){var t=D(f);return T.w(t.date(t.date()+Math.round(e*r)),f)};if(p===d)return this.set(d,this.$M+r);if(p===u)return this.set(u,this.$y+r);if(p===o)return g(1);if(p===l)return g(7);var h=(m={},m[s]=t,m[a]=n,m[i]=e,m)[p]||1,x=this.$d.getTime()+r*h;return T.w(x,this)},x.subtract=function(e,t){return this.add(-1*e,t)},x.format=function(e){var t=this,n=this.$locale();if(!this.isValid())return n.invalidDate||f;var r=e||"YYYY-MM-DDTHH:mm:ssZ",i=T.z(this),s=this.$H,a=this.$m,o=this.$M,l=n.weekdays,d=n.months,c=n.meridiem,u=function(e,n,i,s){return e&&(e[n]||e(t,r))||i[n].slice(0,s)},m=function(e){return T.s(s%12||12,e,"0")},p=c||function(e,t,n){var r=e<12?"AM":"PM";return n?r.toLowerCase():r};return r.replace(g,function(e,r){return r||function(e){switch(e){case"YY":return String(t.$y).slice(-2);case"YYYY":return T.s(t.$y,4,"0");case"M":return o+1;case"MM":return T.s(o+1,2,"0");case"MMM":return u(n.monthsShort,o,d,3);case"MMMM":return u(d,o);case"D":return t.$D;case"DD":return T.s(t.$D,2,"0");case"d":return String(t.$W);case"dd":return u(n.weekdaysMin,t.$W,l,2);case"ddd":return u(n.weekdaysShort,t.$W,l,3);case"dddd":return l[t.$W];case"H":return String(s);case"HH":return T.s(s,2,"0");case"h":return m(1);case"hh":return m(2);case"a":return p(s,a,!0);case"A":return p(s,a,!1);case"m":return String(a);case"mm":return T.s(a,2,"0");case"s":return String(t.$s);case"ss":return T.s(t.$s,2,"0");case"SSS":return T.s(t.$ms,3,"0");case"Z":return i}return null}(e)||i.replace(":","")})},x.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},x.diff=function(r,m,f){var p,g=this,h=T.p(m),x=D(r),v=(x.utcOffset()-this.utcOffset())*t,b=this-x,j=function(){return T.m(g,x)};switch(h){case u:p=j()/12;break;case d:p=j();break;case c:p=j()/3;break;case l:p=(b-v)/6048e5;break;case o:p=(b-v)/864e5;break;case a:p=b/n;break;case s:p=b/t;break;case i:p=b/e;break;default:p=b}return f?p:T.a(p)},x.daysInMonth=function(){return this.endOf(d).$D},x.$locale=function(){return j[this.$L]},x.locale=function(e,t){if(!e)return this.$L;var n=this.clone(),r=w(e,t,!0);return r&&(n.$L=r),n},x.clone=function(){return T.w(this.$d,this)},x.toDate=function(){return new Date(this.valueOf())},x.toJSON=function(){return this.isValid()?this.toISOString():null},x.toISOString=function(){return this.$d.toISOString()},x.toString=function(){return this.$d.toUTCString()},h}(),k=S.prototype;return D.prototype=k,[["$ms",r],["$s",i],["$m",s],["$H",a],["$W",o],["$M",d],["$y",u],["$D",m]].forEach(function(e){k[e[1]]=function(t){return this.$g(t,e[0],e[1])}}),D.extend=function(e,t){return e.$i||(e(t,S,D),e.$i=!0),D},D.locale=w,D.isDayjs=y,D.unix=function(e){return D(1e3*e)},D.en=j[b],D.Ls=j,D.p={},D}()),Wt=y.forwardRef(({onAddPatient:t,onUpdatePatient:n,onDeletePatient:r,patients:i,selectedPatient:s,setSelectedPatient:a,showHeader:o=!0},l)=>{const[d,c]=y.useState({patientNo:"",name:"",gender:"",birth:"",age:"",weight:"",height:"",medicalHistory:"",allergies:""}),u=Bt().format("YYYY-MM-DD"),[m,f]=y.useState(!1),[p,g]=y.useState(!1),[h,x]=y.useState(!1),[v,b]=y.useState(null),[j,N]=y.useState(""),[w,D]=y.useState([]),[T,S]=y.useState(null),k=e=>{c({patientNo:e.id,name:e.name,gender:e.gender,birth:e.birthDate,age:e.age.toString(),weight:e.weight.toString(),height:e.height.toString(),medicalHistory:e.medicalHistory,allergies:e.allergies}),a(e),f(!0),g(!0)},C=e=>{b(e),(e=>{try{const t=ke.getJSON(Ce.prescriptions,[]).filter(t=>t.patientId===e).sort((e,t)=>{const n=new Date(e.startDate||e.id);return new Date(t.startDate||t.id).getTime()-n.getTime()});D(t)}catch(t){D([])}})(e.id),x(!0)},I=()=>{c({patientNo:"",name:"",gender:"",birth:"",age:"",weight:"",height:"",medicalHistory:"",allergies:""}),f(!1),a(null),g(!1)},M=()=>{c({patientNo:"",name:"",gender:"",birth:"",age:"",weight:"",height:"",medicalHistory:"",allergies:""}),f(!1),a(null),g(!0)},R=e=>{k(e)},$=e=>{C(e)},_=i.filter(e=>e.name.toLowerCase().includes(j.toLowerCase())||e.id.includes(j));return y.useImperativeHandle(l,()=>({openRegistrationModal:M,openEditModalForPatient:R,openViewModalForPatient:$})),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[o&&e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold",children:"환자 정보 관리"}),e.jsx("p",{className:"text-muted-foreground",children:"환자 등록, 수정, 조회를 관리합니다"})]}),!o&&e.jsx("div",{}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(Pt,{open:p,onOpenChange:g,children:[e.jsx(At,{asChild:!0,children:e.jsxs(ie,{onClick:()=>{c({patientNo:"",name:"",gender:"",birth:"",age:"",weight:"",height:"",medicalHistory:"",allergies:""}),f(!1),a(null),g(!0)},className:"flex items-center gap-2",children:[e.jsx(oe,{className:"h-4 w-4"}),"신규 환자 등록"]})}),e.jsxs(Lt,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(Vt,{children:[e.jsxs(Ut,{className:"flex items-center gap-2",children:[e.jsx(oe,{className:"h-5 w-5"}),m?"환자 정보 수정":"신규 환자 등록"]}),e.jsx(Kt,{children:m?"환자 정보를 수정합니다":"환자 정보를 입력해 등록하세요"})]}),e.jsxs("form",{onSubmit:m?e=>{if(e.preventDefault(),!s)return;const t={...s,name:d.name,age:parseInt(d.age),weight:parseFloat(d.weight),height:parseFloat(d.height),gender:d.gender,medicalHistory:d.medicalHistory,allergies:d.allergies};n(t),I(),g(!1)}:e=>{e.preventDefault();const n={id:Date.now().toString(),name:d.name,age:parseInt(d.age),weight:parseFloat(d.weight),height:parseFloat(d.height),gender:d.gender,medicalHistory:d.medicalHistory,allergies:d.allergies,birthDate:d.birth,createdAt:new Date};t(n),I(),g(!1)},className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(P,{htmlFor:"patientNo",children:"환자 번호 *"}),e.jsx(se,{id:"patientNo",value:d.patientNo,onChange:e=>c({...d,patientNo:e.target.value}),placeholder:"환자 번호 입력",required:!0})]}),e.jsxs("div",{children:[e.jsx(P,{htmlFor:"name",children:"이름 *"}),e.jsx(se,{id:"name",value:d.name,onChange:e=>c({...d,name:e.target.value}),placeholder:"이름 입력",required:!0})]}),e.jsxs("div",{children:[e.jsx(P,{htmlFor:"gender",children:"성별 *"}),e.jsxs(A,{value:d.gender,onValueChange:e=>c({...d,gender:e}),required:!0,children:[e.jsx(O,{children:e.jsx(F,{placeholder:"성별 선택"})}),e.jsxs(L,{children:[e.jsx(V,{value:"male",children:"남성"}),e.jsx(V,{value:"female",children:"여성"}),e.jsx(V,{value:"other",children:"기타"})]})]})]}),e.jsxs("div",{children:[e.jsx(P,{htmlFor:"birth",children:"생년월일 *"}),e.jsx(se,{id:"birth",type:"date",value:d.birth,max:u,onChange:e=>{return t=e.target.value,void c(e=>{const n=t,r=n?Bt(n):null;return{...e,birth:n,age:(null==r?void 0:r.isValid())?Bt().diff(r,"year").toString():""}});var t},required:!0})]}),e.jsxs("div",{children:[e.jsx(P,{htmlFor:"weight",children:"체중(kg) *"}),e.jsx(se,{id:"weight",type:"number",step:"0.1",value:d.weight,onChange:e=>c({...d,weight:e.target.value}),placeholder:"체중(kg)",min:"0",required:!0})]}),e.jsxs("div",{children:[e.jsx(P,{htmlFor:"height",children:"신장(cm) *"}),e.jsx(se,{id:"height",type:"number",value:d.height,onChange:e=>c({...d,height:e.target.value}),placeholder:"신장(cm)",min:"0",required:!0})]}),e.jsxs("div",{children:[e.jsx(P,{htmlFor:"age",children:"나이"}),e.jsx(se,{id:"age",value:d.age,readOnly:!0,placeholder:"생년월일 입력 시 자동 계산"})]}),e.jsxs("div",{children:[e.jsx(P,{children:"BMI"}),e.jsx(se,{value:(()=>{const e=parseFloat(d.weight),t=parseFloat(d.height);return e&&t?(e/Math.pow(t/100,2)).toFixed(1):""})(),readOnly:!0,placeholder:"자동 계산"})]}),e.jsxs("div",{children:[e.jsx(P,{children:"BSA"}),e.jsx(se,{value:(()=>{const e=parseFloat(d.weight),t=parseFloat(d.height);return e&&t?Math.sqrt(e*t/3600).toFixed(2):""})(),readOnly:!0,placeholder:"자동 계산"})]})]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[m&&e.jsx(ie,{type:"button",variant:"destructive",onClick:()=>{s&&(r(s.id),I(),g(!1))},className:"w-fit p-2",children:e.jsx(le,{className:"h-4 w-4"})}),e.jsx(ie,{type:"submit",className:"flex-1",children:m?"수정하기":"등록하기"}),e.jsx(ie,{type:"button",variant:"outline",onClick:I,children:"취소"})]})]})]})]})})]}),e.jsx(Pt,{open:h,onOpenChange:x,children:e.jsxs(Lt,{className:"min-w-[1000px] min-h-[500px] max-h-[80vh] p-0",children:[e.jsxs(Vt,{className:"px-6 pt-6 pb-0",children:[e.jsxs(Ut,{children:[null==v?void 0:v.name," 환자의 Report 조회"]}),e.jsx(Kt,{children:"TDM 분석 내역을 선택하면 해당 분석의 Report를 조회하고 다운로드할 수 있습니다."})]}),v&&e.jsx("div",{className:"px-6 pb-6",children:w.length>0?e.jsx("div",{className:"rounded-md border",children:e.jsxs(It,{children:[e.jsx(Mt,{children:e.jsxs($t,{children:[e.jsx(_t,{className:"w-[120px]",children:"분석일"}),e.jsx(_t,{className:"w-[150px]",children:"약물명"}),e.jsx(_t,{className:"w-[200px]",children:"적응증"}),e.jsx(_t,{className:"w-[250px]",children:"TDM 목표"}),e.jsx(_t,{className:"w-[120px]",children:"항정상태"}),e.jsx(_t,{className:"w-[100px]",children:"조회"})]})}),e.jsx(Rt,{children:w.map((t,n)=>{const r=v?((e,t,n)=>{try{const r=`tdmfriends:tdmResult:${e}:${t}`,i=window.localStorage.getItem(r),s=`tdmfriends:tdmResult:${e}`,a=window.localStorage.getItem(s),o=`tdmfriends:tdmResults:${e}:${t}`,l=window.localStorage.getItem(o);if(i)return JSON.parse(i);if(l){const e=JSON.parse(l);if(e&&e.length>0){let t=e[e.length-1];if(n){const r=new Date(n).getTime();let i=e[0],s=Math.abs(new Date(e[0].timestamp).getTime()-r);for(const t of e){const e=new Date(t.timestamp).getTime(),n=Math.abs(e-r);n<s&&(s=n,i=t)}t=i}let r=t.data||t.summary||null;return t.data&&t.summary&&(r={...t.data,...t.summary}),r}}if(a)return JSON.parse(a)}catch(r){}return null})(v.id,t.drugName,t.startDate):null,i=((e,t)=>{const{tdmTarget:n,tdmTargetValue:r,drugName:i}=e;if(!n||!r)return"-";const s=(()=>{const e=n.toLowerCase();return e.includes("auc")?"AUC":e.includes("max")||e.includes("peak")?"Max":e.includes("trough")?"Trough":""})(),a=(null==t?void 0:t.AUC_24_before)||(null==t?void 0:t.AUC_tau_before)||(null==t?void 0:t.AUC24h_before)||(null==t?void 0:t.AUCtau_before)||null,o=(null==t?void 0:t.CMAX_before)||(null==t?void 0:t.CMax_before)||null,l=(null==t?void 0:t.CTROUGH_before)||(null==t?void 0:t.CTrough_before)||null,d=Se(n,a,o,l,i),c=(()=>{if(!r||!d.numericValue)return d.numericValue,null;const e=r.match(/(\d+(?:\.\d+)?)\s*-\s*(\d+(?:\.\d+)?)/);if(!e)return null;const t=parseFloat(e[1]),n=parseFloat(e[2]),i=d.numericValue;return i>n?"초과":i<t?"미달":"도달"})();return null!=d.numericValue&&c?`${s} ${d.value} 으로 목표범위 ${c}`:s?`${s} ${r}`:r})(t,r),s=(e=>{if(!e||void 0===e.Steady_state)return"-";const t=e.Steady_state;return("boolean"==typeof t?t:"true"===String(t).toLowerCase())?"도달":"미도달"})(r);return e.jsxs($t,{className:"cursor-pointer hover:bg-accent/50 dark:hover:bg-accent/30 "+((null==T?void 0:T.id)===t.id?"bg-accent dark:bg-accent/50":""),onClick:()=>S(t),children:[e.jsx(Et,{className:"align-top",children:Bt(t.startDate||t.id).format("YYYY.M.D")}),e.jsx(Et,{className:"font-medium align-top",children:t.drugName}),e.jsx(Et,{className:"align-top",children:t.indication||"-"}),e.jsx(Et,{className:"align-top",children:i}),e.jsx(Et,{className:"align-top",children:s}),e.jsx(Et,{className:"align-top",children:e.jsxs(ie,{variant:"outline",size:"sm",onClick:e=>{e.stopPropagation(),(e=>{if(!v)return;window.localStorage.setItem(`tdmfriends:selectedDrug:${v.id}`,e.drugName);const t=`${window.location.origin}${window.location.pathname}report?patientId=${v.id}`;window.open(t,"_blank"),x(!1)})(t)},className:"flex items-center gap-1",children:[e.jsx(de,{className:"h-3 w-3"}),"조회"]})})]},t.id)})})]})}):e.jsxs("div",{className:"text-center py-8 px-6",children:[e.jsx(ce,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"등록된 TDM 분석 내역이 없습니다."})]})})]})}),e.jsxs(Q,{children:[e.jsx(ee,{children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsxs(te,{children:["등록된 환자 (",i.length,")"]}),e.jsx(ne,{children:"환자를 클릭하면 상세 정보 확인 및 수정이 가능합니다"})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("div",{className:"relative",children:[e.jsx(ue,{className:"absolute left-2 top-2.5 h-4 w-4 text-muted-foreground"}),e.jsx(se,{placeholder:"환자 검색...",value:j,onChange:e=>N(e.target.value),className:"pl-8 w-64"})]})})]})}),e.jsx(re,{children:_.length>0?e.jsx("div",{className:"rounded-md border "+(s?"border-sky-300 dark:border-sky-700":""),children:e.jsxs(It,{children:[e.jsx(Mt,{children:e.jsxs($t,{children:[e.jsx(_t,{className:"w-12"}),e.jsx(_t,{children:"이름"}),e.jsx(_t,{children:"나이"}),e.jsx(_t,{children:"성별"}),e.jsx(_t,{children:"체중"}),e.jsx(_t,{children:"신장"}),e.jsx(_t,{children:"등록일"}),e.jsx(_t,{children:"수정과 조회"})]})}),e.jsx(Rt,{children:_.map(t=>{const n=(null==s?void 0:s.id)===t.id;return e.jsxs($t,{className:"cursor-pointer hover:bg-muted/50 "+(n?"bg-sky-50 dark:bg-sky-900 border-l-4 border-l-sky-300 dark:border-l-sky-700":""),onClick:()=>a(t),children:[e.jsx(Et,{children:n&&e.jsx(me,{className:"h-5 w-5 text-sky-500 dark:text-sky-400"})}),e.jsx(Et,{className:""+(n?"font-bold text-[#333333] dark:text-white":"font-medium"),children:t.name}),e.jsx(Et,{className:n?"font-bold text-[#333333] dark:text-white":"",children:t.age}),e.jsx(Et,{className:"capitalize "+(n?"font-bold text-[#333333] dark:text-white":""),children:t.gender}),e.jsxs(Et,{className:n?"font-bold text-[#333333] dark:text-white":"",children:[t.weight," kg"]}),e.jsxs(Et,{className:n?"font-bold text-[#333333] dark:text-white":"",children:[t.height," cm"]}),e.jsx(Et,{className:n?"font-bold text-[#333333] dark:text-white":"",children:t.createdAt.toLocaleDateString()}),e.jsx(Et,{children:e.jsxs("div",{className:"flex gap-1",children:[e.jsx(ie,{variant:"outline",size:"sm",onClick:e=>{e.stopPropagation(),k(t)},children:e.jsx(fe,{className:"h-4 w-4"})}),e.jsx(ie,{variant:"outline",size:"sm",onClick:e=>{e.stopPropagation(),C(t)},children:e.jsx(ce,{className:"h-4 w-4"})})]})})]},t.id)})})]})}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx("p",{className:"text-muted-foreground",children:j?"검색 결과가 없습니다":"아직 등록된 환자가 없습니다"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:j?"다른 검색어를 시도해보세요":"위 버튼을 통해 첫 환자를 등록하세요"})]})})]})]})}),Gt=({onAddPatient:t,onUpdatePatient:n,onDeletePatient:r,patients:i,selectedPatient:s,setSelectedPatient:a})=>e.jsx(Wt,{onAddPatient:t,onUpdatePatient:n,onDeletePatient:r,patients:i,selectedPatient:s,setSelectedPatient:a,showHeader:!1});function Jt(...e){const t=e[0];if(1===e.length)return t;const n=()=>{const n=e.map(e=>({useScope:e(),scopeName:e.scopeName}));return function(e){const r=n.reduce((t,{useScope:n,scopeName:r})=>({...t,...n(e)[`__scope${r}`]}),{});return y.useMemo(()=>({[`__scope${t.scopeName}`]:r}),[r])}};return n.scopeName=t.scopeName,n}var qt="Progress",[Yt,Xt]=function(t,n=[]){let r=[];const i=()=>{const e=r.map(e=>y.createContext(e));return function(n){const r=(null==n?void 0:n[t])||e;return y.useMemo(()=>({[`__scope${t}`]:{...n,[t]:r}}),[n,r])}};return i.scopeName=t,[function(n,i){const s=y.createContext(i),a=r.length;function o(n){const{scope:r,children:i,...o}=n,l=(null==r?void 0:r[t][a])||s,d=y.useMemo(()=>o,Object.values(o));return e.jsx(l.Provider,{value:d,children:i})}return r=[...r,i],o.displayName=n+"Provider",[o,function(e,r){const o=(null==r?void 0:r[t][a])||s,l=y.useContext(o);if(l)return l;if(void 0!==i)return i;throw new Error(`\`${e}\` must be used within \`${n}\``)}]},Jt(i,...n)]}(qt),[Zt,Qt]=Yt(qt),en=y.forwardRef((t,n)=>{const{__scopeProgress:r,value:i=null,max:a,getValueLabel:o=rn,...l}=t;(a||0===a)&&on(a);const d=on(a)?a:100;null!==i&&ln(i,d);const c=ln(i,d)?i:null,u=an(c)?o(c,d):void 0;return e.jsx(Zt,{scope:r,value:c,max:d,children:e.jsx(s.div,{"aria-valuemax":d,"aria-valuemin":0,"aria-valuenow":an(c)?c:void 0,"aria-valuetext":u,role:"progressbar","data-state":sn(c,d),"data-value":c??void 0,"data-max":d,...l,ref:n})})});en.displayName=qt;var tn="ProgressIndicator",nn=y.forwardRef((t,n)=>{const{__scopeProgress:r,...i}=t,a=Qt(tn,r);return e.jsx(s.div,{"data-state":sn(a.value,a.max),"data-value":a.value??void 0,"data-max":a.max,...i,ref:n})});function rn(e,t){return`${Math.round(e/t*100)}%`}function sn(e,t){return null==e?"indeterminate":e===t?"complete":"loading"}function an(e){return"number"==typeof e}function on(e){return an(e)&&!isNaN(e)&&e>0}function ln(e,t){return an(e)&&!isNaN(e)&&e<=t&&e>=0}nn.displayName=tn;var dn=en,cn=nn;const un=y.forwardRef(({className:t,value:n,...r},i)=>e.jsx(dn,{ref:i,className:d("relative h-4 w-full overflow-hidden rounded-full bg-secondary",t),...r,children:e.jsx(cn,{className:"h-full w-full flex-1 bg-primary transition-all",style:{transform:`translateX(-${100-(n||0)}%)`}})}));un.displayName=dn.displayName;const mn=({patients:t,selectedPatient:n,setSelectedPatient:r,onAddPatient:i,onUpdatePatient:s,onDeletePatient:a,onNext:o,isCompleted:l})=>e.jsx("div",{className:"space-y-6",children:e.jsxs(Q,{children:[e.jsxs(ee,{children:[e.jsxs(te,{className:"flex items-center gap-2",children:[e.jsx(pe,{className:"h-5 w-5"}),"1단계: 환자 선택",l&&e.jsx(me,{className:"h-5 w-5 text-green-600"})]}),e.jsx(ne,{children:"기존 환자를 선택하거나 신규 환자를 등록하세요."})]}),e.jsxs(re,{className:"space-y-6",children:[e.jsx(Wt,{onAddPatient:i,onUpdatePatient:s,onDeletePatient:a,patients:t,selectedPatient:n,setSelectedPatient:r,showHeader:!1}),n&&e.jsxs(Q,{className:"border-sky-300 dark:border-sky-700 bg-sky-50 dark:bg-sky-900",children:[e.jsx(ee,{children:e.jsx(te,{className:"text-sky-900 dark:text-sky-50",children:"환자 상세정보"})}),e.jsx(re,{children:e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"이름"}),e.jsx("p",{className:"text-sm text-black dark:text-white",children:n.name})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"생년월일"}),e.jsx("p",{className:"text-sm text-black dark:text-white",children:n.birthDate})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"나이"}),e.jsxs("p",{className:"text-sm text-black dark:text-white",children:[n.age,"세"]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"성별"}),e.jsx("p",{className:"text-sm text-black dark:text-white",children:"male"===n.gender?"남성":"female"===n.gender?"여성":"기타"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"체중"}),e.jsxs("p",{className:"text-sm text-black dark:text-white",children:[n.weight," kg"]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"신장"}),e.jsxs("p",{className:"text-sm text-black dark:text-white",children:[n.height," cm"]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"BMI"}),e.jsx("p",{className:"text-sm text-black dark:text-white",children:n.weight&&n.height?(n.weight/Math.pow(n.height/100,2)).toFixed(1):"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"BSA"}),e.jsxs("p",{className:"text-sm text-black dark:text-white",children:[n.weight&&n.height?Math.sqrt(n.weight*n.height/3600).toFixed(2):"-"," m²"]})]})]})})]}),l&&e.jsx("div",{className:"flex justify-end",children:e.jsxs(ie,{onClick:o,className:"flex items-center gap-2 w-[300px] bg-black dark:bg-primary text-white dark:text-primary-foreground font-bold text-lg py-3 px-6 justify-center hover:bg-gray-800 dark:hover:bg-primary/90",children:["TDM 선택",e.jsx(ge,{className:"h-4 w-4"})]})})]})]})});var fn="Radio",[pn,gn]=o(fn),[hn,xn]=pn(fn),vn=y.forwardRef((t,r)=>{const{__scopeRadio:i,name:o,checked:l=!1,required:d,disabled:c,value:u="on",onCheck:m,form:f,...p}=t,[g,h]=y.useState(null),x=n(r,e=>h(e)),v=y.useRef(!1),b=!g||(f||!!g.closest("form"));return e.jsxs(hn,{scope:i,checked:l,disabled:c,children:[e.jsx(s.button,{type:"button",role:"radio","aria-checked":l,"data-state":yn(l),"data-disabled":c?"":void 0,disabled:c,value:u,...p,ref:x,onClick:a(t.onClick,e=>{l||null==m||m(),b&&(v.current=e.isPropagationStopped(),v.current||e.stopPropagation())})}),b&&e.jsx(Nn,{control:g,bubbles:!v.current,name:o,value:u,checked:l,required:d,disabled:c,form:f,style:{transform:"translateX(-100%)"}})]})});vn.displayName=fn;var bn="RadioIndicator",jn=y.forwardRef((t,n)=>{const{__scopeRadio:r,forceMount:i,...a}=t,o=xn(bn,r);return e.jsx(l,{present:i||o.checked,children:e.jsx(s.span,{"data-state":yn(o.checked),"data-disabled":o.disabled?"":void 0,...a,ref:n})})});jn.displayName=bn;var Nn=t=>{const{control:n,checked:r,bubbles:i=!0,...s}=t,a=y.useRef(null),o=He(r),l=c(n);return y.useEffect(()=>{const e=a.current,t=window.HTMLInputElement.prototype,n=Object.getOwnPropertyDescriptor(t,"checked").set;if(o!==r&&n){const t=new Event("click",{bubbles:i});n.call(e,r),e.dispatchEvent(t)}},[o,r,i]),e.jsx("input",{type:"radio","aria-hidden":!0,defaultChecked:r,...s,tabIndex:-1,ref:a,style:{...t.style,...l,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})};function yn(e){return e?"checked":"unchecked"}var wn=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],Dn="RadioGroup",[Tn,Sn]=o(Dn,[Ye,gn]),kn=Ye(),Cn=gn(),[In,Mn]=Tn(Dn),Rn=y.forwardRef((t,n)=>{const{__scopeRadioGroup:i,name:a,defaultValue:o,value:l,required:d=!1,disabled:c=!1,orientation:u,dir:m,loop:f=!0,onValueChange:p,...g}=t,h=kn(i),x=T(m),[v,b]=r({prop:l,defaultProp:o,onChange:p});return e.jsx(In,{scope:i,name:a,required:d,disabled:c,value:v,onValueChange:b,children:e.jsx(st,{asChild:!0,...h,orientation:u,dir:x,loop:f,children:e.jsx(s.div,{role:"radiogroup","aria-required":d,"aria-orientation":u,"data-disabled":c?"":void 0,dir:x,...g,ref:n})})})});Rn.displayName=Dn;var $n="RadioGroupItem",_n=y.forwardRef((t,r)=>{const{__scopeRadioGroup:i,disabled:s,...o}=t,l=Mn($n,i),d=l.disabled||s,c=kn(i),u=Cn(i),m=y.useRef(null),f=n(r,m),p=l.value===o.value,g=y.useRef(!1);return y.useEffect(()=>{const e=e=>{wn.includes(e.key)&&(g.current=!0)},t=()=>g.current=!1;return document.addEventListener("keydown",e),document.addEventListener("keyup",t),()=>{document.removeEventListener("keydown",e),document.removeEventListener("keyup",t)}},[]),e.jsx(at,{asChild:!0,...c,focusable:!d,active:p,children:e.jsx(vn,{disabled:d,required:l.required,checked:p,...u,...o,name:l.name,ref:f,onCheck:()=>l.onValueChange(o.value),onKeyDown:a(e=>{"Enter"===e.key&&e.preventDefault()}),onFocus:a(o.onFocus,()=>{var e;g.current&&(null==(e=m.current)||e.click())})})})});_n.displayName=$n;var En=y.forwardRef((t,n)=>{const{__scopeRadioGroup:r,...i}=t,s=Cn(r);return e.jsx(jn,{...s,...i,ref:n})});En.displayName="RadioGroupIndicator";var Pn=Rn,An=_n,On=En;const Fn=y.forwardRef(({className:t,...n},r)=>e.jsx(Pn,{className:d("grid gap-2",t),...n,ref:r}));Fn.displayName=Pn.displayName;const Ln=y.forwardRef(({className:t,...n},r)=>e.jsx(An,{ref:r,className:d("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",t),...n,children:e.jsx(On,{className:"flex items-center justify-center",children:e.jsx(he,{className:"h-2.5 w-2.5 fill-current text-current"})})}));Ln.displayName=An.displayName;const Vn=["복용 중인 약물 없음","Nephrotoxic drugs including aminoglycosides (amikacin and tobramycin)","Liposomal amphotericin B","Antiviral agents (acyclovir, famciclovir and ganciclovir)","Colistimethate","Cytotoxic agents (cytosine arabinoside, fludarabine and idarubicin)","Cyclosporin","Tacrolimus","Non-steroidal anti-inflammatory agents (aceclofenac, ibuprofen, ketoprofen, ketorolac and zaltoprofen)","Trimethoprim/sulfamethoxazole","기타"],Hn=[{name:"Vancomycin",indications:["Not specified/Korean","Neurosurgical patients/Korean"],additionalInfo:{default:["신기능","체중","나이","감염 부위","미생물 민감도"],"Neurosurgical patients/Korean":Vn},targets:[{type:"Trough Concentration",value:"10-20 mg/L"},{type:"Peak Concentration",value:"25-40 mg/L"},{type:"AUC",value:"400-600 mg·h/L"}],defaultTargets:{"Not specified/Korean":{type:"AUC",value:"400-600 mg·h/L"},"Neurosurgical patients/Korean":{type:"AUC",value:"400-600 mg·h/L"}}},{name:"Cyclosporin",indications:["Renal transplant recipients/Korean","Allo-HSCT/Korean","Thoracic transplant recipients/European"],additionalInfo:{default:["신기능","간기능","혈압","약물상호작용","이식 후 경과"],"Renal transplant recipients/Korean":["POD ~2","POD 3~6","POD 7~"]},targets:[{type:"Trough Concentration",value:"100-400 ng/mL"},{type:"Peak Concentration",value:"800-1200 ng/mL"}],defaultTargets:{"Allo-HSCT/Korean":{type:"Trough Concentration",value:"150-400 ng/mL"},"Thoracic transplant recipients/European":{type:"Trough Concentration",value:"170-230 ng/mL"},"Renal transplant recipients/Korean":{type:"Trough Concentration",value:"300-350 ng/mL"}}}],Un=({patients:t,prescriptions:n,selectedPatient:r,selectedPrescription:i,setSelectedPrescription:s,onAddPrescription:a,onNext:o,onPrev:l,isCompleted:d,bloodTests:c,setBloodTests:u,drugAdministrations:m,setDrugAdministrations:f,onClearLaterStepData:p,onResetWorkflow:g})=>{const[h,x]=y.useState({drugName:"",indication:"",additionalInfo:"",tdmTarget:"",tdmTargetValue:""}),[v,b]=y.useState(!1),[j,N]=y.useState(""),[w,D]=y.useState(null),[T,S]=y.useState(null),k=e=>e.startsWith("temp"),C=e=>!k(e);y.useEffect(()=>{if(!r)return;const e=`tdmfriends:prescription:${r.id}`;try{const t=localStorage.getItem(e);if(t){const e=JSON.parse(t);if(e.selectedTdmId){D(e.selectedTdmId);const t=n.find(t=>t.id===e.selectedTdmId&&t.patientId===r.id);t&&s(t)}e.newlyAddedTdmId&&S(e.newlyAddedTdmId)}}catch(t){}},[r,n,s,null==r?void 0:r.id]),y.useEffect(()=>{if(!r)return;const e=`tdmfriends:prescription:${r.id}`;try{const t={selectedTdmId:w,newlyAddedTdmId:T,formData:h};localStorage.setItem(e,JSON.stringify(t))}catch(t){}},[w,T,h,r,null==r?void 0:r.id]),y.useEffect(()=>{if(!r||!w)return;const e=n.find(e=>e.id===w&&e.patientId===r.id);e&&s(e)},[w,n,r,null==r?void 0:r.id,s]),y.useEffect(()=>{if(!r||!T)return;const e=n.find(e=>e.id===T&&e.patientId===r.id);e&&(w!==T&&D(T),s(e))},[n,T,r,null==r?void 0:r.id,w,s]);const I=r?n.filter(e=>e.patientId===r.id):[],M=y.useCallback(e=>{const t={drugName:e.drugName||"",indication:e.indication||"",additionalInfo:e.additionalInfo||"",tdmTarget:e.tdmTarget||"Trough Concentration",tdmTargetValue:e.tdmTargetValue||""};x(t),N("Vancomycin"===t.drugName&&"Neurosurgical patients/Korean"===t.indication?"복용 중인 약물 없음"===t.additionalInfo?"아니오":t.additionalInfo?"네":"":"")},[]),R=y.useRef(null),$=y.useRef([]);y.useEffect(()=>{if(!r)return R.current=null,void($.current=[]);const e=r.id,t=I.map(e=>e.id);if(R.current!==e)return R.current=e,void($.current=t);const n=$.current,i=t.find(e=>!n.includes(e));if(i){D(i),S(i);const e=I.find(e=>e.id===i);e&&(s(e),M(e))}$.current=t},[I,r,M,s]);const _=Hn.find(e=>e.name===h.drugName),E=_?_.targets:[],H=(()=>{if(!_||!h.indication)return[];if("Vancomycin"===_.name&&"Not specified/Korean"===h.indication)return["투석 안 함","CRRT"];if("object"==typeof _.additionalInfo&&!Array.isArray(_.additionalInfo)){const e=_.additionalInfo[h.indication];if(e)return e;const t=_.additionalInfo.default;if(t)return t}return Array.isArray(_.additionalInfo)?_.additionalInfo:[]})(),U=()=>"Vancomycin"===(null==_?void 0:_.name)&&"Not specified/Korean"===h.indication||("Vancomycin"===(null==_?void 0:_.name)&&"Neurosurgical patients/Korean"===h.indication||"Cyclosporin"===(null==_?void 0:_.name)&&"Renal transplant recipients/Korean"===h.indication),K=()=>{if(!r)return!1;const e=c.some(e=>e.patientId===r.id),t=m.some(e=>e.patientId===r.id);return e||t};return r?e.jsxs("div",{className:"space-y-6",children:[e.jsxs(Q,{children:[e.jsxs(ee,{children:[e.jsxs(te,{className:"flex items-center gap-2",children:[e.jsx(xe,{className:"h-5 w-5"}),"2단계: TDM 선택",d&&e.jsx(me,{className:"h-5 w-5 text-green-600"})]}),e.jsx(ne,{children:r?`${r.name} 환자의 TDM 약물 정보를 입력하세요.`:"TDM 약물 정보를 입력하세요."})]}),e.jsxs(re,{className:"space-y-6",children:[I.length>0&&e.jsxs(Q,{children:[e.jsxs(ee,{children:[e.jsxs(te,{children:["TDM 내역 (",I.length,")"]}),e.jsx(ne,{children:"기 수행된 TDM의 F/U TDM을 진행하신다면 아래 내역 중 선택해 주세요."})]}),e.jsx(re,{children:e.jsx("div",{className:"rounded-md border "+(w?"border-sky-300 dark:border-sky-700":""),children:e.jsxs(It,{children:[e.jsx(Mt,{children:e.jsxs($t,{children:[e.jsx(_t,{className:"w-12"}),e.jsx(_t,{children:"분석일"}),e.jsx(_t,{children:"약물명"}),e.jsx(_t,{children:"적응증"}),e.jsx(_t,{children:"추가정보"}),e.jsx(_t,{children:"TDM 목표치"}),e.jsx(_t,{children:"삭제"})]})}),e.jsx(Rt,{children:I.map(t=>{const i=w===t.id;return e.jsxs($t,{className:"cursor-pointer hover:bg-muted/50 "+(i?"bg-sky-50 dark:bg-sky-900 border-l-4 border-l-sky-300 dark:border-l-sky-700":""),onClick:()=>(e=>{D(e.id),s(e),e.id!==T&&S(null),M(e)})(t),children:[e.jsx(Et,{children:i&&e.jsx(me,{className:"h-5 w-5 text-sky-500 dark:text-sky-400"})}),e.jsx(Et,{className:i?"font-bold text-[#333333] dark:text-white":"",children:C(t.id)?"진행 중":t.startDate?new Date(t.startDate).toLocaleDateString("ko-KR"):"-"}),e.jsx(Et,{className:""+(i?"font-bold text-[#333333] dark:text-white":"font-medium"),children:t.drugName}),e.jsx(Et,{className:i?"font-bold text-[#333333] dark:text-white":"",children:t.indication||"-"}),e.jsx(Et,{className:i?"font-bold text-[#333333] dark:text-white":"",children:t.additionalInfo?"Vancomycin"===t.drugName&&"Neurosurgical patients/Korean"===t.indication?"복용 중인 약물 없음"===t.additionalInfo?"신독성 약물 복용 안 함":"신독성 약물 복용 중":t.additionalInfo:"-"}),e.jsx(Et,{className:i?"font-bold text-[#333333] dark:text-white":"",children:t.tdmTarget&&t.tdmTargetValue?`${t.tdmTarget}: ${t.tdmTargetValue}`:t.tdmTargetValue||"-"}),e.jsx(Et,{children:C(t.id)&&e.jsxs(ie,{variant:"ghost",size:"icon",onClick:e=>{e.stopPropagation(),(e=>{if(!r)return;if(!C(e))return;const t=n.find(t=>t.id===e&&t.patientId===r.id);if(!t)return;if(!window.confirm(`${t.drugName} TDM이 진행 중입니다.\n\n해당 TDM 내역을 삭제 시 관련된 Lab정보와 투약 기록, 시뮬레이션 데이터가 초기화 됩니다.\n\n삭제하시겠습니까?`))return;const i=t.drugName,o=n.filter(t=>!(t.id===e&&t.patientId===r.id));a(void 0,o);const l=c.filter(e=>!(e.patientId===r.id&&e.drugName===i));u(l);const d=m.filter(e=>!(e.patientId===r.id&&e.drugName===i));f(d);try{localStorage.removeItem(`tdmfriends:renal:${r.id}:${i}`)}catch(g){}const p=o.filter(e=>e.patientId===r.id);if(p.length>0){const e=p.sort((e,t)=>{const n=parseInt(e.id);return parseInt(t.id)-n})[0];D(e.id),s(e),C(e.id)?S(e.id):S(null);const t={drugName:e.drugName||"",indication:e.indication||"",additionalInfo:e.additionalInfo||"",tdmTarget:e.tdmTarget||"Trough Concentration",tdmTargetValue:e.tdmTargetValue||""};x(t)}else D(null),s(null);e===T&&S(null)})(t.id)},children:[e.jsx("span",{className:"sr-only",children:"삭제"}),e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",className:"w-5 h-5",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M6 18L18 6M6 6l12 12"})})]})})]},t.id)})})]})})})]}),e.jsxs(Q,{children:[e.jsx(ee,{children:e.jsxs(te,{className:"flex items-center gap-2",children:[e.jsx(ve,{className:"h-4 w-4"}),"신규 TDM 추가",w&&(()=>{const t=I.find(e=>e.id===w);if(!t)return null;if("existing"!==(k(t.id)?"existing":"newly-added"))return null;const n=t.startDate?new Date(t.startDate).toLocaleDateString("ko-KR"):"";return e.jsxs("span",{className:"text-sm text-blue-600 font-normal",children:["(",n,"에 진행한 TDM을 F/U합니다)"]})})()]})}),e.jsx(re,{children:e.jsxs("form",{onSubmit:e=>{if(e.preventDefault(),!r)return;if(n.filter(e=>e.patientId===r.id&&e.drugName===h.drugName&&C(e.id)).length>0){if(!window.confirm(`${h.drugName}에 대한 신규 TDM이 이미 등록되어 있습니다. 삭제 후 새로운 TDM을 추가하시겠습니까?`))return;const e=n.filter(e=>{if(e.patientId!==r.id)return!0;if(e.drugName!==h.drugName)return!0;return!C(e.id)}),t={id:Date.now().toString(),patientId:r.id,drugName:h.drugName,dosage:0,unit:"",frequency:"",startDate:new Date,route:"",prescribedBy:"",indication:h.indication,tdmTarget:h.tdmTarget,tdmTargetValue:h.tdmTargetValue,additionalInfo:h.additionalInfo},i=[...e,t];return a(void 0,i),S(t.id),D(t.id),s(t),void x({drugName:"",indication:"",additionalInfo:"",tdmTarget:"",tdmTargetValue:""})}if("Vancomycin"===h.drugName&&"Not specified/Korean"===h.indication&&!h.additionalInfo)return void alert("투석여부(신 대체요법) 정보를 입력해주세요.");if("Vancomycin"===h.drugName&&"Neurosurgical patients/Korean"===h.indication&&!h.additionalInfo)return void alert(`${h.indication}의 경우 복용 중인 약물 정보를 입력해주세요.`);if("Cyclosporin"===h.drugName&&"Renal transplant recipients/Korean"===h.indication&&!h.additionalInfo)return void alert(`${h.indication}의 경우 POD 정보를 입력해주세요.`);const t={id:Date.now().toString(),patientId:r.id,drugName:h.drugName,dosage:0,unit:"",frequency:"",startDate:new Date,route:"",prescribedBy:"",indication:h.indication,tdmTarget:h.tdmTarget,tdmTargetValue:h.tdmTargetValue,additionalInfo:h.additionalInfo},i=n.filter(e=>e.patientId!==r.id);a(t,i),S(t.id),D(t.id),s(t),x({drugName:"",indication:"",additionalInfo:"",tdmTarget:"",tdmTargetValue:""})},className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(P,{htmlFor:"drugName",children:"약물명 *"}),e.jsxs(A,{value:h.drugName,onValueChange:e=>{var t,n;if(I.length>0&&I[0].drugName!==e){K()&&p()}const r=Hn.find(t=>t.name===e),i=(null==r?void 0:r.indications[0])||"",s=null==(t=null==r?void 0:r.defaultTargets)?void 0:t[i];x({drugName:e,indication:i,additionalInfo:"",tdmTarget:(null==s?void 0:s.type)||"Trough Concentration",tdmTargetValue:(null==s?void 0:s.value)||(null==(n=null==r?void 0:r.targets.find(e=>"Trough Concentration"===e.type))?void 0:n.value)||""}),N("")},required:!0,children:[e.jsx(O,{id:"drugName",children:e.jsx(F,{placeholder:"TDM 약물 선택"})}),e.jsx(L,{children:Hn.map(t=>e.jsx(V,{value:t.name,children:t.name},t.name))})]})]}),e.jsxs("div",{children:[e.jsx(P,{htmlFor:"indication",children:"적응증/Demographic *"}),e.jsxs(A,{value:h.indication,onValueChange:e=>{var t;const n=null==(t=null==_?void 0:_.defaultTargets)?void 0:t[e];x(t=>({...t,indication:e,additionalInfo:w?t.additionalInfo:"",tdmTarget:(null==n?void 0:n.type)||t.tdmTarget,tdmTargetValue:(null==n?void 0:n.value)||t.tdmTargetValue})),"Vancomycin"===h.drugName&&"Neurosurgical patients/Korean"===e?N(w&&"복용 중인 약물 없음"===h.additionalInfo?"아니오":w&&h.additionalInfo&&"복용 중인 약물 없음"!==h.additionalInfo?"네":""):N("")},required:!0,disabled:!h.drugName,children:[e.jsx(O,{id:"indication",children:e.jsx(F,{placeholder:"적응증 선택"})}),e.jsx(L,{children:null==_?void 0:_.indications.map(t=>e.jsx(V,{value:t,children:t},t))})]})]}),e.jsxs("div",{children:[e.jsx(P,{htmlFor:"tdmTarget",children:"TDM 목표 *"}),e.jsxs(A,{value:h.tdmTarget,onValueChange:e=>{const t=E.find(t=>t.type===e);x(n=>({...n,tdmTarget:e,tdmTargetValue:(null==t?void 0:t.value)||""}))},required:!0,disabled:!h.drugName,children:[e.jsx(O,{id:"tdmTarget",children:e.jsx(F,{placeholder:"TDM 목표 선택"})}),e.jsx(L,{children:E.map(t=>e.jsx(V,{value:t.type,children:t.type},t.type))})]})]}),e.jsxs("div",{children:[e.jsx(P,{htmlFor:"tdmTargetValue",children:"TDM 목표치 *"}),e.jsx(se,{id:"tdmTargetValue",value:h.tdmTargetValue,onChange:e=>x(t=>({...t,tdmTargetValue:e.target.value})),placeholder:"TDM 목표 선택 시 자동 입력, 수정 가능",required:!0,disabled:!h.tdmTarget})]}),!(!_||!h.indication)&&("Vancomycin"===_.name&&"Not specified/Korean"===h.indication||"Vancomycin"===_.name&&"Neurosurgical patients/Korean"===h.indication||"Cyclosporin"===_.name&&"Renal transplant recipients/Korean"===h.indication)&&e.jsx("div",{className:"md:col-span-2",children:"Vancomycin"===h.drugName&&"Neurosurgical patients/Korean"===h.indication?e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(P,{htmlFor:"nephrotoxic-drug",className:"font-bold",children:["신독성 약물을 복용 중인가요? ",U()?"*":""]}),e.jsx(ie,{type:"button",variant:"link",className:"h-auto p-0 text-sm text-gray-600 underline",onClick:()=>b(!0),children:"약물 목록 보기"})]}),e.jsxs(Fn,{value:j||("복용 중인 약물 없음"===h.additionalInfo?"아니오":h.additionalInfo&&"복용 중인 약물 없음"!==h.additionalInfo?"네":""),onValueChange:e=>{if(N(e),"아니오"===e)x(e=>({...e,additionalInfo:"복용 중인 약물 없음"}));else if("네"===e){const e=Vn.find(e=>"복용 중인 약물 없음"!==e&&"기타"!==e);x(t=>({...t,additionalInfo:t.additionalInfo&&"복용 중인 약물 없음"!==t.additionalInfo?t.additionalInfo:e||""}))}},className:"flex items-center space-x-6",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ln,{value:"네",id:"yes"}),e.jsx(P,{htmlFor:"yes",children:"네"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ln,{value:"아니오",id:"no"}),e.jsx(P,{htmlFor:"no",children:"아니오"})]})]})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(P,{className:"font-bold",children:[_&&h.indication?"Vancomycin"===_.name&&"Not specified/Korean"===h.indication?"투석여부(신 대체요법)":"Vancomycin"===_.name&&"Neurosurgical patients/Korean"===h.indication?"복용 중인 약물":"Cyclosporin"===_.name&&"Renal transplant recipients/Korean"===h.indication?"POD":"추가정보":"추가정보"," ",U()?"*":""]}),"Vancomycin"===h.drugName&&"Not specified/Korean"===h.indication&&e.jsx("span",{className:"text-sm text-muted-foreground",children:"Vancomycin의 Not specified/Korean 적응증에서는 CRRT 분석 모델만 지원됩니다."})]}),e.jsx(Fn,{value:h.additionalInfo,onValueChange:e=>{x(t=>({...t,additionalInfo:e}))},className:"flex flex-wrap gap-4",children:H.map((t,n)=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ln,{value:t,id:`additional-${n}`}),e.jsx(P,{htmlFor:`additional-${n}`,className:"cursor-pointer",children:t})]},t))})]})})]}),e.jsx("div",{className:"pt-[30px]",children:e.jsx(ie,{type:"submit",className:"w-full",children:"TDM 추가"})})]})})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs(ie,{variant:"outline",onClick:l,className:"flex items-center gap-2",children:[e.jsx(be,{className:"h-4 w-4"}),"환자 등록 및 선택"]}),d&&e.jsxs(ie,{onClick:()=>{w?o():alert("현재 진행 중인 TDM이 선택되어 있지 않습니다. TDM 내역을 선택한 후 다음 단계로 이동해주세요.")},className:"flex items-center gap-2 w-[300px] bg-black dark:bg-primary text-white dark:text-primary-foreground font-bold text-lg py-3 px-6 justify-center hover:bg-gray-800 dark:hover:bg-primary/90",children:["Lab",e.jsx(ge,{className:"h-4 w-4"})]})]})]})]}),e.jsx(Pt,{open:v,onOpenChange:b,children:e.jsxs(Lt,{className:"max-w-3xl max-h-[80vh] overflow-y-auto",onInteractOutside:()=>b(!1),children:[e.jsxs(Vt,{children:[e.jsxs(Ut,{children:["신독성 약물 목록 (",Vn.filter(e=>"복용 중인 약물 없음"!==e&&"기타"!==e).length,")"]}),e.jsx(Kt,{children:'해당하는 약물이 있다면 "네"를 선택해주세요.'})]}),e.jsx("ul",{className:"list-disc pl-6 space-y-1 text-sm text-muted-foreground",children:Vn.filter(e=>"복용 중인 약물 없음"!==e&&"기타"!==e).map((t,n)=>e.jsx("li",{className:"text-base text-foreground",children:t},n))}),e.jsx("div",{className:"flex justify-end pt-4",children:e.jsx(ie,{type:"button",onClick:()=>b(!1),children:"확인"})})]})})]}):e.jsx(Q,{children:e.jsx(re,{className:"py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx(xe,{className:"h-16 w-16 text-muted-foreground mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"Please select a patient first"})]})})})},Kn=({patients:t,bloodTests:n,selectedPatient:r,selectedPrescription:i,onAddBloodTest:s,onDeleteBloodTest:a,onUpdateBloodTest:o=()=>{},onNext:l,onPrev:d,isCompleted:c,prescriptions:u})=>{const[m,f]=y.useState({creatinine:"",date:"",formula:"cockcroft-gault",result:"",dialysis:"N",renalReplacement:"",isBlack:!1}),[p,g]=y.useState([]),[h,x]=y.useState(!1),v=(e,t,n,r=!1)=>{if(!e||e<=0)return"";switch(t){case"cockcroft-gault":return b(e,n.age,n.weight,n.height,n.gender);case"mdrd":return j(e,n.age,n.gender,r);case"ckd-epi":return N(e,n.age,n.gender,r);default:return""}},b=(e,t,n,r,i)=>{const s="여성"===i?.85:1,a=((e,t)=>"여성"===t?45.5+.9*(e-152):50+.9*(e-152))(r,i),o=n/Math.pow(r/100,2)>30||n>1.2*a,l=o?((e,t)=>t+.4*(e-t))(n,a):n,d=(140-t)*l*s/(72*e),c=o?` (조정체중: ${Math.round(10*l)/10}kg)`:"";return`CRCL = ${Math.round(10*d)/10} mL/min${c}`},j=(e,t,n,r)=>{const i="여성"===n?.742:1,s=r?1.212:1,a=175*Math.pow(e,-1.154)*Math.pow(t,-.203)*i*s;return`eGFR = ${Math.round(10*a)/10} mL/min/1.73m²`},N=(e,t,n,r)=>{const i=r?1.212:1;let s,a;"여성"===n?(s=-.329,a=.7):(s=-.411,a=.9);const o=Math.min(Math.max(e/a,1),999),l=141*Math.pow(o,s)*Math.pow(.993,t)*i;return`eGFR = ${Math.round(10*l)/10} mL/min/1.73m²`},w=i,D=!i||"Cyclosporin"!==i.drugName&&("Vancomycin"!==i.drugName||"Not specified/Korean"!==i.indication||"CRRT"!==i.additionalInfo);y.useEffect(()=>{if(r&&w){x(!1);try{const e=window.localStorage.getItem(`tdmfriends:renal:${r.id}:${w.drugName}`);if(e){const t=JSON.parse(e);g(t)}else g([])}catch(e){}finally{x(!0)}}},[null==r?void 0:r.id,null==w?void 0:w.drugName]),y.useEffect(()=>{if(r&&w&&h)try{window.localStorage.setItem(`tdmfriends:renal:${r.id}:${w.drugName}`,JSON.stringify(p))}catch(e){}},[null==r?void 0:r.id,null==w?void 0:w.drugName,p,h]);const[T,S]=y.useState({testDate:"",testTime:"",concentration:"",unit:"ng/mL",measurementType:"Trough"}),[k,C]=y.useState(!1),[I,M]=y.useState(!1),[R,$]=y.useState(!1),[_,E]=y.useState(null),J=r&&w?n.filter(e=>e.patientId===r.id&&e.drugName===w.drugName):[],q=Bt().format("YYYY-MM-DD"),Y=()=>{var e,t;return!(!r||!i)&&("CRRT"===(null==(e=i.additionalInfo)?void 0:e.toUpperCase())||(null==(t=i.additionalInfo)?void 0:t.toUpperCase().includes("CRRT")))};y.useEffect(()=>{const e="Vancomycin"===(null==w?void 0:w.drugName)?"mg/L":"ng/mL";S(t=>({...t,unit:e}))},[null==w?void 0:w.drugName]),y.useEffect(()=>{$(!1)},[null==i?void 0:i.id]);const X=e=>{E(e.id),f({creatinine:e.creatinine,date:e.date,formula:e.formula,result:e.result,dialysis:e.dialysis,renalReplacement:e.renalReplacement,isBlack:e.isBlack}),M(!0)},Z=()=>{if(m.creatinine&&r){const e=parseFloat(m.creatinine);if(!isNaN(e)&&e>0){const t=v(e,m.formula,r,m.isBlack);f(e=>({...e,result:t}))}}};return r?e.jsxs("div",{className:"space-y-6",children:[e.jsxs(Q,{children:[e.jsxs(ee,{children:[e.jsxs(te,{className:"flex items-center gap-2",children:[e.jsx(je,{className:"h-5 w-5"}),"3단계: Lab",c&&e.jsx(me,{className:"h-5 w-5 text-green-600"})]}),e.jsx(ne,{children:r?`${r.name} 환자의 신기능(혈청 크레아티닌)과 혈중 약물 농도 정보를 입력하세요.`:"신기능(혈청 크레아티닌)과 혈중 약물 농도 정보를 입력하세요."})]}),e.jsxs(re,{className:"space-y-6",children:[w&&r&&e.jsxs("div",{className:"py-3 px-4 rounded bg-muted dark:bg-slate-800 mb-4",children:[e.jsxs("div",{className:"grid grid-cols-6 gap-4 mb-3",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-medium",children:"나이:"})," ",r.age]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-medium",children:"성별:"})," ",r.gender]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-medium",children:"몸무게:"})," ",r.weight,"kg"]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-medium",children:"키:"})," ",r.height,"cm"]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-medium",children:"BMI:"})," ",(()=>{if(!(null==r?void 0:r.weight)||!(null==r?void 0:r.height))return"N/A";return(r.weight/Math.pow(r.height/100,2)).toFixed(1)})()]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-medium",children:"BSA:"})," ",(()=>{if(!(null==r?void 0:r.weight)||!(null==r?void 0:r.height))return"N/A";return Math.sqrt(r.height*r.weight/3600).toFixed(2)})()]})]}),e.jsxs("div",{className:"space-y-2 pt-2 border-t border-gray-200 dark:border-gray-600",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-medium text-gray-600 dark:text-gray-400",children:"약품명:"}),e.jsx("span",{className:"ml-2 font-semibold",children:w.drugName})]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-medium text-gray-600 dark:text-gray-400",children:"적응증:"}),e.jsx("span",{className:"ml-2",children:w.indication})]})]})]}),e.jsxs(Q,{children:[e.jsx(ee,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(te,{children:["신기능 데이터 (",p.length,")"]}),e.jsx(ne,{children:"체크박스를 선택하면 해당 신기능 데이터가 시뮬레이션에 반영됩니다."})]}),e.jsxs(ie,{onClick:()=>M(!0),className:"flex items-center gap-2",children:[e.jsx(ve,{className:"h-4 w-4"}),"신규 추가"]})]})}),e.jsx(re,{className:"space-y-6",children:e.jsx("div",{className:"rounded-md border "+(p.some(e=>e.isSelected)?"border-sky-300 dark:border-sky-700":""),children:e.jsxs(It,{children:[e.jsx(Mt,{children:e.jsxs($t,{children:[e.jsx(_t,{className:"w-12"}),e.jsx(_t,{className:"text-center",children:"검사일"}),e.jsx(_t,{className:"text-center",children:"혈청 크레아티닌"}),e.jsx(_t,{className:"text-center",children:"결과"}),e.jsx(_t,{className:"w-16",children:"삭제"})]})}),e.jsxs(Rt,{children:[(()=>{const t=!D&&p.every(e=>!e.isSelected);return e.jsxs($t,{className:t?"bg-sky-50 dark:bg-sky-900 border-l-4 border-l-sky-300 dark:border-l-sky-700":"",children:[e.jsx(Et,{children:t&&e.jsx(me,{className:"h-5 w-5 text-sky-500 dark:text-sky-400"})}),e.jsx(Et,{colSpan:3,className:"text-center "+(t?"font-bold text-[#333333] dark:text-white":"text-muted-foreground"),children:D?"해당 TDM은 신기능 데이터를 필수 입력해야 합니다":"해당 TDM은 신기능 데이터를 사용하지 않습니다"}),e.jsx(Et,{})]})})(),p.map(t=>{const n=t.isSelected;return e.jsxs($t,{className:"cursor-pointer hover:bg-muted/50 "+(n?"bg-sky-50 dark:bg-sky-900 border-l-4 border-l-sky-300 dark:border-l-sky-700":""),onClick:e=>{const n=e.target;n.closest("button")||n.closest("svg")||n.closest("circle")||X(t)},onDoubleClick:e=>{e.target.closest("button")||X(t)},children:[e.jsx(Et,{onClick:e=>{var r,i;e.stopPropagation(),r=t.id,i=!n,g(p.map(e=>({...e,isSelected:e.id===r&&i})))},children:n&&e.jsx(me,{className:"h-5 w-5 text-sky-500 dark:text-sky-400"})}),e.jsx(Et,{className:"text-center "+(n?"font-bold text-[#333333] dark:text-white":""),children:t.date}),e.jsxs(Et,{className:"text-center "+(n?"font-bold text-[#333333] dark:text-white":""),children:[t.creatinine," mg/dL"]}),e.jsx(Et,{className:"text-center "+(n?"font-bold text-[#333333] dark:text-white":""),children:t.result||"-"}),e.jsx(Et,{children:e.jsx(ie,{variant:"ghost",size:"icon",onClick:e=>{var n;e.stopPropagation(),n=t.id,g(p.filter(e=>e.id!==n))},children:e.jsx(ae,{className:"h-4 w-4"})})})]},t.id)})]})]})})})]}),e.jsxs(Q,{children:[e.jsx(ee,{children:e.jsx(te,{children:"혈중 약물 농도"})}),e.jsxs(re,{children:[e.jsxs("form",{onSubmit:e=>{if(e.preventDefault(),!r)return;if(!T.testDate||!T.testTime||!T.concentration)return;const t=`${T.testDate}T${T.testTime}`,n=Bt(t);if(!n.isValid())return void alert("날짜와 시간 형식이 올바르지 않습니다.");if(n.isAfter(Bt()))return void alert("날짜는 현재 시각 이후로 입력할 수 없습니다.");if(T.testDate>q)return void alert("날짜는 오늘 이후로 입력할 수 없습니다.");const i=n.toDate(),a=p.find(e=>e.isSelected),o={id:Date.now().toString(),patientId:r.id,drugName:(null==w?void 0:w.drugName)||"",concentration:parseFloat(T.concentration),unit:T.unit,timeAfterDose:0,testDate:i,measurementType:T.measurementType,creatinine:(null==a?void 0:a.result)||void 0,dialysis:(null==a?void 0:a.dialysis)||void 0,renalReplacement:(null==a?void 0:a.renalReplacement)||void 0};s(o);const l="Vancomycin"===(null==w?void 0:w.drugName)?"mg/L":"ng/mL";S({testDate:"",testTime:"",concentration:"",unit:l,measurementType:"Trough"})},className:"flex flex-col md:flex-row gap-4 items-end",children:[e.jsxs("div",{children:[e.jsx(P,{htmlFor:"drugDateTime",children:"날짜/시간 "}),e.jsx(se,{id:"drugDateTime",type:"datetime-local",step:"60",value:T.testDate&&T.testTime?`${T.testDate}T${T.testTime}`:"",onChange:e=>(e=>{if(!e)return void S(e=>({...e,testDate:"",testTime:""}));const[t,n=""]=e.split("T"),r=n.slice(0,5);S(e=>({...e,testDate:t||"",testTime:r||""}))})(e.target.value),onFocus:()=>{Y()&&!R&&(C(!0),$(!0))},max:`${q}T23:59`})]}),e.jsxs("div",{children:[e.jsx(P,{htmlFor:"concentration",children:"농도"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(se,{id:"concentration",type:"number",step:"0.01",value:T.concentration,onChange:e=>S({...T,concentration:e.target.value}),className:"flex-1"}),e.jsxs(A,{value:T.unit,onValueChange:e=>S({...T,unit:e}),children:[e.jsx(O,{className:"w-24",children:e.jsx(F,{})}),e.jsx(L,{children:"Vancomycin"===(null==w?void 0:w.drugName)?e.jsx(e.Fragment,{children:e.jsx(V,{value:"mg/L",children:"mg/L"})}):"Cyclosporin"===(null==w?void 0:w.drugName)?e.jsx(e.Fragment,{children:e.jsx(V,{value:"ng/mL",children:"ng/mL"})}):e.jsxs(e.Fragment,{children:[e.jsx(V,{value:"mg/L",children:"mg/L"}),e.jsx(V,{value:"ng/mL",children:"ng/mL"}),e.jsx(V,{value:"μg/L",children:"μg/L"})]})})]})]})]}),e.jsx(ie,{type:"submit",children:"추가"})]}),J.length>0&&e.jsx("div",{className:"mt-4",children:e.jsxs(It,{children:[e.jsx(Mt,{children:e.jsxs($t,{children:[e.jsx(_t,{children:"날짜"}),e.jsx(_t,{children:"시간"}),e.jsx(_t,{children:"농도"}),e.jsx(_t,{className:"w-16",children:"삭제"})]})}),e.jsx(Rt,{children:J.map(t=>e.jsxs($t,{children:[e.jsx(Et,{children:t.testDate.toLocaleDateString()}),e.jsx(Et,{children:t.testDate.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}),e.jsxs(Et,{children:[t.concentration," ",t.unit]}),e.jsx(Et,{children:e.jsx(ie,{variant:"ghost",size:"icon",onClick:()=>a(t.id),children:e.jsx(ae,{className:"h-4 w-4"})})})]},t.id))})]})})]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs(ie,{variant:"outline",onClick:d,className:"flex items-center gap-2",children:[e.jsx(be,{className:"h-4 w-4"}),"TDM 선택"]}),c&&e.jsxs(ie,{onClick:()=>{if(D){if(!p.some(e=>e.isSelected))return void alert("신기능 데이터를 입력해주세요.")}l()},className:"flex items-center gap-2 w-[300px] bg-black dark:bg-primary text-white dark:text-primary-foreground font-bold text-lg py-3 px-6 justify-center hover:bg-gray-800 dark:hover:bg-primary/90",children:["투약 기록",e.jsx(ge,{className:"h-4 w-4"})]})]})]})]}),e.jsx(Pt,{open:I,onOpenChange:e=>{M(e),e||(E(null),f({creatinine:"",date:"",formula:"cockcroft-gault",result:"",dialysis:"N",renalReplacement:"",isBlack:!1}))},children:e.jsxs(Lt,{className:"max-w-5xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(Vt,{children:[e.jsx(Ut,{children:_?"신기능 데이터 수정":"신기능 데이터 추가"}),e.jsx(Kt,{children:_?"신기능 데이터를 수정하세요.":"신기능 데이터를 입력하세요."})]}),e.jsxs("form",{className:"space-y-4",onSubmit:e=>{e.preventDefault(),(()=>{if(m.creatinine&&m.date&&m.formula){if(_){const e=p.map(e=>e.id===_?{...e,...m}:e);g(e)}else{const e={id:Date.now().toString(),...m,isSelected:!0},t=p.map(e=>({...e,isSelected:!1}));g([...t,e])}f({creatinine:"",date:"",formula:"cockcroft-gault",result:"",dialysis:"N",renalReplacement:"",isBlack:!1}),M(!1),E(null)}else alert("신기능 데이터의 필수 항목을 모두 입력해주세요. (혈청 크레아티닌, 검사일, 계산식)")})()},children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx(P,{htmlFor:"modal-renalDate",children:"검사일 *"}),e.jsx(se,{id:"modal-renalDate",type:"date",value:m.date,max:q,onChange:e=>f({...m,date:e.target.value}),required:!0})]}),e.jsxs("div",{children:[e.jsx(P,{htmlFor:"modal-creatinine",className:"whitespace-nowrap",children:"혈청 크레아티닌 (mg/dL) *"}),e.jsx(se,{id:"modal-creatinine",type:"number",step:"0.01",value:m.creatinine,onChange:e=>f({...m,creatinine:e.target.value}),onBlur:Z,onKeyDown:e=>{if("Enter"===e.key){e.preventDefault(),Z();const t=document.getElementById("modal-result");t&&setTimeout(()=>{t.focus()},100)}},placeholder:"예: 1.2",required:!0})]}),e.jsxs("div",{children:[e.jsx(P,{htmlFor:"modal-renalFormula",children:"계산식 *"}),e.jsxs(A,{value:m.formula,onValueChange:e=>{f(t=>{const n={...t,formula:e};if(t.creatinine&&r){const i=parseFloat(t.creatinine);if(!isNaN(i)){const s=v(i,e,r,t.isBlack);n.result=s}}return n})},required:!0,children:[e.jsx(O,{children:e.jsx(F,{placeholder:"계산식 선택"})}),e.jsxs(L,{children:[e.jsx(V,{value:"cockcroft-gault",children:"Cockcroft-Gault"}),e.jsx(V,{value:"mdrd",children:"MDRD"}),e.jsx(V,{value:"ckd-epi",children:"CKD-EPI"})]})]})]}),e.jsxs("div",{children:[e.jsx(P,{htmlFor:"modal-result",children:"계산 결과"}),e.jsx(se,{id:"modal-result",value:m.result,onChange:e=>{if(m.result&&m.result.includes("=")&&e.target.value!==m.result){if(!window.confirm("자동계산된 데이터를 삭제하고 직접 입력하시겠습니까?"))return}f({...m,result:e.target.value})},placeholder:"자동계산"})]})]}),e.jsxs(Ht,{className:"justify-center sm:justify-center",children:[e.jsx(ie,{type:"button",variant:"outline",onClick:()=>{M(!1),E(null),f({creatinine:"",date:"",formula:"cockcroft-gault",result:"",dialysis:"N",renalReplacement:"",isBlack:!1})},children:"취소"}),e.jsx(ie,{type:"submit",children:_?"수정":"추가"})]})]})]})}),r&&Y()&&e.jsx(H,{open:k,onOpenChange:C,children:e.jsxs(U,{className:"transform scale-[1.5]",children:[e.jsxs(K,{children:[e.jsx(z,{children:e.jsx("div",{className:"text-center",children:"혈중 약물 농도 측정 가이드"})}),e.jsx(B,{children:e.jsxs("div",{className:"text-center",children:[r.name," 환자는 고위험군 환자입니다.",e.jsx("br",{}),"가이드에 맞게 측정되었는지 확인 후 혈중 약물 농도를 입력해 주세요."]})})]}),e.jsxs("div",{className:"flex items-center justify-center space-x-2 mt-4",children:[e.jsxs("div",{className:"border border-gray-200 rounded-lg p-4 bg-accent w-1/2",children:[e.jsx("h2",{className:"font-semibold text-lg text-center mb-2",children:"Check point"}),e.jsxs("ul",{className:"list-disc list-inside text-sm space-y-1",children:[e.jsx("li",{className:"text-white",children:"투석 여부: Y"}),e.jsx("li",{className:"text-white",children:"신 대체요법: CRRT"})]})]}),e.jsx(ge,{className:"h-6 w-6 text-gray-500"}),e.jsxs("div",{className:"border border-gray-200 rounded-lg p-4 bg-accent w-1/2",children:[e.jsx("h2",{className:"font-semibold text-lg text-center mb-2",children:"Guide"}),e.jsx("ul",{className:"text-sm space-y-1 text-center",children:e.jsx("li",{className:"text-white",children:"투약 2시간 후 최고 흡수 농도 측정 권고(C2)"})})]})]}),e.jsx(W,{children:e.jsx("div",{className:"flex justify-center w-full",children:e.jsx(G,{onClick:()=>C(!1),className:"w-[calc(100%)]",children:"확인"})})})]})})]}):e.jsx(Q,{children:e.jsx(re,{className:"py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx(je,{className:"h-16 w-16 text-muted-foreground mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"환자를 먼저 선택해 주세요."})]})})})},zn=({simulationData:t,showSimulation:n,currentPatientName:r,selectedDrug:i,chartTitle:s="용법 조정 시뮬레이션",targetMin:a,targetMax:o,recentAUC:l,recentMax:d,recentTrough:c,predictedAUC:u,predictedMax:m,predictedTrough:f,ipredSeries:p,predSeries:g,observedSeries:h,chartColor:x="pink",tdmIndication:v,tdmTarget:b,tdmTargetValue:j,latestAdministration:N,originalAdministration:w,drugAdministrations:D=[],currentMethodSeries:T=[],isEmptyChart:S=!1,selectedButton:k,isLoading:C=!1,steadyState:I})=>{const[M,R]=y.useState(()=>"undefined"!=typeof window&&document.documentElement.classList.contains("dark"));y.useEffect(()=>{const e=()=>{R(document.documentElement.classList.contains("dark"))};e();const t=new MutationObserver(e);return t.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),()=>t.disconnect()},[]);const $=y.useMemo(()=>S?[]:(null==p?void 0:p.length)||(null==g?void 0:g.length)||(null==h?void 0:h.length)||(null==T?void 0:T.length)?Ie(p,g,h,T):t,[p,g,h,T,t,S]),_=y.useMemo(()=>Me(p,g,h,T),[p,g,h,T]),E=y.useMemo(()=>Re(D,i),[D,i]),P=y.useMemo(()=>$e(D,i),[D,i]),A=y.useMemo(()=>_e($),[$]),O=u??490,F=m??38,L=f??18,V=(null==N?void 0:N.intervalHours)??null,H=(null==N?void 0:N.dose)??null,U=(null==N?void 0:N.unit)||"mg";null==V||V.toLocaleString(),null==H||Number(H).toLocaleString();const K=y.useMemo(()=>Se(b,O,F,L,i),[b,O,F,L,i]),z=y.useMemo(()=>Ee(b,j,O,F,L,i),[b,j,O,F,L,i]),B=y.useMemo(()=>{if(!b)return"";const e=b.toLowerCase();return e.includes("auc")?"AUC":e.includes("max")||e.includes("peak")?"Max":e.includes("trough")?"Trough":""},[b]),W=y.useMemo(()=>{if(!j||!K.numericValue)return null;const e=j.match(/(\d+(?:\.\d+)?)\s*-\s*(\d+(?:\.\d+)?)/);if(!e)return null;const t=parseFloat(e[1]),n=parseFloat(e[2]),r=K.numericValue;return r>n?"초과":r<t?"미달":"도달"},[j,K.numericValue]),G={pink:"#ec4899",green:"#22c55e"}[x],J=y.useMemo(()=>{const e=[];return T&&T.length>0&&e.push({label:"현용법",dataKey:"currentMethod",borderColor:"#3b82f6",borderWidth:2}),e.push({label:"용법 조정 결과",dataKey:"predicted",borderColor:G,borderWidth:2,fill:"Vancomycin"===i&&((null==b?void 0:b.toLowerCase().includes("auc"))||!1)}),h&&h.length>0&&e.push({label:"실제 혈중 농도",dataKey:"observed",borderColor:"#ef4444",backgroundColor:"#ef4444",pointRadius:4,showLine:!1}),"Vancomycin"===i&&(null==b?void 0:b.toLowerCase().includes("auc"))||"number"!=typeof A||e.push({label:"용법조정 평균 농도",dataKey:"averageLine",borderColor:M?"#9ca3af":"#6b7280",borderDash:[5,5],borderWidth:2}),e},[T,G,i,b,h,A,M]);return e.jsxs("div",{className:"w-full",children:[!S&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6 text-gray-800 dark:text-gray-100",children:[e.jsxs("div",{className:"bg-gray-100 dark:bg-gray-800 rounded-lg p-4",children:[e.jsx("span",{className:"block text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wide mb-2",children:"투약 간격"}),e.jsxs("div",{className:"flex items-baseline gap-2",children:[e.jsx("span",{className:"text-3xl font-extrabold text-gray-900 dark:text-white",children:null!=V?V.toLocaleString():"-"}),e.jsx("span",{className:"text-base font-semibold text-gray-700 dark:text-gray-300",children:"시간"})]})]}),e.jsxs("div",{className:"bg-gray-100 dark:bg-gray-800 rounded-lg p-4",children:[e.jsx("span",{className:"block text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wide mb-2",children:"1회 투약 용량"}),e.jsxs("div",{className:"flex items-baseline gap-2",children:[e.jsx("span",{className:"text-3xl font-extrabold text-gray-900 dark:text-white",children:null!=H?Number(H).toLocaleString():"-"}),e.jsx("span",{className:"text-base font-semibold text-gray-700 dark:text-gray-300",children:U})]})]}),e.jsxs("div",{className:"bg-gray-100 dark:bg-gray-800 rounded-lg p-4",children:[e.jsx("span",{className:"block text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wide mb-2",children:"TDM 목표"}),e.jsxs("div",{className:"flex flex-col gap-2",children:[null!=K.numericValue&&W&&e.jsxs("div",{className:"text-xl font-bold",children:[e.jsx("span",{className:""+(z?"text-blue-700 dark:text-blue-200":"text-red-600 dark:text-red-300"),children:K.value}),e.jsxs("span",{className:"text-gray-900 dark:text-white",children:[" ","으로 목표범위 ",W]})]}),e.jsxs("div",{className:"text-sm text-gray-700 dark:text-gray-300",children:["목표 범위 ",B," ",j||"-"]})]})]})]})}),!S&&e.jsxs("div",{className:"flex justify-center flex-wrap gap-6 mb-4",children:[T&&T.length>0&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-0.5 bg-blue-500"}),e.jsxs("span",{className:"text-sm text-gray-600",children:[r||"환자","의 현용법"]})]}),p&&p.length>0&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-0.5",style:{backgroundColor:G}}),e.jsx("span",{className:"text-sm text-gray-600",children:"용법 조정 결과"})]}),h&&h.length>0&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-red-500"}),e.jsx("span",{className:"text-sm text-gray-600",children:"실제 혈중 농도"})]}),!("Vancomycin"===i&&(null==b?void 0:b.toLowerCase().includes("auc")))&&"number"==typeof A&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-0.5 border-dashed border-t-2 border-gray-500"}),e.jsx("span",{className:"text-sm text-gray-600",children:"용법 조정 평균 농도"})]}),null!==a&&null!==o&&o>a&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-4 bg-blue-500 bg-opacity-20"}),e.jsx("span",{className:"text-sm text-gray-600",children:"TDM 목표치"})]})]}),e.jsxs("div",{className:"relative",children:[C&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-white/80 dark:bg-slate-900/80 z-10 rounded-lg",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-lg font-semibold text-gray-700 dark:text-gray-300 mb-2",children:"차트를 그리는 중입니다."}),e.jsx("div",{className:"w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto"})]})}),e.jsx(Pe,{data:$,datasets:J,selectedDrug:i,targetMin:a,targetMax:o,dataTimeExtents:_,lastActualDoseTime:P,drugAdministrations:D,averageConcentration:A,currentTime:E,lastDoseColor:"#3b82f6"})]}),!S&&e.jsx(Ae,{selectedDrug:i,tdmIndication:v,tdmTarget:b,tdmTargetValue:j,latestAdministration:N,originalAdministration:w,recentAUC:l,recentMax:d,recentTrough:c,predictedAUC:O,predictedMax:F,predictedTrough:L,commentTitle:"",currentResultTitle:"현 용법 유지 시",predictedResultTitle:"용법 변경 시",showSteadyStateComment:!1})]})},Bn=(e,t)=>new Date(`${e}T${t}`),Wn=(e,t)=>(e.getTime()-t.getTime())/36e5,Gn=(e,t)=>{try{if(!e)return null;const n=t?`tdmfriends:renal:${e}:${t}`:`tdmfriends:renal:${e}`,r=window.localStorage.getItem(n);if(!r)return null;const i=JSON.parse(r);return i.find(e=>e.isSelected)||i[i.length-1]||null}catch{return null}},Jn=(e,t)=>e&&t?Math.sqrt(t*e/3600):1.73,qn=e=>{if(!e)return e;return(e.charAt(0).toLowerCase()+e.slice(1)).replace(/-/g,"_")},Yn={Vancomycin:{"Not specified/Korean":{default:"Vancomycin1-1",CRRT:"Vancomycin1-2"},"Neurosurgical patients/Korean":{default:"Vancomycin2-1",within72h:"Vancomycin2-2"}},Cyclosporin:{"Renal transplant recipients/Korean":{"POD ~2":"Cyclosporin1-1","POD 3~6":"Cyclosporin1-2","POD 7~":"Cyclosporin1-3",default:"Cyclosporin1-1"},"Allo-HSCT/Korean":"Cyclosporin2","Thoracic transplant recipients/European":"Cyclosporin3"}},Xn=e=>{if(!e||e.length<2)return;const t=[...e].sort((e,t)=>Bn(e.date,e.time).getTime()-Bn(t.date,t.time).getTime()),n=t[t.length-1],r=t[t.length-2],i=Wn(Bn(n.date,n.time),Bn(r.date,r.time));return!Number.isFinite(i)||i<=0?void 0:i},Zn=(e,t,n)=>{try{const r=`tdmfriends:prescription:${e}:${t}`,i={...n,timestamp:Date.now()};window.localStorage.setItem(r,JSON.stringify(i))}catch(r){}},Qn=e=>{if(!e)return 0;const{isIVInfusion:t,infusionTime:n,dose:r}=e;return t&&"number"==typeof n&&n>0?r/(n/60):0},er=e=>{var t;const{patients:n,prescriptions:r,bloodTests:i,drugAdministrations:s,selectedPatientId:a,selectedDrugName:o,overrides:l}=e,d=n.find(e=>e.id===a),c=r.find(e=>e.patientId===a&&(!o||e.drugName===o))||r.find(e=>e.patientId===a);if(!d||!c)return null;const u=d.weight,m=d.age,f="male"===d.gender?1:0,p=d.height,g=((e,t,n,r,i,s)=>{const a={crcl:void 0,egfr:void 0},o=Gn(e,s);if(o){const e=(o.result||"").toString(),s=e.match(/(CRCL|eGFR)\s*=\s*([\d.]+)/i);if(s){const e=s[1].toLowerCase(),t=parseFloat(s[2]);if(!Number.isNaN(t)&&t>0)return a[e]=t,a}const l=parseFloat(e.replace(/[^0-9.-]/g,""));if(!Number.isNaN(l)&&l>0)return a.crcl=l,a;const d=parseFloat((o.creatinine||"").toString());if(!Number.isNaN(d)&&d>0){const e=0===r;if("cockcroft-gault"===o.formula){const r=(140-n)*t/(72*d);return a.crcl=e?.85*r:r,a}if("mdrd"===o.formula){const r=Jn(i,t),s=175*Math.pow(d,-1.154)*Math.pow(n,-.203)*(e?.742:1);return a.egfr=s*(r/1.73),a}if("ckd-epi"===o.formula){const r=Jn(i,t),s=e?.7:.9,o=e?-.329:-.411,l=Math.min(d/s,1),c=Math.max(d/s,1),u=141*Math.pow(l,o)*Math.pow(c,-1.209)*Math.pow(.993,n)*(e?1.018:1);return a.egfr=u*(r/1.73),a}const s=(140-n)*t/(72*d);return a.crcl=e?.85*s:s,a}}return a.crcl=90,a})(a,u,m,f,p,o),h=(s||[]).filter(e=>{const t=e.patientId===a,n=!o||e.drugName===o;return t&&n}),x=((e,t)=>{try{const n=`tdmfriends:prescription:${e}:${t}`,r=window.localStorage.getItem(n);return r?JSON.parse(r):null}catch{return null}})(a,o||c.drugName),v=h.length>0?[...h].sort((e,t)=>Bn(e.date,e.time).getTime()-Bn(t.date,t.time).getTime())[h.length-1]:void 0,b=(null==x?void 0:x.amount)??(v?v.dose:100),j=(null==x?void 0:x.tau)??(null==v?void 0:v.intervalHours)??Xn(h)??12,N=Number.isFinite(j)&&j>0?j:12;let y=(null==x?void 0:x.cmt)??1;if("Vancomycin"===c.drugName){const e=(null==(t=null==x?void 0:x.route)?void 0:t.toLowerCase())||"";if(e.includes("po")||e.includes("oral")||e.includes("경구"))throw new Error("반코마이신은 현재 정맥 투약 모델만 지원됩니다. 처방 정보에서 투약 경로를 정맥으로 변경해주세요.")}const w=(null==l?void 0:l.amount)??b,D=(null==l?void 0:l.tau)??N,T=y,S="Vancomycin"===c.drugName&&"Neurosurgical patients/Korean"===c.indication&&c.additionalInfo&&!["복용 중인 약물 없음","기타"].includes(c.additionalInfo)?1:0,k=(null==v?void 0:v.infusionTime)??(null==x?void 0:x.infusionTime)??0,C=Qn(v),I=k>0?w/(k/60):C,M=[],R=[...h].sort((e,t)=>Bn(e.date,e.time).getTime()-Bn(t.date,t.time).getTime()),$=R.length>0?Bn(R[0].date,R[0].time):new Date;if(R.length>0)for(const P of R){const e=P,t=Math.max(0,Wn(Bn(P.date,P.time),$)),n=Qn(e),r=(e.route||"").toLowerCase(),i=r.includes("po")||r.includes("oral")||r.includes("경구");let s=i?2:1;if("Vancomycin"===c.drugName&&i)throw new Error("반코마이신은 현재 정맥 투약 모델만 지원됩니다. 투약 경로를 정맥으로 변경해주세요.");R.length<=3||P===R[0]||R[R.length-1],M.push({ID:a,TIME:t,DV:null,AMT:P.dose,RATE:n,CMT:s,WT:u,SEX:f,AGE:m,CRCL:g.crcl,EGFR:g.egfr,TOXI:S,EVID:1})}else void 0!==b&&M.push({ID:a,TIME:0,DV:null,AMT:b,RATE:0,CMT:y,WT:u,SEX:f,AGE:m,CRCL:g.crcl,EGFR:g.egfr,TOXI:S,EVID:1});const _=[...o?i.filter(e=>e.patientId===a&&e.drugName===o):i.filter(e=>e.patientId===a)].sort((e,t)=>e.testDate.getTime()-t.testDate.getTime());if(_.length>0)for(const P of _){const e=Wn(P.testDate,$),t=P.concentration;M.push({ID:a,TIME:e,DV:t,AMT:0,RATE:0,CMT:1,WT:u,SEX:f,AGE:m,CRCL:g.crcl,EGFR:g.egfr,TOXI:S,EVID:0})}else M.push({ID:a,TIME:D??2,DV:null,AMT:0,RATE:0,CMT:1,WT:u,SEX:f,AGE:m,CRCL:g.crcl,EGFR:g.egfr,TOXI:S,EVID:0});const E=(e=>{const{patientId:t,drugName:n,indication:r,additionalInfo:i,lastDoseDate:s}=e;if(!n||!r)return;const a=Yn[n];if(!a)return;const o=Gn(t,n),l=/crrt/i.test((null==o?void 0:o.renalReplacement)||""),d=/crrt/i.test(i||""),c=l||d,u=!!s&&((new Date).getTime()-s.getTime())/36e5<=72,m=a[r];if(m){if("string"==typeof m)return qn(m);if("Vancomycin"===n){if("Not specified/Korean"===r&&"기타"===i)throw new Error("CRRT 분석 모델만 지원됩니다.");return c&&m.CRRt?qn(m.CRRt):c&&m.CRRT?qn(m.CRRT):u&&m.within72h?qn(m.within72h):qn(m.default)}if("Cyclosporin"===n){const e=null==i?void 0:i.trim(),t=e&&m[e]||m.default;return t?qn(t):void 0}return"string"==typeof m.default?qn(m.default):void 0}})({patientId:a,drugName:c.drugName,indication:c.indication,additionalInfo:c.additionalInfo,lastDoseDate:v?Bn(v.date,v.time):void 0});return{input_WT:u,input_CRCL:g.crcl,input_EGFR:g.egfr,input_AGE:m,input_SEX:f,input_TOXI:S,input_tau_before:N,input_amount_before:b,input_rate_before:C,input_cmt_before:y,input_tau_after:D,input_amount_after:w,input_rate_after:I,input_cmt_after:T,model_name:E,dataset:M}},tr=e=>{var t;const n=e.message.toLowerCase(),r=(null==(t=e.name)?void 0:t.toLowerCase())||"";return!!n.includes("503")||!!(n.includes("cors")||n.includes("failed to fetch")||n.includes("networkerror")||n.includes("network error")||"typeerror"===r||"networkerror"===r)},nr=async e=>{const{body:t,persist:n,patientId:r,drugName:i,retries:s=3}=e;let a=null;for(let m=0;m<s;m++)try{const e=await fetch("https://b74ljng162.apigw.ntruss.com/tdm/prod/",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(503===e.status&&m<s-1){const e=Math.min(1e3*Math.pow(2,m),5e3);await new Promise(t=>setTimeout(t,e));continue}if(!e.ok){let t=`TDM API 오류: HTTP ${e.status}`;try{const n=await e.text();if(n)try{const r=JSON.parse(n);t=`TDM API 오류 (HTTP ${e.status}): ${JSON.stringify(r)}`}catch{t=`TDM API 오류 (HTTP ${e.status}): ${n.substring(0,200)}`}}catch(l){}throw new Error(t)}const a=await e.json();if(n&&r)try{const e=JSON.stringify(a),n=new Blob([e]).size;if(n>4194304)return a;if(window.localStorage.setItem(`tdmfriends:tdmResult:${r}`,e),i){const n=`tdmfriends:tdmResults:${r}:${i}`,s=window.localStorage.getItem(n),o=s?JSON.parse(s):[],l=t,u={id:`${Date.now()}`,timestamp:(new Date).toISOString(),model_name:null==l?void 0:l.model_name,summary:a,dataset:(null==l?void 0:l.dataset)||[],data:a};o.push(u),o.length>5&&(o.sort((e,t)=>new Date(e.timestamp).getTime()-new Date(t.timestamp).getTime()),o.splice(0,o.length-5));try{const t=JSON.stringify(o);window.localStorage.setItem(n,t),window.localStorage.setItem(`tdmfriends:tdmResult:${r}:${i}`,e)}catch(d){if(!(d instanceof Error&&"QuotaExceededError"===d.name))throw d;if(o.length>2){o.sort((e,t)=>new Date(e.timestamp).getTime()-new Date(t.timestamp).getTime()),o.splice(0,2);try{window.localStorage.setItem(n,JSON.stringify(o)),window.localStorage.setItem(`tdmfriends:tdmResult:${r}:${i}`,e)}catch(c){}}}}}catch(l){l instanceof Error&&l.name}return a}catch(u){a=u;const e=a.message.toLowerCase(),t=a.name||"",n=e.includes("cors")||e.includes("access-control-allow-origin")||u instanceof TypeError&&(e.includes("failed to fetch")||e.includes("networkerror")||"TypeError"===t),r=e.includes("failed to fetch")||e.includes("networkerror")||e.includes("network error")||"TypeError"===t||"NetworkError"===t;e.includes("503");if(n||r){a=new Error(`${n?"CORS 오류":"네트워크 오류"}: TDM 서버에 접근할 수 없습니다.\n\n오류 상세:\n- 오류 유형: ${t}\n- 오류 메시지: ${a.message}\n\n가능한 원인:\n- 서버의 CORS 설정 문제\n- 네트워크 연결 문제\n- 서버가 일시적으로 사용 불가능한 상태\n\n서버 관리자에게 문의하거나 잠시 후 다시 시도해주세요.`)}if(!tr(a))throw u;if(m<s-1){const e=Math.min(1e3*Math.pow(2,m),5e3);await new Promise(t=>setTimeout(t,e));continue}}const o=a||new Error("TDM API 호출 실패: 모든 재시도 실패");throw o.message.includes("CORS 오류")||o.message.includes("네트워크 오류"),o},rr=[{name:"Vancomycin",indications:["Not specified/Korean","Neurosurgical patients/Korean"],targets:[{type:"Trough Concentration",value:"10-20 mg/L"},{type:"Peak Concentration",value:"25-40 mg/L"},{type:"AUC",value:"400-600 mg·h/L"}],defaultTargets:{"Not specified/Korean":{type:"AUC",value:"400-600 mg·h/L"},"Neurosurgical patients/Korean":{type:"AUC",value:"400-600 mg·h/L"}}},{name:"Cyclosporin",indications:["Renal transplant recipients/Korean","Allo-HSCT/Korean","Thoracic transplant recipients/European"],targets:[{type:"Trough Concentration",value:"100-400 ng/mL"},{type:"Peak Concentration",value:"800-1200 ng/mL"}],defaultTargets:{"Allo-HSCT/Korean":{type:"Trough Concentration",value:"150-400 ng/mL"},"Thoracic transplant recipients/European":{type:"Trough Concentration",value:"170-230 ng/mL"},"Renal transplant recipients/Korean":{type:"Trough Concentration",value:"100-400 ng/mL"}}}],ir=({patients:t,prescriptions:n,bloodTests:r,selectedPatient:i,selectedPrescription:s,drugAdministrations:a=[],onDownloadPDF:o,forceExpandPatientDetails:l=!1})=>{var d,c;const[u,m]=y.useState((null==i?void 0:i.id)||""),[f,p]=y.useState((null==s?void 0:s.drugName)||""),g=i&&s?a.filter(e=>e.patientId===i.id&&e.drugName===s.drugName):[],h=y.useMemo(()=>{if(0===g.length)return null;const e=[...g].sort((e,t)=>new Date(`${e.date}T${e.time}`).getTime()-new Date(`${t.date}T${t.time}`).getTime()),t=e[e.length-1];let n=t.intervalHours;if(!n){if(null==s?void 0:s.frequency){const e=s.frequency.match(/\d+/);e&&(n=parseInt(e[0],10))}!n&&g.length>=2&&(n=Xn(g))}return{dose:t.dose,unit:t.unit,intervalHours:n}},[g,s]),[x,v]=y.useState({dose:"",halfLife:"",clearance:"",volumeDistribution:""}),[b,j]=y.useState(!1);y.useRef(null),y.useState("250"),y.useState(""),y.useState("mg"),y.useState(""),y.useState("6"),y.useState("current");const[N,w]=y.useState(null),[D,T]=y.useState([]),[S,k]=y.useState([]),[C,I]=y.useState([]),[M,R]=y.useState(null);y.useState(null),y.useState(null);const[$,_]=y.useState(null),[E,P]=y.useState(null),[A,O]=y.useState(void 0),[F,L]=y.useState([]),[V,q]=y.useState({}),[Y,X]=y.useState({}),[Z,Q]=y.useState({}),[ee,te]=y.useState({}),[ne,re]=y.useState(!1),[ae,oe]=y.useState(!1),[le,de]=y.useState({}),[ce,ue]=y.useState(null),[me,fe]=y.useState({}),[pe,ge]=y.useState({}),[he,xe]=y.useState({}),[ve,be]=y.useState({}),[je,Ne]=y.useState({}),ye=y.useRef({}),we=y.useRef(null),[De,Te]=y.useState({}),[ke,Ce]=y.useState({}),[Ie,Me]=y.useState({}),[Re,$e]=y.useState({}),_e=t.find(e=>e.id===u),Pe=y.useMemo(()=>u?n.filter(e=>e.patientId===u):[],[u,n]),Ae=y.useMemo(()=>u?r.filter(e=>e.patientId===u&&(!s||e.drugName===s.drugName)):[],[u,s,r]),Le=y.useCallback(e=>{var t,n,r,i,s,a,o,l,d;const c=Pe.find(t=>t.drugName===e),u=rr.find(t=>t.name===e);return{indication:(null==c?void 0:c.indication)||(null==(t=null==u?void 0:u.indications)?void 0:t[0])||"적응증",target:(null==c?void 0:c.tdmTarget)||(null==(r=null==(n=null==u?void 0:u.defaultTargets)?void 0:n[(null==c?void 0:c.indication)||""])?void 0:r.type)||(null==(s=null==(i=null==u?void 0:u.targets)?void 0:i[0])?void 0:s.type)||"목표 유형",targetValue:(null==c?void 0:c.tdmTargetValue)||(null==(o=null==(a=null==u?void 0:u.defaultTargets)?void 0:a[(null==c?void 0:c.indication)||""])?void 0:o.value)||(null==(d=null==(l=null==u?void 0:u.targets)?void 0:l[0])?void 0:d.value)||"목표값",dosage:(null==c?void 0:c.dosage)||0,unit:(null==c?void 0:c.unit)||"mg",frequency:(null==c?void 0:c.frequency)||"시간"}},[Pe]),Ve=y.useMemo(()=>Array.from(new Set([...Pe.map(e=>e.drugName),...Ae.map(e=>e.drugName)])),[Pe,Ae]);y.useEffect(()=>{(null==s?void 0:s.drugName)&&p(s.drugName)},[null==s?void 0:s.drugName]),y.useEffect(()=>{Ve.length>0&&!f&&p(Ve[0])},[Ve,f]);const He=y.useMemo(()=>f?Ae.filter(e=>e.drugName===f):[],[f,Ae]),Ue=Ae.length>0?[...Ae].sort((e,t)=>new Date(t.testDate).getTime()-new Date(e.testDate).getTime())[0]:null;(()=>{var e;if(!x.dose||!x.halfLife)return[];const t=parseFloat(x.dose),n=.693/parseFloat(x.halfLife),r=[];for(let i=0;i<=24;i+=.5){const s=t*Math.exp(-n*i);r.push({time:i,predicted:s,observed:(null==(e=He.find(e=>Math.abs(e.timeAfterDose-i)<.5))?void 0:e.concentration)||null})}})();(()=>{var e;if(He.length<2)return null;const t=[...He].sort((e,t)=>e.timeAfterDose-t.timeAfterDose),n=t[0],r=t[t.length-1];if(n.timeAfterDose===r.timeAfterDose)return null;const i=Math.log(n.concentration/r.concentration)/(r.timeAfterDose-n.timeAfterDose),s=.693/i,a=He.reduce((e,t,n)=>{if(0===n)return 0;const r=He[n-1];return e+(t.concentration+r.concentration)*(t.timeAfterDose-r.timeAfterDose)/2},0);s.toFixed(2),i.toFixed(4),a.toFixed(2),Math.max(...He.map(e=>e.concentration)).toFixed(2),null==(e=He.find(e=>e.concentration===Math.max(...He.map(e=>e.concentration))))||e.timeAfterDose.toFixed(1)})();const Ke=(e,t)=>{var n,r,i;q(n=>({...n,[e]:t})),fe(t=>({...t,[e]:!0})),(null==(n=Re[e])?void 0:n.currentMethodSeries)&&0!==(null==(r=Re[e])?void 0:r.currentMethodSeries.length)||st(e);const s=parseFloat(t.replace(/[^0-9.]/g,"")),a=null==(i=null==De?void 0:De[e])?void 0:i[s];if(a&&a.data)return Ce(t=>({...t,[e]:a.data})),Me(t=>({...t,[e]:tt(a.data,a.dataset||[])})),$e(t=>{var n,r,i;return{...t,[e]:{ipredSeries:((null==(n=a.data)?void 0:n.IPRED_CONC)||[]).map(e=>({time:Number(e.time)||0,value:Number(e.IPRED??0)||0})).filter(e=>e.time>=0),predSeries:((null==(r=a.data)?void 0:r.PRED_CONC)||[]).map(e=>({time:Number(e.time)||0,value:Number(e.PRED??e.IPRED??0)||0})).filter(e=>e.time>=0),observedSeries:(a.dataset||[]).filter(e=>0===e.EVID&&null!=e.DV).map(e=>({time:Number(e.TIME)||0,value:Number(e.DV)})).filter(e=>e.time>=0),currentMethodSeries:(null==(i=t[e])?void 0:i.currentMethodSeries)||[]}}}),void ge(t=>({...t,[e]:!1}));nt(e,s)};we.current=Ke;const ze=e=>{const t=e.match(/([0-9]+(?:\.[0-9]+)?)/);if(t){const n=Number(t[1]);if(!Number.isNaN(n))return e.includes("주")?24*n*7:n}return null},Be=(e,t)=>{var n,r;X(n=>({...n,[e]:t})),fe(t=>({...t,[e]:!0})),(null==(n=Re[e])?void 0:n.currentMethodSeries)&&0!==(null==(r=Re[e])?void 0:r.currentMethodSeries.length)||st(e);try{const n=ze(t);if("number"==typeof n&&Number.isFinite(n)){te(t=>({...t,[e]:String(n)}));const t=F.find(t=>t.id===e);if("dosageAndInterval"===(null==t?void 0:t.type)){const t=V[e];if(t){const r=parseFloat(t.replace(/[^0-9.]/g,""));isNaN(r)||rt(e,r,n)}}else it(e,n)}}catch{}},We=(e,t)=>{te(n=>({...n,[e]:t}))},Ge=e=>{var t,n;const r=(ee[e]??"").trim();if(""===r)return void window.alert("투약 간격을 입력해주세요.");const i=Number(r);if(!Number.isFinite(i)||i<=0)return void window.alert("유효한 숫자를 입력해주세요.");const s=Number.isInteger(i)&&i>=1?String(i):i.toString(),a=`직접 입력 (${s}시간)`;(null==(t=Re[e])?void 0:t.currentMethodSeries)&&0!==(null==(n=Re[e])?void 0:n.currentMethodSeries.length)||st(e);const o=F.find(t=>t.id===e);if("dosageAndInterval"===(null==o?void 0:o.type)){X(t=>({...t,[e]:a})),fe(t=>({...t,[e]:!0})),te(t=>({...t,[e]:s}));const t=V[e];if(t){const n=parseFloat(t.replace(/[^0-9.]/g,""));isNaN(n)||rt(e,n,i)}}else Be(e,a),te(t=>({...t,[e]:s}))},Je=(e,t)=>{var n,r;const i=`${Number(t).toLocaleString()}mg`;Q(n=>({...n,[e]:String(t)})),(null==(n=Re[e])?void 0:n.currentMethodSeries)&&0!==(null==(r=Re[e])?void 0:r.currentMethodSeries.length)||st(e);const s=F.find(t=>t.id===e);if("dosageAndInterval"===(null==s?void 0:s.type)){q(t=>({...t,[e]:i})),fe(t=>({...t,[e]:!0}));const n=Y[e];if(n){const r=ze(n);"number"==typeof r&&Number.isFinite(r)&&rt(e,t,r)}}else Ke(e,i)},qe=(e,t)=>{Q(n=>({...n,[e]:t}))},Ye=e=>{var t,n;const r=(Z[e]??"").trim();if(""===r)return void window.alert("투약 용량을 입력해주세요.");const i=Number(r);if(!Number.isFinite(i)||i<=0)return void window.alert("유효한 숫자를 입력해주세요.");const s=`${Number(i).toLocaleString()}mg`;(null==(t=Re[e])?void 0:t.currentMethodSeries)&&0!==(null==(n=Re[e])?void 0:n.currentMethodSeries.length)||st(e);const a=F.find(t=>t.id===e);if("dosageAndInterval"===(null==a?void 0:a.type)){q(t=>({...t,[e]:s})),fe(t=>({...t,[e]:!0})),Q(t=>({...t,[e]:String(i)}));const t=Y[e];if(t){const n=ze(t);"number"==typeof n&&Number.isFinite(n)&&rt(e,i,n)}}else Ke(e,s),Q(t=>({...t,[e]:String(i)}))},Xe=y.useMemo(()=>[{label:"2시간",helper:"q2h"},{label:"3시간",helper:"q3h"},{label:"4시간",helper:"q4h"},{label:"6시간",helper:"q6h"},{label:"8시간",helper:"q8h"},{label:"12시간",helper:"q12h"},{label:"24시간",helper:"매일"},{label:"48시간",helper:"이틀 간격"},{label:"1주",helper:"주 1회"},{label:"2주",helper:"격주"},{label:"4주",helper:"매 4주"},{label:"6주",helper:"6주마다"},{label:"8주",helper:"8주마다"}],[]),Ze=y.useMemo(()=>"Vancomycin"===f?[125,250,375,500,625,750,875,1e3,1125]:"Cyclosporin"===f?[25,50,75,100,125,150,175,200,225,250,275,300,325,350]:[],[f]);y.useCallback(()=>{try{if(!u)return null;const e=window.localStorage.getItem(`tdmfriends:renal:${u}`);if(!e)return null;const t=JSON.parse(e);return t.find(e=>e.isSelected)||t[t.length-1]||null}catch{return null}},[u]);const Qe=(e,t)=>new Date(`${e}T${t}`),et=y.useCallback((e,t)=>{try{const n=(null==e?void 0:e.IPRED_CONC)||[],r=(null==e?void 0:e.PRED_CONC)||[],i=Array.isArray(n)?n.length:0,s=Array.isArray(r)?r.length:0,a=Array.isArray(t)?t.filter(e=>0===e.EVID&&null!=e.DV).length:0,o=Math.max(i,s);return o+a>=5e4}catch{return!1}},[]),tt=y.useCallback((e,t)=>{try{const n=(null==e?void 0:e.IPRED_CONC)||[],r=(null==e?void 0:e.PRED_CONC)||[],i=new Map,s=e=>{const t=Number(e)||0,n=i.get(t);if(n)return n;const r={time:t,predicted:0,observed:null,controlGroup:0};return i.set(t,r),r};for(const e of n){const t=Number(e.time)||0,n=Number(e.IPRED??0)||0;s(t).predicted=n}for(const e of r){const t=Number(e.time)||0,n=Number(e.PRED??e.IPRED??0)||0;s(t).controlGroup=n}if(t&&t.length>0)for(const e of t)if(0===e.EVID&&null!=e.DV){const t=Number(e.TIME)||0,n=Number(e.DV);s(t).observed=n}return Array.from(i.values()).sort((e,t)=>e.time-t.time)}catch{return[]}},[]);y.useCallback(async e=>{try{if(!u||!f)return;j(!1);const i=er({patients:t,prescriptions:n,bloodTests:r,drugAdministrations:a,selectedPatientId:u,selectedDrugName:f,overrides:{amount:e}});if(!i)return;const s=await nr({body:i,persist:!0,patientId:u,drugName:f});w(s);const o=i.dataset||[];if(o.length>0&&void 0!==o[0].TOXI&&O(o[0].TOXI),et(s,o))return void oe(!0);T(tt(s,i.dataset||[])),R({ipredSeries:((null==s?void 0:s.IPRED_CONC)||[]).map(e=>({time:Number(e.time)||0,value:Number(e.IPRED??0)||0})).filter(e=>e.time>=0),predSeries:((null==s?void 0:s.PRED_CONC)||[]).map(e=>({time:Number(e.time)||0,value:Number(e.IPRED??0)||0})).filter(e=>e.time>=0),observedSeries:(i.dataset||[]).filter(e=>0===e.EVID&&null!=e.DV).map(e=>({time:Number(e.TIME)||0,value:Number(e.DV)})).filter(e=>e.time>=0),currentMethodSeries:((null==s?void 0:s.PRED_CONC)||[]).map(e=>({time:Number(e.time)||0,value:Number(e.IPRED??0)||0})).filter(e=>e.time>=0)});try{const e=`tdmfriends:tdmExtraSeries:${u}:${f}`;window.localStorage.setItem(e,JSON.stringify({ipredSeries:(null==s?void 0:s.IPRED_CONC).map(e=>({time:Number(e.time)||0,value:Number(e.IPRED??0)||0})).filter(e=>e.time>=0),predSeries:(null==s?void 0:s.PRED_CONC).map(e=>({time:Number(e.time)||0,value:Number(e.IPRED??0)||0})).filter(e=>e.time>=0),observedSeries:(i.dataset||[]).filter(e=>0===e.EVID&&null!=e.DV).map(e=>({time:Number(e.TIME)||0,value:Number(e.DV)})).filter(e=>e.time>=0),currentMethodSeries:(null==s?void 0:s.PRED_CONC).map(e=>({time:Number(e.time)||0,value:Number(e.IPRED??0)||0})).filter(e=>e.time>=0)}))}catch{}j(!0)}catch(i){}},[t,n,r,a,u,f,tt]);const nt=y.useCallback(async(e,i)=>{try{if(!u||!f)return;ge(t=>({...t,[e]:!0}));const s=er({patients:t,prescriptions:n,bloodTests:r,drugAdministrations:a,selectedPatientId:u,selectedDrugName:f,overrides:{amount:i}});if(!s)return;const o=await nr({body:s,persist:!1,patientId:u,drugName:f});Ce(t=>({...t,[e]:o})),Me(t=>({...t,[e]:tt(o,s.dataset||[])})),$e(t=>{var n;return{...t,[e]:{ipredSeries:((null==o?void 0:o.IPRED_CONC)||[]).map(e=>({time:Number(e.time)||0,value:Number(e.IPRED??0)||0})).filter(e=>e.time>=0),predSeries:((null==o?void 0:o.PRED_CONC)||[]).map(e=>({time:Number(e.time)||0,value:Number(e.PRED??e.IPRED??0)||0})).filter(e=>e.time>=0),observedSeries:(s.dataset||[]).filter(e=>0===e.EVID&&null!=e.DV).map(e=>({time:Number(e.TIME)||0,value:Number(e.DV)})).filter(e=>e.time>=0),currentMethodSeries:(null==(n=t[e])?void 0:n.currentMethodSeries)||[]}}}),ge(t=>({...t,[e]:!1}))}catch(s){ge(t=>({...t,[e]:!1}))}},[t,n,r,a,u,f,tt,et]);y.useCallback(async e=>{try{if(!u||!f)return;j(!1);const i=er({patients:t,prescriptions:n,bloodTests:r,drugAdministrations:a,selectedPatientId:u,selectedDrugName:f,overrides:{tau:e}});if(!i)return;const s=await nr({body:i,persist:!0,patientId:u,drugName:f});if(w(s),et(s,i.dataset||[]))return void oe(!0);T(tt(s,i.dataset||[])),R({ipredSeries:((null==s?void 0:s.IPRED_CONC)||[]).map(e=>({time:Number(e.time)||0,value:Number(e.IPRED??0)||0})).filter(e=>e.time>=0),predSeries:((null==s?void 0:s.PRED_CONC)||[]).map(e=>({time:Number(e.time)||0,value:Number(e.IPRED??0)||0})).filter(e=>e.time>=0),observedSeries:(i.dataset||[]).filter(e=>0===e.EVID&&null!=e.DV).map(e=>({time:Number(e.TIME)||0,value:Number(e.DV)})).filter(e=>e.time>=0),currentMethodSeries:((null==s?void 0:s.PRED_CONC)||[]).map(e=>({time:Number(e.time)||0,value:Number(e.IPRED??0)||0})).filter(e=>e.time>=0)});try{const e=`tdmfriends:tdmExtraSeries:${u}:${f}`;window.localStorage.setItem(e,JSON.stringify({ipredSeries:(null==s?void 0:s.IPRED_CONC).map(e=>({time:Number(e.time)||0,value:Number(e.IPRED??0)||0})).filter(e=>e.time>=0),predSeries:(null==s?void 0:s.PRED_CONC).map(e=>({time:Number(e.time)||0,value:Number(e.IPRED??0)||0})).filter(e=>e.time>=0),observedSeries:(i.dataset||[]).filter(e=>0===e.EVID&&null!=e.DV).map(e=>({time:Number(e.TIME)||0,value:Number(e.DV)})).filter(e=>e.time>=0),currentMethodSeries:(null==s?void 0:s.PRED_CONC).map(e=>({time:Number(e.time)||0,value:Number(e.IPRED??0)||0})).filter(e=>e.time>=0)}))}catch{}j(!0)}catch(i){}},[t,n,r,a,u,f,tt]);const rt=y.useCallback(async(e,i,s)=>{try{if(!u||!f)return;ge(t=>({...t,[e]:!0}));const o=er({patients:t,prescriptions:n,bloodTests:r,drugAdministrations:a,selectedPatientId:u,selectedDrugName:f,overrides:{amount:i,tau:s}});if(!o)return;const l=await nr({body:o,persist:!1,patientId:u,drugName:f});Ce(t=>({...t,[e]:l})),Me(t=>({...t,[e]:tt(l,o.dataset||[])})),$e(t=>{var n;return{...t,[e]:{ipredSeries:((null==l?void 0:l.IPRED_CONC)||[]).map(e=>({time:Number(e.time)||0,value:Number(e.IPRED??0)||0})).filter(e=>e.time>=0),predSeries:((null==l?void 0:l.PRED_CONC)||[]).map(e=>({time:Number(e.time)||0,value:Number(e.PRED??e.IPRED??0)||0})).filter(e=>e.time>=0),observedSeries:(o.dataset||[]).filter(e=>0===e.EVID&&null!=e.DV).map(e=>({time:Number(e.TIME)||0,value:Number(e.DV)})).filter(e=>e.time>=0),currentMethodSeries:(null==(n=t[e])?void 0:n.currentMethodSeries)||[]}}}),ge(t=>({...t,[e]:!1}))}catch(o){ge(t=>({...t,[e]:!1}))}},[t,n,r,a,u,f,tt,et]),it=y.useCallback(async(e,i)=>{try{if(!u||!f)return;ge(t=>({...t,[e]:!0}));const s=er({patients:t,prescriptions:n,bloodTests:r,drugAdministrations:a,selectedPatientId:u,selectedDrugName:f,overrides:{tau:i}});if(!s)return;const o=await nr({body:s,persist:!1,patientId:u,drugName:f});Ce(t=>({...t,[e]:o})),Me(t=>({...t,[e]:tt(o,s.dataset||[])})),$e(t=>{var n;return{...t,[e]:{ipredSeries:((null==o?void 0:o.IPRED_CONC)||[]).map(e=>({time:Number(e.time)||0,value:Number(e.IPRED??0)||0})).filter(e=>e.time>=0),predSeries:((null==o?void 0:o.PRED_CONC)||[]).map(e=>({time:Number(e.time)||0,value:Number(e.PRED??e.IPRED??0)||0})).filter(e=>e.time>=0),observedSeries:(s.dataset||[]).filter(e=>0===e.EVID&&null!=e.DV).map(e=>({time:Number(e.TIME)||0,value:Number(e.DV)})).filter(e=>e.time>=0),currentMethodSeries:(null==(n=t[e])?void 0:n.currentMethodSeries)||[]}}}),ge(t=>({...t,[e]:!1}))}catch(s){ge(t=>({...t,[e]:!1}))}},[t,n,r,a,u,f,tt,et]),st=y.useCallback(async e=>{if(u&&f){ge(t=>({...t,[e]:!0}));try{const i=er({patients:t,prescriptions:n,bloodTests:r,drugAdministrations:a,selectedPatientId:u,selectedDrugName:f,overrides:void 0});if(!i)return;const s=await nr({body:i,persist:!1,patientId:u,drugName:f});Me(t=>({...t,[e]:tt(s,i.dataset||[])}));const o=((null==s?void 0:s.IPRED_CONC)||[]).map(e=>({time:Number(e.time)||0,value:Number(e.IPRED??0)||0})).filter(e=>e.time>=0),l=(i.dataset||[]).filter(e=>0===e.EVID&&null!=e.DV).map(e=>({time:Number(e.TIME)||0,value:Number(e.DV)})).filter(e=>e.time>=0);if($e(t=>{var n,r;return{...t,[e]:{ipredSeries:(null==(n=t[e])?void 0:n.ipredSeries)||[],predSeries:(null==(r=t[e])?void 0:r.predSeries)||[],observedSeries:l,currentMethodSeries:o}}}),Ce(t=>({...t,[e]:s})),h){const t=h.dose,n=h.unit||"mg",r=`${Number(t).toLocaleString()}${n}`;if(q(t=>({...t,[e]:r})),h.intervalHours){const t=h.intervalHours,n=Xe.find(e=>ze(e.label)===t);if(n)X(t=>({...t,[e]:n.label}));else{const n=Number.isInteger(t)&&t>=1?String(t):t.toString(),r=`직접 입력 (${n}시간)`;X(t=>({...t,[e]:r})),te(t=>({...t,[e]:n}))}}}fe(t=>({...t,[e]:!0}))}catch(i){}finally{ge(t=>({...t,[e]:!1}))}}},[t,n,r,a,u,f,tt,et,h,Xe]),at=y.useCallback(async e=>{try{be(t=>({...t,[e]:!0})),Ne(t=>({...t,[e]:!1}));const s=_e;if(!s)return;const o=Pe.find(e=>e.drugName===f)||Pe[0];if(!o)return;const l=(o.drugName||"").toLowerCase();let d=10;if("cyclosporin"===l||"cyclosporine"===l){let e=null;try{const t=s?`tdmfriends:conditions:${s.id}`:null;if(t){const n=window.localStorage.getItem(t);if(n){const t=JSON.parse(n).find(e=>"경구"===e.route||"oral"===e.route);e=(null==t?void 0:t.dosageForm)||null}}}catch(i){}d=e&&"capsule/tablet"===e.toLowerCase()?25:10}const c=(a||[]).filter(e=>e.patientId===s.id&&e.drugName===o.drugName),u=c.length>0?[...c].sort((e,t)=>Qe(e.date,e.time).getTime()-Qe(t.date,t.time).getTime())[c.length-1]:void 0,m=Number((null==u?void 0:u.dose)||o.dosage||100),p=(o.tdmTarget||"").toLowerCase(),g=(o.tdmTargetValue||"").match(/\d+\.?\d*/g)||[],h=g[0]?parseFloat(g[0]):void 0,x=g[1]?parseFloat(g[1]):void 0;if(!er({patients:t,prescriptions:n,bloodTests:r,drugAdministrations:a,selectedPatientId:s.id,selectedDrugName:o.drugName}))return;const v=(e,t,n)=>{if(!e)return Number.POSITIVE_INFINITY;const r=Number(((null==e?void 0:e.CTROUGH_after)??(null==e?void 0:e.CTROUGH_before))||0),i=Number(((null==e?void 0:e.AUC_24_after)??(null==e?void 0:e.AUC_24_before))||0);let s=0;if(p.includes("auc")&&(t||n)){const e=i||0,r=t??e,a=n??e;s=e<r?r-e:e>a?e-a:0}else if((p.includes("trough")||p.includes("cmax"))&&(t||n)){const e=r||0,i=t??e,a=n??e;s=e<i?i-e:e>a?e-a:0}else s=Math.abs((r||0)-((null==N?void 0:N.CTROUGH_before)||0));return s},b=e=>{if(!e)return null;return Se(o.tdmTarget,e.AUC_24_after??e.AUC_24_before??null,e.CMAX_after??e.CMAX_before??null,e.CTROUGH_after??e.CTROUGH_before??null,o.drugName).numericValue},j=e=>!!e&&Ee(o.tdmTarget,o.tdmTargetValue,e.AUC_24_after??e.AUC_24_before??null,e.CMAX_after??e.CMAX_before??null,e.CTROUGH_after??e.CTROUGH_before??null,o.drugName),y=e=>{if(!e||!h||!x)return Number.POSITIVE_INFINITY;const t=b(e);return null===t?Number.POSITIVE_INFINITY:t>=h&&t<=x?0:t<h?h-t:t-x},w=async(e,i=3)=>{const l=er({patients:t,prescriptions:n,bloodTests:r,drugAdministrations:a,selectedPatientId:s.id,selectedDrugName:o.drugName,overrides:{amount:e}});try{const t=await nr({body:l,retries:i});return{amt:e,score:v(t,h,x),resp:t,dataset:(null==l?void 0:l.dataset)||[]}}catch(d){return{amt:e,score:Number.POSITIVE_INFINITY,resp:null,dataset:(null==l?void 0:l.dataset)||[]}}},D=5,[T,S]=await Promise.all([w(Math.max(1,m+d),D),w(Math.max(1,m-d),D)]);if(null===T.resp||null===S.resp)return Ne(t=>({...t,[e]:!0})),void be(t=>({...t,[e]:!1}));Ne(t=>({...t,[e]:!1}));const k=m+d,C=m-d,I=b(T.resp),M=b(S.resp);let R=null;if(null!==I&&null!==M&&d>0){const e=k-C;0!==e&&(R=(I-M)/e)}let $=null,_=null;if(null!==R&&void 0!==h&&void 0!==x&&null!==M&&Math.abs(R)>1e-4){const e=(h-M)/R;$=Math.max(1,C+e);const t=(x-M)/R;_=Math.max(1,C+t),$=Math.round($/d)*d,_=Math.round(_/d)*d}let E=m,P=1;if(null!==$&&null!==_)E=Math.min($,_),P=1;else{const e=y(T.resp),t=y(S.resp);P=e<t?1:-1}const A=[T,S],O=[];for(const e of A)j(e.resp)&&O.push(e);const F=Math.round((E-m)/d),L=new Set([1,-1]);let V=F;const H=3;let U=O.length>0,K=0;const z=20;for(;K++,!(K>z);){const t=[];for(let e=0;e<H;e++){const n=V+e*P;L.has(n)||t.push(n)}if(0===t.length){if(V+=H*P,Math.abs(V)>50)break;continue}const n=t.map(e=>Math.max(1,m+e*d)).filter(e=>e>0);if(0===n.length)break;const r=await Promise.all(n.map(e=>w(e))),i=[];for(let e=0;e<r.length;e++)null===r[e].resp&&i.push(w(r[e].amt).then(t=>{r[e]=t}));i.length>0&&await Promise.all(i);for(const e of t)L.add(e);A.push(...r);const s=[...r].sort((e,t)=>1===P?e.amt-t.amt:t.amt-e.amt);let a=!1,o=-1,l=-1;const c=[],u=[];for(let e=0;e<s.length;e++){const t=s[e],n=j(t.resp);c.push({amt:t.amt,inRange:n}),n&&(O.push(t),u.push(t),-1===o&&(o=e,U=!0),l=e,a=!0)}if(u.length>0&&(xe(t=>{const n=t[e]||[],r=u.map(e=>e.amt),i=[...new Set([...n,...r])].sort((e,t)=>e-t);return{...t,[e]:i}}),Te(t=>{const n={...t||{}};n[e]=n[e]||{};for(const r of u)r&&r.resp&&(n[e][r.amt]={data:r.resp,dataset:r.dataset});return n}),O.length===u.length)){const t=u.sort((e,t)=>e.amt-t.amt)[0].amt;setTimeout(()=>{we.current&&we.current(e,`${t}mg`)},100)}if(u.length,U){if(!a)break;{const e=s[s.length-1];if(!j(e.resp))break;V+=H*P}}else V+=H*P}const B=O.length>0?O.sort((e,t)=>e.amt-t.amt):A.sort((e,t)=>e.score-t.score).slice(0,6),W=B.map(e=>e.amt).sort((e,t)=>e-t);if(xe(t=>({...t,[e]:W})),Te(t=>{const n={...t||{}};n[e]=n[e]||{};for(const r of B)r&&r.resp&&(n[e][r.amt]={data:r.resp,dataset:r.dataset});return n}),W.length>0){let t=!1;if(q(n=>{if(n[e])return n;t=!0;const r=W[0];return{...n,[e]:`${r}mg`}}),t){const t=W[0];setTimeout(()=>{we.current&&we.current(e,`${t}mg`)},100)}}}catch(i){}finally{be(t=>({...t,[e]:!1}))}},[t,n,r,a,_e,f,Pe,N,tt]),ot=y.useCallback(e=>{var t;try{(null==(t=ye.current)?void 0:t[e])&&window.clearTimeout(ye.current[e]);const n=window.setTimeout(()=>{at(e)},250);ye.current[e]=n}catch{at(e)}},[at]),lt=y.useCallback(e=>u?er({patients:t,prescriptions:n,bloodTests:r,drugAdministrations:a,selectedPatientId:u,selectedDrugName:f,overrides:e}):null,[t,n,r,a,u,f]);y.useEffect(()=>{if(u){try{if(f){const e=`tdmfriends:tdmResults:${u}:${f}`,t=window.localStorage.getItem(e);if(t){const e=[...JSON.parse(t)].sort((e,t)=>new Date(t.timestamp).getTime()-new Date(e.timestamp).getTime())[0];if(e&&e.data){const t=e.data;w(t);const n=lt();if(void 0!==(null==n?void 0:n.input_TOXI))O(n.input_TOXI);else{const e=(null==n?void 0:n.dataset)||[];e.length>0&&void 0!==e[0].TOXI&&O(e[0].TOXI)}const r=(null==n?void 0:n.dataset)||[];return T(tt(t,r)),R({ipredSeries:((null==t?void 0:t.IPRED_CONC)||[]).map(e=>({time:Number(e.time)||0,value:Number(e.IPRED??0)||0})).filter(e=>e.time>=0),predSeries:((null==t?void 0:t.PRED_CONC)||[]).map(e=>({time:Number(e.time)||0,value:Number(e.IPRED??0)||0})).filter(e=>e.time>=0),observedSeries:((null==n?void 0:n.dataset)||[]).filter(e=>0===e.EVID&&null!=e.DV).map(e=>({time:Number(e.TIME)||0,value:Number(e.DV)})).filter(e=>e.time>=0),currentMethodSeries:((null==t?void 0:t.PRED_CONC)||[]).map(e=>({time:Number(e.time)||0,value:Number(e.IPRED??0)||0})).filter(e=>e.time>=0)}),void j(!0)}}}const e=window.localStorage.getItem(`tdmfriends:tdmResult:${u}`);if(e){const t=JSON.parse(e);w(t);const n=lt();if(void 0!==(null==n?void 0:n.input_TOXI))O(n.input_TOXI);else{const e=(null==n?void 0:n.dataset)||[];e.length>0&&void 0!==e[0].TOXI&&O(e[0].TOXI)}const r=(null==n?void 0:n.dataset)||[];if(et(t,r))return void oe(!0);T(tt(t,(null==n?void 0:n.dataset)||[])),R({ipredSeries:((null==t?void 0:t.IPRED_CONC)||[]).map(e=>({time:Number(e.time)||0,value:Number(e.IPRED??0)||0})).filter(e=>e.time>=0),predSeries:((null==t?void 0:t.PRED_CONC)||[]).map(e=>({time:Number(e.time)||0,value:Number(e.IPRED??0)||0})).filter(e=>e.time>=0),observedSeries:((null==n?void 0:n.dataset)||[]).filter(e=>0===e.EVID&&null!=e.DV).map(e=>({time:Number(e.TIME)||0,value:Number(e.DV)})).filter(e=>e.time>=0),currentMethodSeries:((null==t?void 0:t.PRED_CONC)||[]).map(e=>({time:Number(e.time)||0,value:Number(e.IPRED??0)||0})).filter(e=>e.time>=0)}),j(!0)}else T([])}catch(e){}_(null),P(null),k([]),I([])}},[u,f,tt,lt,et]),y.useEffect(()=>{if(u)if(null==s?void 0:s.drugName)p(s.drugName);else try{const e=window.localStorage.getItem(`tdmfriends:selectedDrug:${u}`);e&&p(e)}catch{}},[u,null==s?void 0:s.drugName]),y.useEffect(()=>{if(u&&f)try{window.localStorage.setItem(`tdmfriends:selectedDrug:${u}`,f)}catch{}},[u,f]);const[dt,ct]=y.useState([]),[ut,mt]=y.useState(!1),[ft,pt]=y.useState(""),gt=y.useCallback(e=>{var t;if(!(null==e?void 0:e.data))return;mt(!0);const n=e.data;w(n);const r=(null==e?void 0:e.dataset)||(null==(t=lt())?void 0:t.dataset)||[];et(n,r)?oe(!0):(T(tt(n,r)),R({ipredSeries:((null==n?void 0:n.IPRED_CONC)||[]).map(e=>({time:Number(e.time)||0,value:Number(e.IPRED??0)||0})).filter(e=>e.time>=0),predSeries:((null==n?void 0:n.PRED_CONC)||[]).map(e=>({time:Number(e.time)||0,value:Number(e.IPRED??0)||0})).filter(e=>e.time>=0),observedSeries:(r||[]).filter(e=>0===e.EVID&&null!=e.DV).map(e=>({time:Number(e.TIME)||0,value:Number(e.DV)})).filter(e=>e.time>=0),currentMethodSeries:((null==n?void 0:n.PRED_CONC)||[]).map(e=>({time:Number(e.time)||0,value:Number(e.IPRED??0)||0})).filter(e=>e.time>=0)}))},[lt,tt,et]),ht=y.useCallback(()=>mt(!1),[]);y.useEffect(()=>{try{if(!u||!f)return void ct([]);const e=`tdmfriends:tdmResults:${u}:${f}`,t=window.localStorage.getItem(e),n=[...t?JSON.parse(t):[]].sort((e,t)=>new Date(t.timestamp).getTime()-new Date(e.timestamp).getTime()).slice(0,5);ct(n)}catch{ct([])}},[u,f,N]);const xt=()=>{const e=s||Pe.find(e=>e.drugName===f);if(!e)return{};const t=(e.tdmTarget||"").toLowerCase();if(!t||t.includes("auc"))return{};if(t.includes("trough")||t.includes("cmax")){const t=((null==e?void 0:e.tdmTargetValue)||"").match(/\d+\.?\d*/g)||[];return{min:t[0]?parseFloat(t[0]):void 0,max:t[1]?parseFloat(t[1]):void 0}}return{}};return u&&_e&&0!==Ve.length?e.jsxs("div",{className:"space-y-6",children:[e.jsx(Oe,{currentPatient:_e,selectedPrescription:s,latestBloodTest:Ue,drugAdministrations:a,isExpanded:!!l||void 0,disableHover:l}),e.jsxs("div",{className:"w-full",children:[dt.length>0&&e.jsxs("div",{className:"mb-4 text-xs text-muted-foreground",children:[e.jsx("div",{className:"font-semibold mb-1",children:"최근 TDM 히스토리 (최대 5개)"}),e.jsx("ul",{className:"list-disc pl-5 space-y-1",children:dt.map(t=>{var n,r,i,s;return e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsxs("span",{children:[new Date(t.timestamp).toLocaleString()," — AUC24h(before/after): ",(null==(n=t.summary)?void 0:n.AUC24h_before)??"-"," /"," ",(null==(r=t.summary)?void 0:r.AUC24h_after)??"-",", Ctrough(before/after):"," ",(null==(i=t.summary)?void 0:i.CTROUGH_before)??"-"," /"," ",(null==(s=t.summary)?void 0:s.CTROUGH_after)??"-"]}),e.jsx("button",{className:"underline",onClick:()=>gt(t),children:"불러오기"}),o&&e.jsx("button",{className:"underline",onClick:()=>{gt(t),setTimeout(()=>{try{null==o||o()}catch{}},0)},children:"리포트"})]},t.id)})}),ut&&e.jsxs("div",{className:"mt-2 text-[11px]",children:["완료 보기 모드: 용법 조정 UI가 숨겨집니다."," ",e.jsx("button",{className:"underline",onClick:ht,children:"종료"})," ",o&&e.jsx("button",{className:"underline ml-2",onClick:()=>{try{null==o||o()}catch{}},children:"리포트 보기"})]})]}),e.jsx(Fe,{showSimulation:!0,currentPatientName:_e.name,selectedDrug:f,targetMin:xt().min,targetMax:xt().max,recentAUC:null==N?void 0:N.AUC_24_before,recentMax:null==N?void 0:N.CMAX_before,recentTrough:null==N?void 0:N.CTROUGH_before,predictedAUC:ut?null:null==N?void 0:N.AUC_24_after,predictedMax:ut?null:null==N?void 0:N.CMAX_after,predictedTrough:ut?null:null==N?void 0:N.CTROUGH_after,ipredSeries:null==M?void 0:M.ipredSeries,predSeries:null==M?void 0:M.predSeries,observedSeries:null==M?void 0:M.observedSeries,tdmIndication:Le((null==s?void 0:s.drugName)||f).indication,tdmTarget:Le((null==s?void 0:s.drugName)||f).target,tdmTargetValue:Le((null==s?void 0:s.drugName)||f).targetValue,latestAdministration:h,drugAdministrations:a,steadyState:null==N?void 0:N.Steady_state,input_TOXI:A,tauBefore:null==(d=lt())?void 0:d.input_tau_before,amountBefore:null==(c=lt())?void 0:c.input_amount_before})]}),!ut&&F.map(t=>{var n,r,i,o,l,d,c,u;const m="dosage"===t.type||"dosageV2"===t.type||"dosageAndInterval"===t.type;return e.jsxs("div",{className:"bg-white dark:bg-slate-900 rounded-lg p-6 mt-6 shadow-lg border-2 "+(m?"border-pink-200 dark:border-pink-800":"border-green-200 dark:border-green-800"),children:[e.jsxs("div",{className:"flex justify-between items-start mb-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("h2",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:["용법 조정 ",t.id]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"dosage"===t.type?"투약 용량을 조정하고 즉시 예측 결과를 확인해보세요":"dosageV2"===t.type?"사전 정의된 용량 버튼 또는 직접 입력으로 투약 용량을 조정해보세요":"dosageAndInterval"===t.type?"투약 용량과 시간을 동시에 조정하고 즉시 예측 결과를 확인해보세요":"투약 시간의 간격을 조정하고 즉시 예측 결과를 확인해보세요"})]}),e.jsx("button",{className:"text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-2xl font-bold flex-shrink-0",onClick:()=>{return e=t.id,ue(e),void re(!0);var e},children:"×"})]}),e.jsx("div",{className:"mb-6 px-4",children:"dosageAndInterval"===t.type?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex flex-col gap-4 md:flex-row md:items-start md:justify-between",role:"group","aria-label":"투약 용량 옵션",children:e.jsxs("div",{className:"flex-1 md:pr-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-2",children:e.jsx("span",{className:"text-sm font-semibold text-gray-700 dark:text-gray-200",children:"투약 용량 선택"})}),e.jsx("div",{className:"flex flex-wrap gap-2",children:Ze.length>0?Ze.map(n=>{const r=`${Number(n).toLocaleString()}mg`,i=V[t.id]===r;return e.jsxs(ie,{variant:i?"default":"outline",size:"default",onClick:()=>Je(t.id,n),className:(i?"bg-black dark:bg-primary text-white dark:text-primary-foreground hover:bg-gray-800 dark:hover:bg-primary/90":"bg-white dark:bg-slate-800 border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-slate-700")+" rounded-full px-4 py-2 text-sm font-semibold transition h-auto flex flex-col items-center justify-center gap-0.5",title:`${n}mg`,"aria-pressed":i,children:[e.jsx("span",{children:Number(n).toLocaleString()}),e.jsx("span",{className:"text-xs font-normal "+(i?"text-gray-200 dark:text-primary-foreground":"text-muted-foreground"),children:"mg"})]},`${t.id}-${n}`)}):e.jsx("div",{className:"text-sm text-muted-foreground text-center py-6",children:"현재 선택한 약물에 대해 제공되는 기본 용량 프리셋이 없습니다."})})]})}),e.jsxs("div",{className:"flex flex-col gap-4",role:"group","aria-label":"투약 간격 옵션",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"flex items-center justify-between mb-2",children:e.jsx("span",{className:"text-sm font-semibold text-gray-700 dark:text-gray-200",children:"투약 시간 선택"})}),e.jsx("div",{className:"flex flex-wrap gap-2",children:Xe.map(n=>{const r=Y[t.id]===n.label;return e.jsxs(ie,{variant:r?"default":"outline",size:"default",onClick:()=>Be(t.id,n.label),className:(r?"bg-black dark:bg-primary text-white dark:text-primary-foreground hover:bg-gray-800 dark:hover:bg-primary/90":"bg-white dark:bg-slate-800 border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-slate-700")+" rounded-full px-4 py-2 text-sm font-semibold transition h-auto flex flex-col items-center justify-center gap-0.5",title:n.helper,"aria-pressed":r,children:[e.jsx("span",{children:n.label}),e.jsx("span",{className:"text-xs font-normal "+(r?"text-gray-200 dark:text-primary-foreground":"text-muted-foreground"),children:n.helper})]},`${t.id}-${n.label}`)})})]}),e.jsx("div",{className:"flex w-full flex-col gap-2 border-t pt-4",children:e.jsx("div",{className:"flex justify-end",children:e.jsx(ie,{variant:"outline",className:"w-[150px] h-[40px] px-4 py-2 text-sm leading-tight",onClick:()=>{h&&(!Z[t.id]&&h.dose&&Q(e=>({...e,[t.id]:String(h.dose)})),!ee[t.id]&&h.intervalHours&&te(e=>({...e,[t.id]:String(h.intervalHours)}))),de(e=>({...e,[t.id]:!0}))},children:"+ 직접 입력"})})})]})]}),e.jsx(Pt,{open:le[t.id]||!1,onOpenChange:e=>{de(n=>({...n,[t.id]:e})),e&&h&&(!Z[t.id]&&h.dose&&Q(e=>({...e,[t.id]:String(h.dose)})),!ee[t.id]&&h.intervalHours&&te(e=>({...e,[t.id]:String(h.intervalHours)})))},children:e.jsxs(Lt,{children:[e.jsx(Vt,{children:e.jsx(Ut,{children:"직접 입력"})}),e.jsxs("div",{className:"py-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2 block",children:"투약 용량 (mg)"}),e.jsx(se,{type:"number",min:"0",step:"0.1",className:"w-full h-[80px] px-4 py-3 text-4xl font-semibold leading-tight text-center placeholder:text-2xl [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none",placeholder:"용량 (mg)",value:Z[t.id]??((null==h?void 0:h.dose)?String(h.dose):""),onChange:e=>qe(t.id,e.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2 block",children:"투약 시간 (시간)"}),e.jsx(se,{type:"number",min:"0",step:"0.1",className:"w-full h-[80px] px-4 py-3 text-4xl font-semibold leading-tight text-center placeholder:text-2xl [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none",placeholder:"시간 (h)",value:ee[t.id]??((null==h?void 0:h.intervalHours)?String(h.intervalHours):""),onChange:e=>We(t.id,e.target.value)})]})]}),e.jsxs(Ht,{children:[e.jsx(ie,{variant:"outline",onClick:()=>de(e=>({...e,[t.id]:!1})),children:"취소"}),e.jsx(ie,{onClick:()=>{Z[t.id]&&Ye(t.id),ee[t.id]&&Ge(t.id),de(e=>({...e,[t.id]:!1}))},children:"확인"})]})]})})]}):"dosage"===t.type?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex justify-center mb-4",children:[je[t.id]&&!ve[t.id]&&e.jsxs("div",{className:"flex flex-col items-center gap-3 w-full",children:[e.jsx("div",{className:"text-sm text-red-600 dark:text-red-400",children:"제안 계산에 실패했습니다. 네트워크 상태를 확인하고 다시 시도해주세요."}),e.jsx(ie,{variant:"outline",size:"default",onClick:()=>{Ne(e=>({...e,[t.id]:!1})),ot(t.id)},className:"text-base px-6 py-3",children:"다시 시도"})]}),!je[t.id]&&(!he[t.id]||0===he[t.id].length||ve[t.id])&&e.jsxs("span",{className:"text-sm text-muted-foreground flex items-center gap-2",children:[e.jsxs("svg",{className:"animate-spin h-4 w-4",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"})]}),"제안을 계산 중..."]})]}),(he[t.id]||[]).length>0&&e.jsx("div",{className:"flex flex-wrap justify-center gap-4",children:(he[t.id]||[]).map(n=>{const r=`${Number(n).toLocaleString()}mg`;return e.jsx(ie,{variant:V[t.id]===r?"default":"outline",size:"default",onClick:()=>Ke(t.id,r),className:(V[t.id]===r?"bg-black dark:bg-primary text-white dark:text-primary-foreground hover:bg-gray-800 dark:hover:bg-primary/90":"bg-white dark:bg-slate-800 border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-slate-700")+" text-base px-6 py-3 flex-shrink-0",children:r},`${t.id}-${n}`)})})]}):"interval"===t.type?e.jsx(e.Fragment,{children:e.jsxs("div",{className:"flex flex-col gap-4 md:flex-row md:items-start md:justify-between",role:"group","aria-label":"투약 간격 옵션",children:[e.jsxs("div",{className:"flex-1 md:pr-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-2",children:e.jsx("span",{className:"text-sm font-semibold text-gray-700 dark:text-gray-200",children:"투약 시간 선택"})}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-7 gap-3",children:Xe.map(n=>{const r=Y[t.id]===n.label;return e.jsxs(ie,{variant:r?"default":"outline",size:"default",onClick:()=>Be(t.id,n.label),className:(r?"bg-black dark:bg-primary text-white dark:text-primary-foreground hover:bg-gray-800 dark:hover:bg-primary/90":"bg-white dark:bg-slate-800 border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-slate-700")+" flex h-auto w-full min-w-0 flex-col items-center justify-center gap-1 px-4 py-3 text-sm font-semibold leading-tight transition",title:n.helper,"aria-pressed":r,children:[e.jsx("span",{children:n.label}),e.jsx("span",{className:"text-xs font-normal "+(r?"text-gray-200 dark:text-primary-foreground":"text-muted-foreground"),children:n.helper})]},`${t.id}-${n.label}`)})})]}),e.jsxs("div",{className:"flex w-full flex-col gap-2 border-t pt-4 md:w-64 md:self-stretch md:border-t-0 md:border-l md:border-gray-200 md:pl-6 md:pt-0",children:[e.jsx("span",{className:"text-sm font-semibold text-gray-700 dark:text-gray-200",children:"직접 입력 (시간)"}),e.jsxs("div",{className:"flex flex-col items-stretch gap-2",children:[e.jsx(se,{type:"number",min:"0",step:"0.1",className:"w-full h-[80px] px-4 py-3 text-lg font-semibold leading-tight text-center",placeholder:"시간 (h)",value:ee[t.id]??"",onChange:e=>We(t.id,e.target.value)}),e.jsx("div",{className:"flex",children:e.jsx(ie,{className:"w-full h-[50px] px-4 py-3 text-sm font-semibold leading-tight",onClick:()=>Ge(t.id),children:"확인"})})]})]})]})}):e.jsx(e.Fragment,{children:e.jsxs("div",{className:"flex flex-col gap-4 md:flex-row md:items-start md:justify-between",role:"group","aria-label":"투약 용량 옵션",children:[e.jsxs("div",{className:"flex-1 md:pr-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-2",children:e.jsx("span",{className:"text-sm font-semibold text-gray-700 dark:text-gray-200",children:"투약 용량 선택"})}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3",children:Ze.length>0?Ze.map(n=>{const r=`${Number(n).toLocaleString()}mg`,i=V[t.id]===r;return e.jsxs(ie,{variant:i?"default":"outline",size:"default",onClick:()=>Je(t.id,n),className:(i?"bg-black dark:bg-primary text-white dark:text-primary-foreground hover:bg-gray-800 dark:hover:bg-primary/90":"bg-white dark:bg-slate-800 border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-slate-700")+" flex h-auto w-full min-w-0 flex-col items-center justify-center gap-1 px-4 py-3 text-sm font-semibold leading-tight transition",title:`${n}mg`,"aria-pressed":i,children:[e.jsx("span",{children:r}),e.jsx("span",{className:"text-xs font-normal "+(i?"text-gray-200 dark:text-primary-foreground":"text-muted-foreground"),children:"mg"})]},`${t.id}-${n}`)}):e.jsx("div",{className:"col-span-2 sm:col-span-3 lg:col-span-6 text-sm text-muted-foreground text-center py-6",children:"현재 선택한 약물에 대해 제공되는 기본 용량 프리셋이 없습니다."})})]}),e.jsxs("div",{className:"flex w-full flex-col gap-2 border-t pt-4 md:w-64 md:self-stretch md:border-t-0 md:border-l md:border-gray-200 md:pl-6 md:pt-0",children:[e.jsx("span",{className:"text-sm font-semibold text-gray-700 dark:text-gray-200",children:"직접 입력 (mg)"}),e.jsxs("div",{className:"flex flex-col items-stretch gap-2",children:[e.jsx(se,{type:"number",min:"0",step:"0.1",className:"w-full h-[80px] px-4 py-3 text-lg font-semibold leading-tight text-center",placeholder:"용량 (mg)",value:Z[t.id]??"",onChange:e=>qe(t.id,e.target.value)}),e.jsx("div",{className:"flex",children:e.jsx(ie,{className:"w-full h-[50px] px-4 py-3 text-sm font-semibold leading-tight",onClick:()=>Ye(t.id),children:"확인"})})]})]})]})})}),e.jsx("div",{className:"mb-8",children:e.jsx(zn,{simulationData:[],showSimulation:b,currentPatientName:null==_e?void 0:_e.name,selectedDrug:f,chartTitle:`용법 조정 ${t.id}`,targetMin:xt().min,targetMax:xt().max,drugAdministrations:a,recentAUC:null==N?void 0:N.AUC_24_after,recentMax:null==N?void 0:N.CMAX_after,recentTrough:null==N?void 0:N.CTROUGH_after,predictedAUC:null==(n=ke[t.id])?void 0:n.AUC_24_after,predictedMax:null==(r=ke[t.id])?void 0:r.CMAX_after,predictedTrough:null==(i=ke[t.id])?void 0:i.CTROUGH_after,ipredSeries:null==(o=Re[t.id])?void 0:o.ipredSeries,predSeries:null==(l=Re[t.id])?void 0:l.predSeries,observedSeries:null==(d=Re[t.id])?void 0:d.observedSeries,currentMethodSeries:null==(c=Re[t.id])?void 0:c.currentMethodSeries,chartColor:m?"pink":"green",isLoading:pe[t.id]||!1,tdmIndication:Le((null==s?void 0:s.drugName)||f).indication,tdmTarget:Le((null==s?void 0:s.drugName)||f).target,tdmTargetValue:Le((null==s?void 0:s.drugName)||f).targetValue,originalAdministration:h,latestAdministration:(()=>{if(!h)return null;let e={...h};if(m&&V[t.id]){const n=parseFloat(V[t.id].replace(/[^0-9.]/g,""));isNaN(n)||(e.dose=n)}if(("interval"===t.type||"dosageAndInterval"===t.type)&&Y[t.id]){const n=ze(Y[t.id]);"number"!=typeof n||Number.isNaN(n)||(e.intervalHours=n)}return e})(),steadyState:null==(u=ke[t.id])?void 0:u.Steady_state,isEmptyChart:!me[t.id]||ve[t.id]&&(!he[t.id]||0===he[t.id].length),selectedButton:"interval"===t.type?Y[t.id]:"dosageAndInterval"===t.type?`${V[t.id]||""} / ${Y[t.id]||""}`:V[t.id]})})]},`adjustment-${t.id}`)}),!ut&&e.jsx("div",{className:"bg-white dark:bg-slate-900 rounded-lg p-6 mt-6",children:e.jsxs("div",{className:"text-center mb-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-6",children:"용법 조정 시뮬레이션을 진행하시겠습니까?"}),ft&&e.jsx("div",{className:"text-sm text-red-600 mb-2",children:ft}),e.jsxs("div",{className:"flex justify-center gap-4 flex-wrap",children:[e.jsx(ie,{onClick:()=>{ft&&pt("");const e=F.length+1;L(t=>[...t,{id:e,type:"dosageV2"}]),fe(t=>({...t,[e]:!1})),Q(t=>({...t,[e]:""})),st(e)},className:"w-[300px] bg-black text-white font-bold text-lg py-3 px-6 justify-center",children:"투약용량조정(ver2)"}),e.jsx(ie,{onClick:()=>{ft&&pt("");const e=F.length+1;L(t=>[...t,{id:e,type:"interval"}]),fe(t=>({...t,[e]:!1})),st(e)},className:"w-[300px] bg-black text-white font-bold text-lg py-3 px-6 justify-center",children:"투약시간조정"}),e.jsx(ie,{onClick:()=>{ft&&pt("");const e=F.length+1;L(t=>[...t,{id:e,type:"dosageAndInterval"}]),fe(t=>({...t,[e]:!1})),Q(t=>({...t,[e]:""})),te(t=>({...t,[e]:""})),st(e)},className:"w-[300px] bg-black text-white font-bold text-lg py-3 px-6 justify-center",children:"용량&시간 조정"})]})]})}),e.jsx(H,{open:ne,onOpenChange:re,children:e.jsxs(U,{children:[e.jsxs(K,{children:[e.jsx(z,{children:"용법 조정 카드 삭제"}),e.jsx(B,{children:"이 용법 조정 카드를 삭제하시겠습니까? 삭제된 카드의 설정은 복구할 수 없습니다."})]}),e.jsxs(W,{children:[e.jsx(J,{onClick:()=>{re(!1),ue(null)},children:"취소"}),e.jsx(G,{onClick:()=>{null!==ce&&(L(e=>e.filter(e=>e.id!==ce)),q(e=>{const t={...e};return delete t[ce],t}),Q(e=>{const t={...e};return delete t[ce],t}),X(e=>{const t={...e};return delete t[ce],t}),fe(e=>{const t={...e};return delete t[ce],t}),Ce(e=>{const t={...e};return delete t[ce],t}),Me(e=>{const t={...e};return delete t[ce],t}),$e(e=>{const t={...e};return delete t[ce],t}),Ne(e=>{const t={...e};return delete t[ce],t}),setTimeout(()=>{0===F.filter(e=>e.id!==ce).length&&((e,t,n)=>{try{if(!e||!t)return;const r=`tdmfriends:activeTdm:${e}:${t}`;n||window.localStorage.removeItem(r)}catch{}})(u,f,!1)},0)),re(!1),ue(null)},children:"삭제"})]})]})}),e.jsx(H,{open:ae,onOpenChange:oe,children:e.jsxs(U,{children:[e.jsxs(K,{children:[e.jsx(z,{children:"차트 그리기 불가"}),e.jsx(B,{children:"데이터가 방대하여 차트를 그릴 수 없습니다."})]}),e.jsx(W,{children:e.jsx(G,{onClick:()=>oe(!1),children:"확인"})})]})})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[400px] text-muted-foreground",children:[e.jsx("p",{className:"text-lg font-semibold",children:"환자와 약물을 먼저 선택해 주세요."}),e.jsx("p",{className:"text-sm mt-2",children:"이전 단계에서 환자, TDM 약물, 혈액검사 정보를 모두 입력해야 시뮬레이션이 가능합니다."})]})},sr=({patients:t,prescriptions:n,bloodTests:r,selectedPatient:i,selectedPrescription:s,drugAdministrations:a,onPrev:o})=>{const[l,d]=y.useState(null),[c,u]=y.useState(!1),[m,f]=y.useState(!1);y.useEffect(()=>{if(i)try{const e=window.localStorage.getItem(`tdmfriends:tdmResult:${i.id}`);d(e?JSON.parse(e):null)}catch{d(null)}else d(null)},[null==i?void 0:i.id]);const p=async()=>{var e;f(!0),await new Promise(e=>setTimeout(e,0));const t=document.getElementById("pk-simulation-content");if(!t)return f(!1),void alert("보고서 내용을 찾을 수 없습니다.");const n=document.documentElement.classList.contains("dark");try{const r=document.querySelector("[data-report-button]");r&&(r.disabled=!0,r.textContent="PDF 생성 중..."),n&&(document.documentElement.classList.remove("dark"),await new Promise(e=>setTimeout(e,100)));const a=t.querySelectorAll("div");let o=null;for(const t of Array.from(a)){const n=t.querySelector("h2");if(n&&(null==(e=n.textContent)?void 0:e.includes("용법 조정 시뮬레이션을 진행하시겠습니까?"))){o=t;break}}let l=null;o&&(l=o.style.display,o.style.display="none");const d=(new Date).toLocaleString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}),c=`${(null==i?void 0:i.name)||"환자"} 환자의 ${(null==s?void 0:s.drugName)||"약품"} TDM분석 보고서 - ${d}`,u=document.createElement("div");u.style.cssText="\n        width: 100%;\n        padding: 12px 0;\n        margin-bottom: 16px;\n        font-size: 18px;\n        font-weight: bold;\n        text-align: center;\n        color: #000;\n        background-color: #ffffff;\n        border-bottom: 2px solid #000;\n      ",u.textContent=c,t.insertBefore(u,t.firstChild);const m=await Le(t,{scale:1.5,useCORS:!0,allowTaint:!0,backgroundColor:"#ffffff",logging:!1,width:t.scrollWidth,height:t.scrollHeight,scrollX:0,scrollY:0});t.removeChild(u),o&&(o.style.display=l||"");m.toDataURL("image/png",.95);const f=15,p=210-2*f,g=297-2*f,h=m.width,x=m.height,v=p/h,b=p,j=x*v,N=g,y=Math.ceil(j/N),w=N/v,D=new Ve({orientation:"portrait",unit:"mm",format:"a4"});for(let e=0;e<y;e++){e>0&&D.addPage();const t=e*w,n=Math.min(w,x-t),r=document.createElement("canvas");r.width=h,r.height=n;const i=r.getContext("2d");i&&i.drawImage(m,0,t,h,n,0,0,h,n);const s=r.toDataURL("image/png",.95),a=n*v;D.addImage(s,"PNG",f,f,b,a,void 0,"FAST")}const T=`${(null==i?void 0:i.name)||"환자"}_${(null==s?void 0:s.drugName)||"약품"}_TDM_분석보고서_${(new Date).toISOString().split("T")[0]}.pdf`;D.save(T),r&&(r.disabled=!1,r.textContent="TDM 분석 보고서 생성"),n&&document.documentElement.classList.add("dark")}catch(r){alert("PDF 생성 중 오류가 발생했습니다: "+(r instanceof Error?r.message:String(r)));const e=document.querySelector("[data-report-button]");e&&(e.disabled=!1,e.textContent="TDM 분석 보고서 생성"),n&&document.documentElement.classList.add("dark")}finally{f(!1)}};if(!i)return e.jsxs(Q,{children:[e.jsxs(ee,{children:[e.jsxs(te,{className:"flex items-center gap-2",children:[e.jsx(Ne,{className:"h-5 w-5"}),"TDM Simulation"]}),e.jsx(ne,{children:"시뮬레이션을 진행하려면 환자를 먼저 선택해주세요."})]}),e.jsx(re,{className:"py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Ne,{className:"h-16 w-16 text-muted-foreground mx-auto mb-4"}),e.jsx("p",{className:"text-lg font-semibold mb-2",children:"환자를 선택해주세요"}),e.jsx("p",{className:"text-muted-foreground",children:"환자 등록 및 선택 단계에서 환자를 선택한 후 시뮬레이션을 진행할 수 있습니다."})]})})]});n.filter(e=>e.patientId===i.id),!s||r.filter(e=>e.patientId===i.id&&e.drugName===s.drugName);const g=s?a.filter(e=>e.patientId===i.id&&e.drugName===s.drugName):[];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(Q,{children:[e.jsxs(ee,{children:[e.jsxs(te,{className:"flex items-center gap-2",children:[e.jsx(Ne,{className:"h-5 w-5"}),"TDM Simulation",e.jsx(me,{className:"h-5 w-5 text-green-600"})]}),e.jsxs(ne,{children:[i.name," 환자의 TDM 분석 결과를 확인하고 약물 요법을 직접 시뮬레이션 해보세요."]})]}),e.jsxs(re,{children:[e.jsx("div",{id:"pk-simulation-content",children:e.jsx(ir,{patients:t,prescriptions:n,bloodTests:r,selectedPatient:i,selectedPrescription:s,drugAdministrations:g,onDownloadPDF:p,forceExpandPatientDetails:m})}),e.jsxs("div",{className:"flex justify-between mt-6",children:[e.jsxs(ie,{variant:"outline",onClick:o,className:"flex items-center gap-2",children:[e.jsx(be,{className:"h-4 w-4"}),"투약 기록"]}),e.jsxs(ie,{onClick:()=>{u(!0)},className:"flex items-center gap-2","data-report-button":!0,children:[e.jsx(ye,{className:"h-4 w-4"}),"TDM 분석 보고서 생성"]})]})]})]}),e.jsx(H,{open:c,onOpenChange:u,children:e.jsxs(U,{children:[e.jsxs(K,{children:[e.jsx(z,{children:"TDM 분석 보고서를 생성하시겠습니까?"}),e.jsx(B,{children:"현재 화면의 TDM 분석 결과를 PDF 파일로 다운로드합니다. 환자 정보, 차트, 용법 조정 결과가 포함됩니다."})]}),e.jsxs(W,{children:[e.jsx(J,{onClick:()=>{u(!1)},children:"취소"}),e.jsx(G,{onClick:async()=>{u(!1),await p()},className:"bg-black dark:bg-primary text-white dark:text-primary-foreground hover:bg-gray-800 dark:hover:bg-primary/90",children:"보고서 생성"})]})]})})]})},ar=({row:t,onUpdate:n,isDarkMode:r,readOnly:i=!1})=>{if(i)return e.jsx("div",{style:{textAlign:"center",width:"100%",color:r?"#e0e6f0":void 0,minHeight:"24px",lineHeight:"24px"},children:t.injectionTime??"-"});const[s,a]=y.useState(t.injectionTime),[o,l]=y.useState(!1);y.useEffect(()=>{o||a(t.injectionTime)},[t.injectionTime,o]);return e.jsx("input",{type:"text",value:s,onChange:e=>{a(e.target.value)},onFocus:e=>{l(!0),e.target.setSelectionRange(e.target.value.length,e.target.value.length)},onBlur:e=>{l(!1),n(t.id,"injectionTime",e.target.value)},onKeyDown:e=>{"Enter"===e.key&&e.target.blur()},style:{border:"none",background:"transparent",textAlign:"center",width:"100%",color:r?"#e0e6f0":void 0}})},or=({row:t,onUpdate:n,isDarkMode:r})=>{const[i,s]=y.useState(t.timeStr),[a,o]=y.useState(!1);y.useEffect(()=>{a||s(t.timeStr)},[t.timeStr,a]);return e.jsx("input",{type:"text",value:i,onChange:e=>{s(e.target.value)},onFocus:e=>{o(!0),e.target.select()},onBlur:e=>{o(!1);let r=e.target.value.toString().replace(/undefined/g,"").trim();if(/^\d{12}$/.test(r)){const e=r.substring(0,4),t=r.substring(4,6),n=r.substring(6,8),i=r.substring(8,10),s=r.substring(10,12);r=`${e}-${t}-${n} ${i}:${s}`}else if(/^\d{11}$/.test(r)){const e=r.substring(0,4),t=r.substring(4,6),n=r.substring(6,8),i=r.substring(8,10),s=r.substring(10,11);r=`${e}-${t}-${n} ${i}:0${s}`}else if(/^\d{10}$/.test(r)){const e=r.substring(0,4),t=r.substring(4,6),n=r.substring(6,8),i=r.substring(8,10);r=`${e}-${t}-${n} ${i}:00`}else if(r.includes(" ")&&r.includes(":")&&!r.includes("-")){const e=r.split(" ");if(4===e.length){const[t,n,i,s]=e;r=`${t}-${n.padStart(2,"0")}-${i.padStart(2,"0")} ${s}`}}n(t.id,"timeStr",r)},onKeyDown:e=>{"Enter"===e.key&&e.target.blur()},placeholder:"YYYY-MM-DD HH:MM",style:{border:"none",background:"transparent",textAlign:"center",width:"100%",color:r?"#e0e6f0":void 0}})};function lr(t){var n,r,i,s,a,o;const l=e=>"IV"===e?"정맥":"oral"===e?"경구":"subcutaneous"===e?"피하":"intramuscular"===e?"근육":e||"",[d,c]=y.useState({route:"",dosage:"",unit:"mg",intervalHours:"",injectionTime:"",dosageForm:"",firstDoseDate:"",firstDoseTime:"",totalDoses:""}),u=y.useCallback(()=>{var e;return t.selectedPatient&&(null==(e=t.tdmDrug)?void 0:e.drugName)?`tdmfriends:conditions:${t.selectedPatient.id}:${t.tdmDrug.drugName}`:null},[t.selectedPatient,null==(n=t.tdmDrug)?void 0:n.drugName]),m=y.useCallback(()=>{const e=u();if(!e)return null;try{const t=localStorage.getItem(e);if(t)return JSON.parse(t)}catch(t){}return null},[u]),[f,p]=y.useState(()=>m()||t.initialConditions||[]),[g,h]=y.useState(t.initialTableData||[]),[x,v]=y.useState(t.initialIsTableGenerated||!1),[b,j]=y.useState(!0),[N,w]=y.useState(null),[D,T]=y.useState(new Set);y.useState(null);const[S,k]=y.useState(!1),[C,I]=y.useState(null);y.useState("table");const[M,R]=y.useState(""),[$,_]=y.useState(!1),E=y.useRef(!1),P=y.useRef(t.onRecordsChange);y.useEffect(()=>{P.current=t.onRecordsChange},[t.onRecordsChange]);const A=y.useRef(t.onConditionsChange);y.useEffect(()=>{A.current=t.onConditionsChange},[t.onConditionsChange]);const O=y.useRef(null),F=y.useRef(null),L=y.useRef(null);y.useEffect(()=>{const e=()=>_(document.documentElement.classList.contains("dark"));return e(),window.addEventListener("transitionend",e),window.addEventListener("click",e),window.addEventListener("keydown",e),()=>{window.removeEventListener("transitionend",e),window.removeEventListener("click",e),window.removeEventListener("keydown",e)}},[]),y.useEffect(()=>{const e=t.initialAdministrations||[];if(e&&0!==e.length)try{const t={id:"title",round:"회차",time:"투약 시간",amount:"투약용량",route:"투약경로",injectionTime:"주입시간",isTitle:!0},n=e.map((t,n)=>{const r=`${t.date} ${t.time}`,i=new Date(`${t.date}T${t.time}`);return{id:String(t.id||`${Date.now()}_${n}`),conditionId:null,doseIndex:n+1,totalDoses:e.length,time:i,timeStr:r,amount:`${t.dose} ${t.unit||"mg"}`,route:t.route,injectionTime:t.isIVInfusion?void 0!==t.infusionTime?String(t.infusionTime):"0":"-",isTitle:!1}}).sort((e,t)=>e.time-t.time);n.forEach((e,t)=>{e.round=`${t+1} 회차`}),E.current=!0,h([t,...n]),v(!0),setTimeout(()=>{E.current=!1},0)}catch{}},[t.initialAdministrations]),y.useEffect(()=>{if(!P.current)return;if(E.current)return void(E.current=!1);const e=g.filter(e=>!e.isTitle).map(e=>{const t=e.conditionId?f.find(t=>t.id===e.conditionId):null;return{timeStr:e.timeStr,amount:e.amount,route:e.route,injectionTime:e.injectionTime,conditionId:e.conditionId,intervalHours:t?Number(t.intervalHours):void 0}});try{const t=JSON.stringify(e);if(O.current===t)return;O.current=t}catch{}P.current(e)},[g,f]);const V=y.useRef({tableRowCount:0,conditionsTotalDoses:0}),[H,U]=y.useState(!1),K=y.useRef({tableRowCount:0,conditionsTotalDoses:0});y.useEffect(()=>{if(!x||0===f.length)return;if(E.current)return;const e=g.filter(e=>!e.isTitle).length,t=f.reduce((e,t)=>e+(parseInt(t.totalDoses)||0),0);V.current.tableRowCount===e&&V.current.conditionsTotalDoses===t||(e!==t&&e>0?(U(!0),K.current={tableRowCount:e,conditionsTotalDoses:t}):(V.current={tableRowCount:e,conditionsTotalDoses:t},U(!1)))},[g,f,x]);const z=y.useCallback(()=>{if(!H)return!1;const e=K.current.tableRowCount;K.current.conditionsTotalDoses;const n=B(g,f);if(n&&n.length>0){if(E.current=!0,p(n),V.current={tableRowCount:e,conditionsTotalDoses:n.reduce((e,t)=>e+(parseInt(t.totalDoses)||0),0)},setTimeout(()=>{E.current=!1},0),U(!1),t.selectedPatient&&t.tdmDrug){const e=g.filter(e=>!e.isTitle&&e.timeStr).sort((e,t)=>{const n=new Date(e.timeStr);return new Date(t.timeStr).getTime()-n.getTime()});if(e.length>0){const r=e[0],i=n.find(e=>{if(!e.firstDoseDate||!e.firstDoseTime)return!1;const t=new Date(`${e.firstDoseDate}T${e.firstDoseTime}`),n=parseInt(e.intervalHours)||12,i=parseInt(e.totalDoses)||1,s=new Date(t.getTime()+(i-1)*n*60*60*1e3),a=new Date(r.timeStr);return a>=t&&a<=s})||n[n.length-1];if(i){const e=l(i.route),n="정맥"===e?1:2;Zn(t.selectedPatient.id,t.tdmDrug.drugName,{amount:parseFloat(i.dosage)||0,tau:parseFloat(i.intervalHours)||12,cmt:n,route:e,infusionTime:parseFloat(i.injectionTime)||void 0})}}}return!0}return!1},[H,g,f,t.selectedPatient,t.tdmDrug]);y.useEffect(()=>{t.onUpdateNeeded&&t.onUpdateNeeded(H,K.current,z)},[H,z,t.onUpdateNeeded]);const B=(e,t)=>{const n=e.filter(e=>!e.isTitle&&e.timeStr);if(0===n.length)return t;const r=n.length;t.reduce((e,t)=>e+(parseInt(t.totalDoses)||0),0);const i=[...t].sort((e,t)=>{if(!(e.firstDoseDate&&e.firstDoseTime&&t.firstDoseDate&&t.firstDoseTime))return 0;const n=new Date(`${e.firstDoseDate}T${e.firstDoseTime}`),r=new Date(`${t.firstDoseDate}T${t.firstDoseTime}`);return n.getTime()-r.getTime()}),s=[...n].sort((e,t)=>{const n=new Date(e.timeStr),r=new Date(t.timeStr);return n.getTime()-r.getTime()}),a=i.map(e=>{if(!e.firstDoseDate||!e.firstDoseTime)return e;const t=new Date(`${e.firstDoseDate}T${e.firstDoseTime}`),n=parseInt(e.intervalHours)||12,r=parseInt(e.totalDoses)||1,i=new Date(t.getTime()+(r-1)*n*60*60*1e3),a=s.filter(e=>{const n=new Date(e.timeStr);return n>=t&&n<=i}).length;return a>0?{...e,totalDoses:String(a)}:e}),o=r-a.reduce((e,t)=>e+(parseInt(t.totalDoses)||0),0);if(0!==o&&a.length>0){const e=a[a.length-1],t=parseInt(e.totalDoses)||0,n=Math.max(1,t+o);a[a.length-1]={...e,totalDoses:String(n)}}return a};y.useEffect(()=>{const e=u();if(e){try{const t=localStorage.getItem(e);if(t){const e=JSON.parse(t);if(e&&e.length>0)return void p(e)}}catch(n){}t.initialConditions&&t.initialConditions.length>0&&p(t.initialConditions)}else t.initialConditions&&t.initialConditions.length>0?p(t.initialConditions):p([])},[null==(r=t.selectedPatient)?void 0:r.id,null==(i=t.tdmDrug)?void 0:i.drugName,u]),y.useEffect(()=>{const e=u();if(e)try{const t=localStorage.getItem(e),n=t?JSON.parse(t):null,r=JSON.stringify(f);if(n&&JSON.stringify(n)===r)return;localStorage.setItem(e,r)}catch(t){}},[f,u]),y.useEffect(()=>{A.current&&A.current(f)},[f]),y.useEffect(()=>{b&&j(!1)},[b]),y.useEffect(()=>{let e=!1;const n=u();if(n)try{const e=localStorage.getItem(n);if(e){const t=JSON.parse(e);if(t&&t.length>0)return}}catch(r){}if(t.initialConditions&&t.initialConditions.length>0&&(p(t.initialConditions),e=!0),t.initialTableData){E.current=!0;const n=t.initialTableData.map(e=>e.isTitle||"정맥"!==e.route||e.injectionTime&&"-"!==e.injectionTime?e.isTitle||"정맥"===e.route||"0"!==e.injectionTime?e:{...e,injectionTime:"-"}:{...e,injectionTime:"0"});h(n),e=!0}void 0!==t.initialIsTableGenerated&&(v(t.initialIsTableGenerated),e=!0),e&&setTimeout(()=>{E.current=!1},0)},[t.initialConditions,t.initialTableData,t.initialIsTableGenerated]);const W=[{value:"경구",label:"경구 (oral)",disabled:"vancomycin"===(null==(a=null==(s=t.tdmDrug)?void 0:s.drugName)?void 0:a.toLowerCase())},{value:"정맥",label:"정맥 (IV)"}],G=e=>{if(!e.firstDoseDate||!e.firstDoseTime)return"날짜와 시간을 입력해주세요";const t=e.unit?e.unit:"mg",n=e.route||"-",r=e.dosage?`${e.dosage} ${t}`:`0 ${t}`,i="정맥"===e.route&&e.injectionTime?` (${e.injectionTime})`:"",s=e.intervalHours?`${e.intervalHours}시간 간격`:"간격 정보 없음",a=e.totalDoses?`${e.totalDoses}회`:"횟수 정보 없음";return`${n}, ${r}${i}, ${s}, ${e.firstDoseDate||"날짜 정보 없음"} ${e.firstDoseTime||""}부터 ${a} 투약`.trim()},J=(e,n)=>{c(r=>{var i,s,a,o;const l={...r,[e]:n};if("route"===e&&(null==(i=t.tdmDrug)?void 0:i.drugName)){if("vancomycin"===(null==(s=t.tdmDrug.drugName)?void 0:s.toLowerCase())&&("경구"===n||"oral"===n))return alert("반코마이신은 현재 정맥 투약 모델만 지원합니다.\n정맥 투약 경로를 선택해주세요."),r;"cyclosporin"!==(null==(a=t.tdmDrug.drugName)?void 0:a.toLowerCase())&&"cyclosporine"!==(null==(o=t.tdmDrug.drugName)?void 0:o.toLowerCase())||"경구"!==n&&"oral"!==n?l.dosageForm="":l.dosageForm||(l.dosageForm="capsule/tablet");const e=((e,t)=>{if(!e||!t)return"mg";const n=e.toLowerCase(),r=t.toLowerCase();if("vancomycin"===n)return"mg";if("cyclosporin"===n){if("정맥"===r||"iv"===r)return"mg";if("경구"===r||"oral"===r)return"mg"}return"mg"})(t.tdmDrug.drugName,n);e&&(l.unit=e)}return l})};y.useEffect(()=>{if(0===f.length)return F.current=null,void(L.current=null);if(f.some(e=>!(e=>{if(!(e.route&&e.dosage&&e.unit&&e.intervalHours&&e.firstDoseDate&&e.firstDoseTime&&e.totalDoses))return!1;if("정맥"===e.route||"IV"===e.route){const t=(e.injectionTime??"").toString().trim();if(!t||"-"===t)return!1}return!0})(e)))return;const e=(e=>{const t=e.map(e=>({id:String(e.id??""),route:e.route??"",dosage:e.dosage??"",unit:e.unit??"",intervalHours:e.intervalHours??"",injectionTime:"정맥"===e.route||"IV"===e.route?e.injectionTime??"":"",firstDoseDate:e.firstDoseDate??"",firstDoseTime:e.firstDoseTime??"",totalDoses:e.totalDoses??""}));return t.sort((e,t)=>e.id.localeCompare(t.id)),JSON.stringify(t)})(f);if(e===F.current)return;if(e===L.current&&e!==F.current)return;L.current=e;(()=>{var e;if(0===f.length)return alert("최소 1개의 조건을 추가해주세요!"),!1;for(let t of f){if(!(t.totalDoses&&t.intervalHours&&t.firstDoseDate&&t.firstDoseTime&&t.dosage&&t.route&&t.unit))return alert("모든 필드를 입력해주세요!"),!1;if("정맥"===t.route||"IV"===t.route){const n=null==(e=t.injectionTime)?void 0:e.trim();if(!n||""===n||"-"===n)return alert("정맥 투약 경로를 선택한 조건이 있습니다. 주입시간(분)을 반드시 입력해주세요.\n\nbolus 투여 시에는 0을 입력해주세요."),!1;const r=parseFloat(n);if(isNaN(r)||r<0)return alert("주입시간은 0 이상의 숫자로 입력해주세요.\n\nbolus 투여 시에는 0을 입력해주세요."),!1}}const n=f.map(e=>{const t=parseInt(e.totalDoses),n=parseInt(e.intervalHours),r=`${e.firstDoseDate}T${e.firstDoseTime}`,i=new Date(r),s=new Date(i.getTime()+(t-1)*n*60*60*1e3);return{start:i,end:s}});for(let t=0;t<n.length;t++)for(let e=t+1;e<n.length;e++)if(n[t].start<=n[e].end&&n[e].start<=n[t].end)return R("중복된 투약일정이 있습니다. 투약일시를 다시 확인해주세요."),!1;let r=[];r.push({id:"title",round:"회차",time:"투약 시간",amount:"투약용량",route:"투약경로",injectionTime:"주입시간",isTitle:!0});let i=[];f.forEach(e=>{const t=parseInt(e.totalDoses),n=parseInt(e.intervalHours),r=e.unit,s=`${e.firstDoseDate}T${e.firstDoseTime}`,a=new Date(s),o=e.route,l=e.injectionTime;for(let d=0;d<t;d++){const s=new Date(a.getTime()+d*n*60*60*1e3);i.push({id:`${e.id}_${d+1}`,conditionId:e.id,doseIndex:d+1,totalDoses:t,time:s,timeStr:`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}-${String(s.getDate()).padStart(2,"0")} ${String(s.getHours()).padStart(2,"0")}:${String(s.getMinutes()).padStart(2,"0")}`,amount:`${e.dosage} ${r}`,route:o,injectionTime:"정맥"===o&&l?l:"-",isTitle:!1})}});const s=new Set;for(const t of i){if(s.has(t.timeStr))return alert("중복된 투약일정이 있습니다. 투약일시를 다시 확인해주세요."),!1;s.add(t.timeStr)}if(i.sort((e,t)=>e.time-t.time),i.forEach((e,t)=>{e.round=`${t+1} 회차`}),r=[r[0],...i],i.length>0&&t.selectedPatient&&t.tdmDrug){const e=i[i.length-1],n=f.find(t=>t.id===e.conditionId);if(n){const e=l(n.route),r="정맥"===e?1:2;Zn(t.selectedPatient.id,t.tdmDrug.drugName,{amount:parseFloat(n.dosage)||0,tau:parseFloat(n.intervalHours)||12,cmt:r,route:e,infusionTime:parseFloat(n.injectionTime)||void 0})}}if(h(r),v(!0),t.onTableGenerated&&t.onTableGenerated(),T(new Set),t.onSaveRecords&&!b){const e=r.filter(e=>!e.isTitle).map(e=>{const t=f.find(t=>t.id===e.conditionId);return{timeStr:e.timeStr,amount:e.amount,route:e.route,injectionTime:e.injectionTime,conditionId:e.conditionId,intervalHours:t?Number(t.intervalHours):void 0}});t.onSaveRecords(e)}return!0})()&&(F.current=e)},[f]);const q=(e,n,r)=>{h(i=>i.map(i=>{var s,a;if(i.id===e){const e={...i,[n]:r};if("timeStr"===n&&r){let t=r.toString().replace(/undefined/g,"").trim();if(/^\d{12}$/.test(t)){const e=t.substring(0,4),n=t.substring(4,6),r=t.substring(6,8),i=t.substring(8,10),s=t.substring(10,12);t=`${e}-${n}-${r} ${i}:${s}`}else if(/^\d{11}$/.test(t)){const e=t.substring(0,4),n=t.substring(4,6),r=t.substring(6,8),i=t.substring(8,10),s=t.substring(10,11);t=`${e}-${n}-${r} ${i}:0${s}`}else if(/^\d{10}$/.test(t)){const e=t.substring(0,4),n=t.substring(4,6),r=t.substring(6,8),i=t.substring(8,10);t=`${e}-${n}-${r} ${i}:00`}else if(t.includes(" ")&&t.includes(":")&&!t.includes("-")){const e=t.split(" ");if(4===e.length){const[n,r,i,s]=e;t=`${n}-${r.padStart(2,"0")}-${i.padStart(2,"0")} ${s}`}}if(t.includes(" ")&&t.includes("-")&&t.includes(":")){const n=t.split(" ");2===n.length&&(e.date=n[0],e.time=n[1])}else t.includes(":")&&(e.time=t,e.date||(e.date=(new Date).toISOString().split("T")[0]));e.timeStr=t}if("route"===n){if("vancomycin"===(null==(a=null==(s=t.tdmDrug)?void 0:s.drugName)?void 0:a.toLowerCase())&&("경구"===r||"oral"===r))return alert("반코마이신은 현재 정맥 투약 모델만 지원합니다.\n정맥 투약 경로를 선택해주세요."),i;"정맥"===r||"IV"===r?e.injectionTime&&"-"!==e.injectionTime||(e.injectionTime=""):e.injectionTime="-"}return e}return i}))},Y=(e,t)=>{h(n=>n.map(n=>{if(n.id===e&&!n.isTitle){let e,r,i=n.timeStr||"";if(i=i.toString().replace(/undefined/g,"").trim(),i.includes(" ")&&i.includes("-")&&i.includes(":")){const t=i.split(" ");2===t.length&&(e=t[0],r=t[1])}else i.includes(":")?(r=i,e=n.date||(new Date).toISOString().split("T")[0]):(e=(new Date).toISOString().split("T")[0],r="09:00");const s=r.split(":");if(s.length>=2){parseInt(s[0],10),parseInt(s[1],10);const i=new Date(new Date(`${e}T${r}`));i.setMinutes(i.getMinutes()+("plus"===t?1:-1));const a=`${i.getFullYear()}-${(i.getMonth()+1).toString().padStart(2,"0")}-${i.getDate().toString().padStart(2,"0")}`,o=`${i.getHours().toString().padStart(2,"0")}:${i.getMinutes().toString().padStart(2,"0")}`,l=`${a} ${o}`;return{...n,timeStr:l,date:a,time:o}}{const e=(new Date).toISOString().split("T")[0],t="09:00";return{...n,timeStr:`${e} ${t}`,date:e,time:t}}}return n}))},X=e=>{e.preventDefault()},Z=(new Date).toISOString().slice(0,10);return e.jsxs("div",{style:{padding:"0",fontFamily:"Arial, sans-serif",color:$?"#e0e6f0":"#333"},children:[e.jsx("div",{style:{width:"100%",margin:0,padding:"0 0 40px 0"},children:e.jsxs("div",{children:[e.jsxs("div",{style:{padding:"20px",borderRadius:"8px",marginBottom:"30px",border:$?"1px solid #334155":"1px solid #dee2e6"},children:[e.jsx("h1",{style:{marginBottom:20,color:$?"#e0e6f0":"#111827",fontSize:"24px",fontWeight:700,letterSpacing:"-0.02em"},children:"1단계: 처방 내역을 입력하세요"}),e.jsxs("div",{style:{marginBottom:20,color:$?"#9ca3af":"#6b7280",fontSize:"14px",lineHeight:"1.5"},children:[e.jsx("div",{style:{marginBottom:"8px"},children:"• 처방 내역을 입력하면 하단에 ‘상세 투약 기록’ 테이블이 자동으로 생성됩니다."}),e.jsx("div",{style:{marginBottom:"8px"},children:"• 처방 내역 변경이 있었다면 실제 처방에 일치하도록 새로운 처방 내역을 입력해야 합니다. (예: 1월 4일은 경구 투약, 1월 5일부터는 정맥 주입한 경우 처방 내역을 2개 등록)"}),e.jsx("div",{children:"• Vancomycin은 현재 정맥(IV) 투약 모델만 지원됩니다."})]}),e.jsx("div",{style:{padding:"20px",marginBottom:"20px",borderRadius:"8px",background:$?"#23293a":"white"},children:e.jsxs("div",{style:{display:"flex",flexWrap:"wrap",gap:"15px",marginBottom:"15px",alignItems:"flex-end"},children:[e.jsxs("div",{style:{flex:"1 1 120px",minWidth:"100px",maxWidth:"100%"},children:[e.jsx("label",{style:{display:"block",marginBottom:8,fontWeight:"bold",color:$?"#e0e6f0":"#495057",fontSize:"13px"},children:"투약 경로"}),e.jsxs("select",{value:d.route,onChange:e=>J("route",e.target.value),style:{width:"100%",padding:"8px 12px",border:$?"1px solid #334155":"1px solid #ced4da",borderRadius:"6px",fontSize:"14px",backgroundColor:$?"#1e293b":"#fff",height:"40px",boxSizing:"border-box",color:$?"#e0e6f0":"#495057"},children:[e.jsx("option",{value:"",children:"투약 경로 선택"}),W.map(t=>e.jsx("option",{value:t.value,disabled:t.disabled,style:{backgroundColor:t.disabled?$?"#374151":"#e5e7eb":$?"#1e293b":"#fff",color:t.disabled?$?"#6b7280":"#9ca3af":$?"#e0e6f0":"#495057"},children:t.label},t.value))]})]}),(null==(o=t.tdmDrug)?void 0:o.drugName)&&("cyclosporin"===t.tdmDrug.drugName.toLowerCase()||"cyclosporine"===t.tdmDrug.drugName.toLowerCase())&&("경구"===d.route||"oral"===d.route)&&e.jsxs("div",{style:{flex:"1 1 120px",minWidth:"100px",maxWidth:"100%"},children:[e.jsx("label",{style:{display:"block",marginBottom:8,fontWeight:"bold",color:$?"#e0e6f0":"#495057",fontSize:"13px"},children:"제형"}),e.jsxs("select",{value:d.dosageForm,onChange:e=>J("dosageForm",e.target.value),style:{width:"100%",padding:"8px 12px",border:$?"1px solid #334155":"1px solid #ced4da",borderRadius:"6px",fontSize:"14px",backgroundColor:$?"#1e293b":"#fff",height:"40px",boxSizing:"border-box",color:$?"#e0e6f0":"#495057"},children:[e.jsx("option",{value:"",children:"제형을 선택해주세요"}),e.jsx("option",{value:"capsule/tablet",children:"캡슐/정제"}),e.jsx("option",{value:"oral liquid",children:"경구현탁/액제"})]})]}),e.jsxs("div",{style:{flex:"1 1 120px",minWidth:"100px",maxWidth:"100%"},children:[e.jsx("label",{style:{display:"block",marginBottom:8,fontWeight:"bold",color:$?"#e0e6f0":"#495057",fontSize:"13px"},children:"투약 용량"}),e.jsx("input",{type:"number",value:d.dosage,onChange:e=>J("dosage",e.target.value),placeholder:"예: 500",style:{width:"100%",padding:"8px 12px",border:$?"1px solid #334155":"1px solid #ced4da",borderRadius:"6px",fontSize:"14px",backgroundColor:$?"#1e293b":"#fff",height:"40px",boxSizing:"border-box",color:$?"#e0e6f0":"#495057"}})]}),e.jsxs("div",{style:{flex:"1 1 120px",minWidth:"100px",maxWidth:"100%"},children:[e.jsx("label",{style:{display:"block",marginBottom:8,fontWeight:"bold",color:$?"#e0e6f0":"#495057",fontSize:"13px"},children:"단위"}),e.jsx("select",{value:d.unit,onChange:e=>J("unit",e.target.value),style:{width:"100%",padding:"8px 12px",border:$?"1px solid #334155":"1px solid #ced4da",borderRadius:"6px",fontSize:"14px",backgroundColor:$?"#1e293b":"#fff",height:"40px",boxSizing:"border-box",color:$?"#e0e6f0":"#495057"},children:["mg","g","mcg"].map(t=>e.jsx("option",{value:t,children:t},t))})]}),e.jsxs("div",{style:{flex:"1 1 120px",minWidth:"100px",maxWidth:"100%"},children:[e.jsx("label",{style:{display:"block",marginBottom:8,fontWeight:"bold",color:$?"#e0e6f0":"#495057",fontSize:"13px"},children:"투약 간격(시간)"}),e.jsx("input",{type:"number",value:d.intervalHours,onChange:e=>J("intervalHours",e.target.value),placeholder:"예: 8",style:{width:"100%",padding:"8px 12px",border:$?"1px solid #334155":"1px solid #ced4da",borderRadius:"6px",fontSize:"14px",backgroundColor:$?"#1e293b":"#fff",height:"40px",boxSizing:"border-box",color:$?"#e0e6f0":"#495057"}})]}),e.jsxs("div",{style:{flex:"1 1 120px",minWidth:"100px",maxWidth:"100%"},children:[e.jsx("label",{style:{display:"block",marginBottom:8,fontWeight:"bold",color:$?"#e0e6f0":"#495057",fontSize:"13px"},children:"주입시간 (분)"}),e.jsx("input",{type:"text",value:d.injectionTime,onChange:e=>J("injectionTime",e.target.value),placeholder:"bolus 투여 시 0 입력",disabled:"정맥"!==d.route,style:{width:"100%",padding:"8px 12px",border:$?"1px solid #334155":"1px solid #ced4da",borderRadius:"6px",fontSize:"14px",backgroundColor:"정맥"!==d.route?$?"#1a1f2e":"#f8f9fa":$?"#1e293b":"#fff",height:"40px",boxSizing:"border-box",color:$?"#e0e6f0":"#495057"}})]}),e.jsxs("div",{style:{flex:"1 1 120px",minWidth:"100px",maxWidth:"100%"},children:[e.jsx("label",{style:{display:"block",marginBottom:8,fontWeight:"bold",color:$?"#e0e6f0":"#495057",fontSize:"13px"},children:"총 투약 횟수"}),e.jsx("input",{type:"number",value:d.totalDoses,onChange:e=>J("totalDoses",e.target.value),placeholder:"예: 10",style:{width:"100%",padding:"8px 12px",border:$?"1px solid #334155":"1px solid #ced4da",borderRadius:"6px",fontSize:"14px",backgroundColor:$?"#1e293b":"#fff",height:"40px",boxSizing:"border-box",color:$?"#e0e6f0":"#495057"}})]}),e.jsxs("div",{style:{flex:"1 1 180px",minWidth:"180px",maxWidth:"100%"},children:[e.jsx("label",{style:{display:"block",marginBottom:8,fontWeight:"bold",color:$?"#e0e6f0":"#495057",fontSize:"13px"},children:"최초 투약 날짜/시간"}),e.jsx("input",{type:"datetime-local",value:d.firstDoseDate&&d.firstDoseTime?`${d.firstDoseDate}T${d.firstDoseTime}`:"",onChange:e=>(e=>{if(!e)return void c(e=>({...e,firstDoseDate:"",firstDoseTime:""}));const[t,n=""]=e.split("T"),r=n.slice(0,5);c(e=>({...e,firstDoseDate:t||"",firstDoseTime:r||""}))})(e.target.value),style:{width:"100%",padding:"8px 12px",border:$?"1px solid #334155":"1px solid #ced4da",borderRadius:"6px",fontSize:"14px",backgroundColor:$?"#1e293b":"#fff",height:"40px",boxSizing:"border-box",color:$?"#e0e6f0":"#495057"},max:`${Z}T23:59`})]}),e.jsx("div",{style:{flex:"0 0 60px",minWidth:"60px",marginLeft:"auto",display:"flex",justifyContent:"flex-end"},children:e.jsx("button",{onClick:()=>{var e;const t=(d.firstDoseDate||"").trim(),n=(d.firstDoseTime||"").trim();if(!t||!n)return void alert("최초 투약 날짜와 시간을 모두 입력해주세요.");const r=new Date(`${t}T${n}`);if(Number.isNaN(r.getTime()))return void alert("날짜와 시간 형식이 올바르지 않습니다.");if(r>new Date)return void alert("투약 날짜/시간은 현재 시각 이후로 입력할 수 없습니다.");const i={...d,firstDoseDate:t,firstDoseTime:n};if(i.unit){if("정맥"===i.route||"IV"===i.route){const t=null==(e=i.injectionTime)?void 0:e.trim();if(!t||""===t||"-"===t)return void alert("정맥 투약 경로를 선택하셨습니다. 주입시간(분)을 반드시 입력해주세요.\n\nbolus 투여 시에는 0을 입력해주세요.");const n=parseFloat(t);if(isNaN(n)||n<0)return void alert("주입시간은 0 이상의 숫자로 입력해주세요.\n\nbolus 투여 시에는 0을 입력해주세요.")}if(S)p(e=>e.map(e=>e.id===C?{...i,id:C}:e)),k(!1),I(null);else{const e={id:Date.now(),...i};p(t=>[...t,e])}c({route:"",dosage:"",unit:"mg",intervalHours:"",injectionTime:"",firstDoseDate:"",firstDoseTime:"",totalDoses:""})}else alert("단위를 선택해주세요!")},style:{width:"60px",height:"40px",backgroundColor:$?"#0f172a":"#000",color:"#fff",border:"none",borderRadius:"10px",fontWeight:400,fontSize:"13px",cursor:"pointer",transition:"background-color 0.2s, opacity 0.2s"},onMouseOver:e=>{e.target.style.backgroundColor=$?"#1f2937":"#111827"},onMouseOut:e=>{e.target.style.backgroundColor=$?"#0f172a":"#000"},children:"확인"})})]})}),e.jsxs("div",{style:{marginTop:"20px"},children:[e.jsx("h3",{style:{marginBottom:"10px",color:$?"#e0e6f0":"#1f2937",fontSize:"18px",fontWeight:600,letterSpacing:"-0.01em"},children:"처방 내역 summary"}),e.jsx("div",{style:{border:$?"1px solid #334155":"1px solid #8EC5FF",borderRadius:"8px",padding:"15px",background:$?"#1f2a37":"#EFF6FF",maxHeight:"200px",overflowY:"auto"},children:0===f.length?e.jsx("div",{style:{color:$?"#9ca3af":"#6c757d",fontStyle:"italic"},children:"처방 내역을 추가해주세요."}):f.map((t,n)=>e.jsx("div",{style:{borderBottom:f.length>1&&n!==f.length-1?$?"1px dashed #1f2937":"1px dashed #94a3b8":"none",paddingBottom:f.length>1&&n!==f.length-1?"10px":"0",marginBottom:f.length>1&&n!==f.length-1?"10px":"0",fontSize:"13px",color:$?"#9ca3af":"#6c757d"},children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"12px",flexWrap:"wrap",width:"100%"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"10px",flex:1},children:[e.jsxs("span",{style:{fontWeight:"bold",color:$?"#60a5fa":"#007bff"},children:["기록 ",n+1,":"]}),e.jsx("span",{style:{fontSize:"16px",fontWeight:700,color:$?"#f3f4f6":"#000000"},children:G(t)})]}),e.jsxs("div",{style:{display:"flex",gap:"8px"},children:[e.jsx("button",{onClick:()=>(e=>{const t=f.find(t=>t.id===e);t&&(c({route:t.route,dosage:t.dosage,unit:t.unit,intervalHours:t.intervalHours,injectionTime:t.injectionTime,firstDoseDate:t.firstDoseDate,firstDoseTime:t.firstDoseTime,totalDoses:t.totalDoses}),k(!0),I(e))})(t.id),style:{padding:"4px 8px",backgroundColor:$?"#0f172a":"#000",color:"#fff",border:"1px solid",borderColor:$?"#1f2937":"#000",borderRadius:"4px",cursor:"pointer",fontSize:"11px"},onMouseOver:e=>{e.target.style.backgroundColor=$?"#1f2937":"#111827"},onMouseOut:e=>{e.target.style.backgroundColor=$?"#0f172a":"#000"},children:"수정"}),e.jsx("button",{onClick:()=>(e=>{p(t=>t.filter(t=>t.id!==e));let t=[],n=!1;h(r=>{if(!r||0===r.length)return r;const i=r.filter(n=>(!n.isTitle&&n.conditionId===e&&t.push(n.id),n.isTitle||n.conditionId!==e)),s=i.find(e=>e.isTitle),a=i.filter(e=>!e.isTitle).map((e,t)=>({...e,round:`${t+1} 회차`}));return n=a.length>0,s?[s,...a]:a}),n||v(!1),t.length>0&&T(e=>{const n=new Set(e);return t.forEach(e=>n.delete(e)),n})})(t.id),style:{padding:"4px 8px",backgroundColor:$?"#4b5563":"#fff",color:$?"#fff":"#111827",border:"1px solid",borderColor:$?"#6b7280":"#000",borderRadius:"4px",cursor:"pointer",fontSize:"11px"},onMouseOver:e=>{e.target.style.backgroundColor=$?"#6b7280":"#f3f4f6"},onMouseOut:e=>{e.target.style.backgroundColor=$?"#4b5563":"#fff"},children:"삭제"})]})]})},t.id))})]})]}),e.jsxs("div",{style:{background:$?"#23293a":"white",padding:"20px",borderRadius:"8px",border:$?"1px solid #334155":"1px solid #dee2e6"},children:[e.jsx("h2",{style:{marginBottom:10,color:$?"#e0e6f0":"#111827",fontSize:"20px",fontWeight:700,letterSpacing:"-0.01em"},children:"2단계: 투약 기록을 확인하세요"}),e.jsxs("div",{style:{marginBottom:20,color:$?"#9ca3af":"#6b7280",fontSize:"14px",lineHeight:"1.5"},children:[e.jsx("div",{style:{marginBottom:"8px"},children:"• 투약 기록 정보를 정확히 입력할 수록 분석의 정확도가 높아집니다."}),e.jsx("div",{children:"• 투약 시간을 선택해서 정확한 시간으로 수정할 수 있습니다."})]}),e.jsx("div",{style:{overflowX:"auto"},children:e.jsx("table",{style:{width:"100%",borderCollapse:"collapse",border:$?"1px solid #334155":"1px solid #dee2e6",tableLayout:"fixed",background:$?"#23293a":"white"},children:e.jsx("tbody",{children:g.length>0?g.map(t=>e.jsxs("tr",{draggable:!t.isTitle,onDragStart:e=>{return!t.isTitle&&(n=t.id,void w(n));var n},onDragOver:X,onDrop:e=>!t.isTitle&&((e,t)=>{if(e.preventDefault(),N===t||"title"===N)return;const n=g.findIndex(e=>e.id===N),r=g.findIndex(e=>e.id===t);if(-1===n||-1===r)return;const i=[...g],s=i[n];i.splice(n,1),i.splice(r,0,s),i.forEach((e,t)=>{e.isTitle||(e.round=`${t+1}`)}),h(i),w(null)})(e,t.id),style:{backgroundColor:t.isTitle?$?"#2d3650":"#e9ecef":$?"#23293a":"white",fontWeight:t.isTitle?"bold":"normal",cursor:t.isTitle?"default":"grab",color:$?"#e0e6f0":void 0},children:[e.jsx("td",{style:{padding:"12px",border:$?"1px solid #334155":"1px solid #dee2e6",textAlign:"center",width:"12%",color:$?"#e0e6f0":void 0,background:$&&t.isTitle?"#2d3650":void 0},children:t.isTitle?t.round:e.jsx("div",{style:{textAlign:"center",width:"100%",color:$?"#e0e6f0":void 0},children:t.round})}),e.jsx("td",{style:{padding:"12px",border:$?"1px solid #334155":"1px solid #dee2e6",textAlign:"center",width:"25%",color:$?"#e0e6f0":void 0,background:$&&t.isTitle?"#2d3650":void 0},children:t.isTitle?t.time:e.jsxs("div",{style:{display:"flex",gap:"2px",alignItems:"center"},children:[e.jsx("div",{style:{flex:1},children:e.jsx(or,{row:t,onUpdate:q,isDarkMode:$})}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"1px"},children:[e.jsx("button",{type:"button",onClick:()=>Y(t.id,"plus"),style:{width:"20px",height:"14px",border:"1px solid #d1d5db",borderRadius:"2px 2px 0 0",background:$?"#374151":"#f9fafb",color:$?"#e0e6f0":"#374151",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"10px",fontWeight:"bold",padding:"0"},onMouseOver:e=>{e.target.style.background=$?"#4b5563":"#e5e7eb"},onMouseOut:e=>{e.target.style.background=$?"#374151":"#f9fafb"},children:"▲"}),e.jsx("button",{type:"button",onClick:()=>Y(t.id,"minus"),style:{width:"20px",height:"14px",border:"1px solid #d1d5db",borderRadius:"0 0 2px 2px",background:$?"#374151":"#f9fafb",color:$?"#e0e6f0":"#374151",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"10px",fontWeight:"bold",padding:"0"},onMouseOver:e=>{e.target.style.background=$?"#4b5563":"#e5e7eb"},onMouseOut:e=>{e.target.style.background=$?"#374151":"#f9fafb"},children:"▼"})]})]})}),e.jsx("td",{style:{padding:"12px",border:$?"1px solid #334155":"1px solid #dee2e6",textAlign:"center",width:"18%",color:$?"#e0e6f0":void 0,background:$&&t.isTitle?"#2d3650":void 0},children:t.isTitle?t.amount:e.jsx("div",{style:{textAlign:"center",width:"100%",color:$?"#e0e6f0":void 0},children:t.amount})}),e.jsx("td",{style:{padding:"12px",border:$?"1px solid #334155":"1px solid #dee2e6",textAlign:"center",width:"18%",color:$?"#e0e6f0":void 0,background:$&&t.isTitle?"#2d3650":void 0},children:t.isTitle?t.route:e.jsx("div",{style:{textAlign:"center",width:"100%",color:$?"#e0e6f0":void 0},children:t.route})}),e.jsx("td",{style:{padding:"12px",border:$?"1px solid #334155":"1px solid #dee2e6",textAlign:"center",width:"18%",color:$?"#e0e6f0":void 0,background:$&&t.isTitle?"#2d3650":void 0},children:t.isTitle?t.injectionTime:e.jsx(ar,{row:t,onUpdate:q,isDarkMode:$,readOnly:!0})}),e.jsx("td",{style:{padding:"12px",border:$?"1px solid #334155":"1px solid #dee2e6",textAlign:"center",width:"10%",color:$?"#e0e6f0":void 0,background:$&&t.isTitle?"#2d3650":void 0},children:t.isTitle?"삭제":e.jsx("input",{type:"checkbox",checked:D.has(t.id),onChange:()=>{return e=t.id,void T(t=>{const n=new Set(t);return n.has(e)?n.delete(e):n.add(e),n});var e},style:{width:"16px",height:"16px",cursor:"pointer",accentColor:$?"#1B44C8":void 0}})})]},t.id)):e.jsx("tr",{children:e.jsx("td",{colSpan:"6",style:{padding:"40px",textAlign:"center",color:"#6b7280",fontStyle:"italic"},children:"처방 내역을 입력하면 ‘상세 투약 기록’ 테이블이 자동으로 생성됩니다."})})})})}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginTop:"15px"},children:[e.jsx("button",{onClick:()=>{if(window.confirm("투약 기록 테이블과 처방 내역 summary를 모두 삭제하시겠습니까?")){h([]),p([]),v(!1),T(new Set),c({route:"",dosage:"",unit:"mg",intervalHours:"",injectionTime:"",firstDoseDate:"",firstDoseTime:"",totalDoses:""}),k(!1),I(null);const t=u();if(t)try{localStorage.removeItem(t)}catch(e){}}},style:{padding:"8px 16px",backgroundColor:$?"#23293a":"#fff",color:$?"#ef4444":"#dc2626",border:$?"1px solid #7f1d1d":"1px solid #fecaca",borderRadius:"8px",cursor:"pointer",fontWeight:400,fontSize:"15px",transition:"background 0.2s, color 0.2s"},onMouseOver:e=>{e.target.style.backgroundColor=$?"#7f1d1d":"#fef2f2"},onMouseOut:e=>{e.target.style.backgroundColor=$?"#23293a":"#fff"},children:"🗑️ 전체 삭제"}),e.jsxs("div",{style:{display:"flex",gap:"10px"},children:[e.jsx("button",{onClick:()=>{const e=Math.max(0,...g.filter(e=>!e.isTitle).map(e=>parseInt(e.id)||0))+1,t=g.filter(e=>!e.isTitle&&e.timeStr).sort((e,t)=>{if(e.timeStr&&t.timeStr){const n=new Date(e.timeStr);return new Date(t.timeStr).getTime()-n.getTime()}return 0})[0],n=f.length>0?[...f].sort((e,t)=>{if(!(e.firstDoseDate&&e.firstDoseTime&&t.firstDoseDate&&t.firstDoseTime))return 0;const n=new Date(`${e.firstDoseDate}T${e.firstDoseTime}`);return new Date(`${t.firstDoseDate}T${t.firstDoseTime}`).getTime()-n.getTime()})[0]:null;let r,i=12;if(t&&t.timeStr){n&&n.intervalHours&&(i=parseInt(n.intervalHours)||12);const e=new Date(t.timeStr);r=new Date(e.getTime()+60*i*60*1e3)}else r=new Date,r.setHours(9,0,0,0);const s=r.toISOString().split("T")[0],a=r.toTimeString().slice(0,5),o=g.filter(e=>!e.isTitle&&e.amount&&"0"!==e.amount).map(e=>e.amount);let d="500 mg";if(o.length>0){const e={};o.forEach(t=>{e[t]=(e[t]||0)+1});d=Object.keys(e).reduce((t,n)=>e[t]>e[n]?t:n)}else n&&n.dosage&&n.unit&&(d=`${n.dosage} ${n.unit}`);let c="경구";if(n&&n.route)c=l(n.route);else{const e=g.filter(e=>!e.isTitle&&e.route).map(e=>e.route);if(e.length>0){const t={};e.forEach(e=>{t[e]=(t[e]||0)+1});c=Object.keys(t).reduce((e,n)=>t[e]>t[n]?e:n)}}let u="-";if("정맥"===c)if(n&&n.injectionTime)u=String(n.injectionTime);else{const e=g.filter(e=>!e.isTitle&&"정맥"===e.route&&e.injectionTime&&"-"!==e.injectionTime).map(e=>e.injectionTime);if(e.length>0){const t={};e.forEach(e=>{t[e]=(t[e]||0)+1});u=Object.keys(t).reduce((e,n)=>t[e]>t[n]?e:n)}}const m={id:String(e),round:`${e}회차`,date:s,time:a,timeStr:`${s} ${a}`,amount:d,route:c,injectionTime:u,isTitle:!1,conditionId:(null==n?void 0:n.id)||null};h(e=>[...e,m])},style:{padding:"8px 16px",backgroundColor:$?"#23293a":"#fff",color:$?"#e0e6f0":"#222",border:$?"1px solid #334155":"1px solid #dee2e6",borderRadius:"8px",cursor:"pointer",fontWeight:400,fontSize:"15px",transition:"background 0.2s, color 0.2s"},onMouseOver:e=>{e.target.style.backgroundColor=$?"#334155":"#f4f6fa"},onMouseOut:e=>{e.target.style.backgroundColor=$?"#23293a":"#fff"},children:"+ 행추가"}),e.jsx("button",{onClick:()=>{0!==D.size?window.confirm(`선택된 ${D.size}개 행을 삭제하시겠습니까?`)&&(h(e=>e.filter(e=>!D.has(e.id))),T(new Set)):alert("삭제할 행을 선택해주세요!")},style:{padding:"8px 16px",backgroundColor:$?"#23293a":"#fff",color:$?"#f87171":"#fb7185",border:$?"1px solid #7f1d1d":"1px solid #ffe4e6",borderRadius:"8px",cursor:"pointer",fontWeight:400,fontSize:"15px",transition:"background 0.2s, color 0.2s"},onMouseOver:e=>{e.target.style.backgroundColor=$?"#7f1d1d":"#f4f6fa"},onMouseOut:e=>{e.target.style.backgroundColor=$?"#23293a":"#fff"},children:"선택 삭제"})]})]})]})]})}),M&&e.jsx("div",{style:{position:"fixed",top:0,left:0,width:"100vw",height:"100vh",background:"rgba(0,0,0,0.3)",zIndex:9999,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsxs("div",{style:{background:"white",borderRadius:"12px",padding:"24px 32px",boxShadow:"0 4px 24px #0002",minWidth:"320px",textAlign:"center",border:"1.5px solid #222",color:"#222",fontWeight:600},children:[e.jsx("div",{style:{fontSize:"17px",marginBottom:"18px",whiteSpace:"pre-line"},children:"중복된 투약일정이 있습니다.\n투약일시를 다시 확인해주세요."}),e.jsx("button",{onClick:()=>R(""),style:{background:"#222",color:"white",border:"none",borderRadius:"6px",padding:"8px 28px",fontSize:"15px",fontWeight:600,cursor:"pointer"},children:"확인"})]})})]})}const dr=({patients:t,prescriptions:n,selectedPatient:r,selectedPrescription:i,onAddDrugAdministration:s,setDrugAdministrations:a,drugAdministrations:o,bloodTests:l,onNext:d,onPrev:c,isCompleted:u})=>{const m=i;y.useState({drugName:(null==m?void 0:m.drugName)||"",route:"",date:"",time:"",dose:0,unit:"mg",infusionTime:void 0});const[f,p]=y.useState(!1),[g,h]=y.useState(!1),[x,v]=y.useState([]),b=y.useRef(null);Bt().format("YYYY-MM-DD");const j=r&&m?o.filter(e=>e.patientId===r.id&&e.drugName===m.drugName):[],N=y.useCallback(()=>r&&(null==m?void 0:m.drugName)?`tdmfriends:conditions:${r.id}:${m.drugName}`:null,[r,null==m?void 0:m.drugName]);return y.useEffect(()=>{if(!r)return;const e=N();if(e)try{const t=localStorage.getItem(e);if(t){const e=JSON.parse(t);v(e)}}catch(t){}},[r,null==m?void 0:m.drugName,N]),y.useEffect(()=>{if(!r)return;const e=N();if(e)try{localStorage.setItem(e,JSON.stringify(x))}catch(t){}},[x,r,null==m?void 0:m.drugName,N]),y.useEffect(()=>{},[]),e.jsx("div",{className:"space-y-6",children:e.jsxs(Q,{className:"bg-white dark:bg-slate-900 border dark:border-slate-700 text-slate-900 dark:text-slate-200",children:[e.jsxs(ee,{children:[e.jsxs(te,{className:"flex items-center gap-2",children:[e.jsx(we,{className:"h-5 w-5"}),"4단계: 투약기록",u&&e.jsx(me,{className:"h-5 w-5 text-green-600"})]}),e.jsx(ne,{children:"2단계에서 입력한 TDM 약물에 대해 7반감기 이내의 투약력을 입력하세요."})]}),e.jsxs(re,{className:"space-y-6",children:[m&&r&&e.jsxs("div",{className:"py-3 px-4 rounded bg-muted dark:bg-slate-800 mb-4",children:[e.jsxs("div",{className:"grid grid-cols-4 gap-4 mb-3",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-medium",children:"나이:"})," ",r.age]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-medium",children:"성별:"})," ",r.gender]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-medium",children:"몸무게:"})," ",r.weight,"kg"]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-medium",children:"키:"})," ",r.height,"cm"]})]}),e.jsxs("div",{className:"space-y-2 pt-2 border-t border-gray-200 dark:border-gray-600",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-medium text-gray-600 dark:text-gray-400",children:"약품명:"}),e.jsx("span",{className:"ml-2 font-semibold",children:m.drugName})]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-medium text-gray-600 dark:text-gray-400",children:"적응증:"}),e.jsx("span",{className:"ml-2",children:m.indication})]})]})]}),(!m||!r)&&e.jsx("div",{className:"py-2 px-3 rounded bg-muted dark:bg-slate-800 text-base font-semibold mb-4",children:e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"TDM 내역:"})," ",(null==m?void 0:m.drugName)||"-",", ",(null==m?void 0:m.indication)||"-"]})}),e.jsx(lr,{selectedPatient:r,tdmDrug:m,onComplete:d,onTableGenerated:()=>p(!0),initialAdministrations:j,initialConditions:x,onConditionsChange:v,onUpdateNeeded:(e,t,n)=>{b.current={needsUpdate:e,updateInfo:t,performUpdate:n}},onSaveRecords:e=>{if(r&&m){const t=e.map((e,t)=>{const n=void 0!==e.intervalHours?Number(e.intervalHours):x.length>0?Number(x[0].intervalHours):void 0;return{id:`${Date.now()}_${t}`,patientId:r.id,drugName:m.drugName,route:e.route,date:e.timeStr.split(" ")[0],time:e.timeStr.split(" ")[1],dose:Number(e.amount.split(" ")[0]),unit:e.amount.split(" ")[1]||"mg",isIVInfusion:"정맥"===e.route,infusionTime:e.injectionTime&&"-"!==e.injectionTime?parseInt(String(e.injectionTime).replace(/[^0-9]/g,"")):void 0,administrationTime:void 0,intervalHours:n}}),n=[...o.filter(e=>!(e.patientId===r.id&&e.drugName===(null==m?void 0:m.drugName))),...t];a(n)}},onRecordsChange:e=>{if(r&&m){const t=e.map((e,t)=>{const n=void 0!==e.intervalHours?Number(e.intervalHours):x.length>0?Number(x[0].intervalHours):void 0;return{id:`${Date.now()}_${t}`,patientId:r.id,drugName:m.drugName,route:e.route,date:e.timeStr.split(" ")[0],time:e.timeStr.split(" ")[1],dose:Number(e.amount.split(" ")[0]),unit:e.amount.split(" ")[1]||"mg",isIVInfusion:"정맥"===e.route,infusionTime:e.injectionTime&&"-"!==e.injectionTime?parseInt(String(e.injectionTime).replace(/[^0-9]/g,"")):"정맥"===e.route?0:void 0,administrationTime:void 0,intervalHours:n}}),n=[...o.filter(e=>!(e.patientId===r.id&&e.drugName===(null==m?void 0:m.drugName))),...t];a(n)}}}),e.jsxs("div",{className:"flex justify-between mt-6",children:[e.jsxs(ie,{variant:"outline",type:"button",onClick:c,className:"flex items-center gap-2 border-slate-300 dark:border-slate-600 text-slate-900 dark:text-slate-200",children:[e.jsx(be,{className:"h-4 w-4"}),"Lab"]}),u&&e.jsxs(ie,{onClick:async()=>{var e;if(r){if(null==(e=b.current)?void 0:e.needsUpdate){const e=b.current.updateInfo,t=`변경된 투약 기록으로 시뮬레이션을 진행합니다.\n(투약 횟수 ${e.conditionsTotalDoses}회 → ${e.tableRowCount}회)`;if(!window.confirm(t))return;b.current.performUpdate()}h(!0);try{const e=er({patients:t,prescriptions:n,bloodTests:l,drugAdministrations:o,selectedPatientId:r.id,selectedDrugName:null==m?void 0:m.drugName});if(!e)return alert("TDM 요청 데이터를 생성할 수 없습니다. 환자 정보와 처방 정보를 확인해주세요."),void h(!1);await nr({body:e,persist:!0,patientId:r.id,drugName:null==m?void 0:m.drugName}),h(!1),d()}catch(i){const e=i instanceof Error?i.message:"알 수 없는 오류",t=i instanceof Error?i.name:"Unknown",n=e.includes("CORS 오류")||e.includes("cors"),r=e.includes("네트워크 오류")||e.includes("failed to fetch"),s=e.includes("503")||e.includes("일시적");let a="TDM 분석 중 오류가 발생했습니다.\n\n";n||r?(a+="서버 접근 오류가 발생했습니다.\n",a+=`오류 유형: ${t}\n`,a+=`오류 메시지: ${e.split("\n")[0]}\n\n`,a+="서버 관리자에게 문의하거나 잠시 후 다시 시도해주세요."):s?(a+="서버 일시적 오류 (503): 서버가 일시적으로 사용 불가능한 상태입니다.\n",a+="잠시 후 다시 시도해주세요."):(a+=`오류 유형: ${t}\n`,a+=`오류 메시지: ${e}`),alert(a),h(!1)}}else d()},disabled:g,className:"flex items-center gap-2 w-[300px] bg-black dark:bg-blue-700 text-white font-bold text-lg py-3 px-6 justify-center dark:hover:bg-blue-800 disabled:opacity-60",children:[g?"처리 중...":"TDM Simulation",e.jsx(ge,{className:"h-4 w-4"})]})]})]})]})})},cr=({patients:t,prescriptions:n,bloodTests:r,selectedPatient:i,setSelectedPatient:s,onAddPatient:a,onUpdatePatient:o,onDeletePatient:l,onAddPrescription:c,setPrescriptions:u,onAddBloodTest:m,onDeleteBloodTest:f,setBloodTests:p,onAddDrugAdministration:g,drugAdministrations:h,setDrugAdministrations:x,onResetWorkflow:v})=>{const[b,j]=y.useState(null),[N,w]=y.useState(1),[D,T]=y.useState(!1);y.useEffect(()=>{if(i)try{const e=window.localStorage.getItem(`tdmfriends:prescription:${i.id}`);if(!e)return;const t=JSON.parse(e),r=t.selectedTdmId||t.newlyAddedTdmId;if(!r)return;const s=n.find(e=>e.id===r&&e.patientId===i.id)||null;s&&j(s)}catch(e){}else j(null)},[i,null==i?void 0:i.id,n]);const S=[{id:1,title:"환자 등록 및 선택",icon:pe,description:"환자를 선택하거나 신규 등록해주세요."},{id:2,title:"TDM 선택",icon:xe,description:"TDM 약물 정보를 입력합니다."},{id:3,title:"Lab",icon:je,description:"신기능 및 혈중 약물 농도 정보를 입력합니다."},{id:4,title:"투약 기록",icon:we,description:"투약 기록을 입력합니다."},{id:5,title:"Let's TDM",icon:Ne,description:"정밀의료 시뮬레이션 결과를 확인해보세요."}];!i||n.filter(e=>e.patientId===i.id),!i||r.filter(e=>e.patientId===i.id);const k=i&&b?r.filter(e=>e.patientId===i.id&&e.drugName===b.drugName):[],C=i&&b?h.filter(e=>e.patientId===i.id&&e.drugName===b.drugName):[],I=e=>{switch(e){case 1:return null!==i;case 2:return i&&null!==b;case 3:return i&&b&&k.length>0;case 4:return i&&b&&C.length>0;case 5:return i&&b&&k.length>0&&C.length>0;default:return!1}},M=()=>{N<5&&w(N+1)},R=()=>{N>1&&w(N-1)},$=()=>{if(i){const e=r.filter(e=>e.patientId!==i.id);p(e);const t=h.filter(e=>e.patientId!==i.id);x(t)}},_=S.filter(e=>I(e.id)).length,E=_/S.length*100;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(Q,{children:[e.jsxs(ee,{children:[e.jsxs(te,{className:"flex items-center gap-2",children:[e.jsx(Ne,{className:"h-5 w-5"}),"TDM 분석 워크플로우"]}),e.jsxs(ne,{children:["각 단계를 순서대로 진행해 주세요",i&&` (${i.name} 환자)`]})]}),e.jsx(re,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground",children:[e.jsxs("span",{children:["진행률: ",_," / ",S.length,"단계 완료"]}),e.jsxs("span",{children:[Math.round(E),"%"]})]}),e.jsx(un,{value:E,className:"w-full"}),e.jsx("div",{className:"grid grid-cols-5 gap-2",children:S.map(s=>{const a=s.icon,o=I(s.id),l=N===s.id,c=1===(u=s.id)||(2===u?I(1):3===u?I(2):4===u?i&&b&&k.length>0:5===u&&I(4));var u;return e.jsxs(ie,{variant:l?"default":o?"secondary":"outline",className:d("flex flex-col items-center gap-1 h-auto py-3",!c&&"opacity-50 cursor-not-allowed"),disabled:!c||5===s.id&&D,onClick:async()=>{if(c)if(5===s.id&&i&&b){T(!0);let a=!1;try{const e=er({patients:t,prescriptions:n,bloodTests:r,drugAdministrations:h,selectedPatientId:i.id,selectedDrugName:b.drugName});e?(await nr({body:e,persist:!0,patientId:i.id}),a=!0):alert("TDM 요청 데이터를 생성할 수 없습니다. 환자 정보와 처방 정보를 확인해주세요.")}catch(e){const t=e instanceof Error?e.message:"알 수 없는 오류",n=e instanceof Error?e.name:"Unknown",r=t.includes("CORS 오류")||t.includes("cors"),i=t.includes("네트워크 오류")||t.includes("failed to fetch"),s=t.includes("503")||t.includes("일시적");let a="TDM 분석 중 오류가 발생했습니다.\n\n";t.includes("반코마이신은 현재 정맥 투약 모델만 지원됩니다")||t.includes("투약 경로를 정맥으로 변경")?a=t:r||i?(a+="서버 접근 오류가 발생했습니다.\n",a+=`오류 유형: ${n}\n`,a+=`오류 메시지: ${t.split("\n")[0]}\n\n`,a+="서버 관리자에게 문의하거나 잠시 후 다시 시도해주세요.\n\n",a+="이전에 저장된 결과가 있다면 그것을 표시합니다."):s?(a+="서버 일시적 오류 (503): 서버가 일시적으로 사용 불가능한 상태입니다.\n",a+="잠시 후 다시 시도해주세요.\n\n",a+="이전에 저장된 결과가 있다면 그것을 표시합니다."):(a+=`오류 유형: ${n}\n`,a+=`오류 메시지: ${t}\n\n`,a+="이전에 저장된 결과가 있다면 그것을 표시합니다."),alert(a)}finally{T(!1)}a&&w(s.id)}else w(s.id)},children:[e.jsx("div",{className:"flex items-center gap-1",children:o?e.jsx(me,{className:"h-4 w-4"}):e.jsx(a,{className:"h-4 w-4"})}),e.jsx("span",{className:"text-xs text-center leading-tight",children:5===s.id&&D?"처리 중...":s.title})]},s.id)})})]})})]}),e.jsxs("div",{className:"min-h-[600px]",children:[1===N&&e.jsx(mn,{patients:t,selectedPatient:i,setSelectedPatient:s,onAddPatient:a,onUpdatePatient:o,onDeletePatient:l,onNext:M,isCompleted:I(1)}),2===N&&e.jsx(Un,{patients:t,prescriptions:n,selectedPatient:i,selectedPrescription:b,setSelectedPrescription:j,onAddPrescription:(e,t)=>{e?(c(e),j(e)):u(t)},onNext:M,onPrev:R,isCompleted:I(2),bloodTests:r,setBloodTests:p,drugAdministrations:h,setDrugAdministrations:x,onClearLaterStepData:$,onResetWorkflow:()=>{$(),v()}}),3===N&&e.jsx(Kn,{patients:t,bloodTests:r,selectedPatient:i,selectedPrescription:b,onAddBloodTest:m,onDeleteBloodTest:f,onNext:M,onPrev:R,isCompleted:I(3),prescriptions:n}),4===N&&e.jsx(dr,{patients:t,prescriptions:n,selectedPatient:i,selectedPrescription:b,onAddDrugAdministration:g,setDrugAdministrations:x,drugAdministrations:h,bloodTests:r,onNext:M,onPrev:R,isCompleted:I(4)}),5===N&&e.jsx(sr,{patients:t,prescriptions:n,bloodTests:r,selectedPatient:i,selectedPrescription:b,drugAdministrations:h,onPrev:R})]})]})};var ur="Switch",[mr,fr]=o(ur),[pr,gr]=mr(ur),hr=y.forwardRef((t,i)=>{const{__scopeSwitch:o,name:l,checked:d,defaultChecked:c,required:u,disabled:m,value:f="on",onCheckedChange:p,form:g,...h}=t,[x,v]=y.useState(null),b=n(i,e=>v(e)),j=y.useRef(!1),N=!x||(g||!!x.closest("form")),[w=!1,D]=r({prop:d,defaultProp:c,onChange:p});return e.jsxs(pr,{scope:o,checked:w,disabled:m,children:[e.jsx(s.button,{type:"button",role:"switch","aria-checked":w,"aria-required":u,"data-state":jr(w),"data-disabled":m?"":void 0,disabled:m,value:f,...h,ref:b,onClick:a(t.onClick,e=>{D(e=>!e),N&&(j.current=e.isPropagationStopped(),j.current||e.stopPropagation())})}),N&&e.jsx(br,{control:x,bubbles:!j.current,name:l,value:f,checked:w,required:u,disabled:m,form:g,style:{transform:"translateX(-100%)"}})]})});hr.displayName=ur;var xr="SwitchThumb",vr=y.forwardRef((t,n)=>{const{__scopeSwitch:r,...i}=t,a=gr(xr,r);return e.jsx(s.span,{"data-state":jr(a.checked),"data-disabled":a.disabled?"":void 0,...i,ref:n})});vr.displayName=xr;var br=t=>{const{control:n,checked:r,bubbles:i=!0,...s}=t,a=y.useRef(null),o=He(r),l=c(n);return y.useEffect(()=>{const e=a.current,t=window.HTMLInputElement.prototype,n=Object.getOwnPropertyDescriptor(t,"checked").set;if(o!==r&&n){const t=new Event("click",{bubbles:i});n.call(e,r),e.dispatchEvent(t)}},[o,r,i]),e.jsx("input",{type:"checkbox","aria-hidden":!0,defaultChecked:r,...s,tabIndex:-1,ref:a,style:{...t.style,...l,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})};function jr(e){return e?"checked":"unchecked"}var Nr=hr,yr=vr;const wr=y.forwardRef(({className:t,...n},r)=>e.jsx(Nr,{className:d("peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input",t),...n,ref:r,children:e.jsx(yr,{className:d("pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0")})}));wr.displayName=Nr.displayName;var Dr=["Enter"," "],Tr=["ArrowUp","PageDown","End"],Sr=["ArrowDown","PageUp","Home",...Tr],kr={ltr:[...Dr,"ArrowRight"],rtl:[...Dr,"ArrowLeft"]},Cr={ltr:["ArrowLeft"],rtl:["ArrowRight"]},Ir="Menu",[Mr,Rr,$r]=t(Ir),[_r,Er]=o(Ir,[$r,u,Ye]),Pr=u(),Ar=Ye(),[Or,Fr]=_r(Ir),[Lr,Vr]=_r(Ir),Hr=t=>{const{__scopeMenu:n,open:r=!1,children:s,dir:a,onOpenChange:o,modal:l=!0}=t,d=Pr(n),[c,u]=y.useState(null),m=y.useRef(!1),f=i(o),p=T(a);return y.useEffect(()=>{const e=()=>{m.current=!0,document.addEventListener("pointerdown",t,{capture:!0,once:!0}),document.addEventListener("pointermove",t,{capture:!0,once:!0})},t=()=>m.current=!1;return document.addEventListener("keydown",e,{capture:!0}),()=>{document.removeEventListener("keydown",e,{capture:!0}),document.removeEventListener("pointerdown",t,{capture:!0}),document.removeEventListener("pointermove",t,{capture:!0})}},[]),e.jsx(b,{...d,children:e.jsx(Or,{scope:n,open:r,onOpenChange:f,content:c,onContentChange:u,children:e.jsx(Lr,{scope:n,onClose:y.useCallback(()=>f(!1),[f]),isUsingKeyboardRef:m,dir:p,modal:l,children:s})})})};Hr.displayName=Ir;var Ur=y.forwardRef((t,n)=>{const{__scopeMenu:r,...i}=t,s=Pr(r);return e.jsx(m,{...s,...i,ref:n})});Ur.displayName="MenuAnchor";var Kr="MenuPortal",[zr,Br]=_r(Kr,{forceMount:void 0}),Wr=t=>{const{__scopeMenu:n,forceMount:r,children:i,container:s}=t,a=Fr(Kr,n);return e.jsx(zr,{scope:n,forceMount:r,children:e.jsx(l,{present:r||a.open,children:e.jsx(j,{asChild:!0,container:s,children:i})})})};Wr.displayName=Kr;var Gr="MenuContent",[Jr,qr]=_r(Gr),Yr=y.forwardRef((t,n)=>{const r=Br(Gr,t.__scopeMenu),{forceMount:i=r.forceMount,...s}=t,a=Fr(Gr,t.__scopeMenu),o=Vr(Gr,t.__scopeMenu);return e.jsx(Mr.Provider,{scope:t.__scopeMenu,children:e.jsx(l,{present:i||a.open,children:e.jsx(Mr.Slot,{scope:t.__scopeMenu,children:o.modal?e.jsx(Xr,{...s,ref:n}):e.jsx(Zr,{...s,ref:n})})})})}),Xr=y.forwardRef((t,r)=>{const i=Fr(Gr,t.__scopeMenu),s=y.useRef(null),o=n(r,s);return y.useEffect(()=>{const e=s.current;if(e)return q(e)},[]),e.jsx(Qr,{...t,ref:o,trapFocus:i.open,disableOutsidePointerEvents:i.open,disableOutsideScroll:!0,onFocusOutside:a(t.onFocusOutside,e=>e.preventDefault(),{checkForDefaultPrevented:!1}),onDismiss:()=>i.onOpenChange(!1)})}),Zr=y.forwardRef((t,n)=>{const r=Fr(Gr,t.__scopeMenu);return e.jsx(Qr,{...t,ref:n,trapFocus:!1,disableOutsidePointerEvents:!1,disableOutsideScroll:!1,onDismiss:()=>r.onOpenChange(!1)})}),Qr=y.forwardRef((t,r)=>{const{__scopeMenu:i,loop:s=!1,trapFocus:o,onOpenAutoFocus:l,onCloseAutoFocus:d,disableOutsidePointerEvents:c,onEntryFocus:u,onEscapeKeyDown:m,onPointerDownOutside:g,onFocusOutside:h,onInteractOutside:v,onDismiss:b,disableOutsideScroll:j,...N}=t,w=Fr(Gr,i),D=Vr(Gr,i),T=Pr(i),S=Ar(i),k=Rr(i),[C,I]=y.useState(null),M=y.useRef(null),R=n(r,M,w.onContentChange),$=y.useRef(0),_=y.useRef(""),E=y.useRef(0),P=y.useRef(null),A=y.useRef("right"),O=y.useRef(0),F=j?Z:y.Fragment,L=j?{as:x,allowPinchZoom:!0}:void 0,V=e=>{var t,n;const r=_.current+e,i=k().filter(e=>!e.disabled),s=document.activeElement,a=null==(t=i.find(e=>e.ref.current===s))?void 0:t.textValue,o=function(e,t,n){const r=t.length>1&&Array.from(t).every(e=>e===t[0]),i=r?t[0]:t,s=n?e.indexOf(n):-1;let a=(o=e,l=Math.max(s,0),o.map((e,t)=>o[(l+t)%o.length]));var o,l;1===i.length&&(a=a.filter(e=>e!==n));const d=a.find(e=>e.toLowerCase().startsWith(i.toLowerCase()));return d!==n?d:void 0}(i.map(e=>e.textValue),r,a),l=null==(n=i.find(e=>e.textValue===o))?void 0:n.ref.current;!function e(t){_.current=t,window.clearTimeout($.current),""!==t&&($.current=window.setTimeout(()=>e(""),1e3))}(r),l&&setTimeout(()=>l.focus())};y.useEffect(()=>()=>window.clearTimeout($.current),[]),Y();const H=y.useCallback(e=>{var t,n;return A.current===(null==(t=P.current)?void 0:t.side)&&function(e,t){if(!t)return!1;const n={x:e.clientX,y:e.clientY};return function(e,t){const{x:n,y:r}=e;let i=!1;for(let s=0,a=t.length-1;s<t.length;a=s++){const e=t[s].x,o=t[s].y,l=t[a].x,d=t[a].y;o>r!=d>r&&n<(l-e)*(r-o)/(d-o)+e&&(i=!i)}return i}(n,t)}(e,null==(n=P.current)?void 0:n.area)},[]);return e.jsx(Jr,{scope:i,searchRef:_,onItemEnter:y.useCallback(e=>{H(e)&&e.preventDefault()},[H]),onItemLeave:y.useCallback(e=>{var t;H(e)||(null==(t=M.current)||t.focus(),I(null))},[H]),onTriggerLeave:y.useCallback(e=>{H(e)&&e.preventDefault()},[H]),pointerGraceTimerRef:E,onPointerGraceIntentChange:y.useCallback(e=>{P.current=e},[]),children:e.jsx(F,{...L,children:e.jsx(X,{asChild:!0,trapped:o,onMountAutoFocus:a(l,e=>{var t;e.preventDefault(),null==(t=M.current)||t.focus({preventScroll:!0})}),onUnmountAutoFocus:d,children:e.jsx(f,{asChild:!0,disableOutsidePointerEvents:c,onEscapeKeyDown:m,onPointerDownOutside:g,onFocusOutside:h,onInteractOutside:v,onDismiss:b,children:e.jsx(st,{asChild:!0,...S,dir:D.dir,orientation:"vertical",loop:s,currentTabStopId:C,onCurrentTabStopIdChange:I,onEntryFocus:a(u,e=>{D.isUsingKeyboardRef.current||e.preventDefault()}),preventScrollOnEntryFocus:!0,children:e.jsx(p,{role:"menu","aria-orientation":"vertical","data-state":Ti(w.open),"data-radix-menu-content":"",dir:D.dir,...T,...N,ref:R,style:{outline:"none",...N.style},onKeyDown:a(N.onKeyDown,e=>{const t=e.target.closest("[data-radix-menu-content]")===e.currentTarget,n=e.ctrlKey||e.altKey||e.metaKey,r=1===e.key.length;t&&("Tab"===e.key&&e.preventDefault(),!n&&r&&V(e.key));const i=M.current;if(e.target!==i)return;if(!Sr.includes(e.key))return;e.preventDefault();const s=k().filter(e=>!e.disabled).map(e=>e.ref.current);Tr.includes(e.key)&&s.reverse(),function(e){const t=document.activeElement;for(const n of e){if(n===t)return;if(n.focus(),document.activeElement!==t)return}}(s)}),onBlur:a(t.onBlur,e=>{e.currentTarget.contains(e.target)||(window.clearTimeout($.current),_.current="")}),onPointerMove:a(t.onPointerMove,Ci(e=>{const t=e.target,n=O.current!==e.clientX;if(e.currentTarget.contains(t)&&n){const t=e.clientX>O.current?"right":"left";A.current=t,O.current=e.clientX}}))})})})})})})});Yr.displayName=Gr;var ei=y.forwardRef((t,n)=>{const{__scopeMenu:r,...i}=t;return e.jsx(s.div,{role:"group",...i,ref:n})});ei.displayName="MenuGroup";var ti=y.forwardRef((t,n)=>{const{__scopeMenu:r,...i}=t;return e.jsx(s.div,{...i,ref:n})});ti.displayName="MenuLabel";var ni="MenuItem",ri="menu.itemSelect",ii=y.forwardRef((t,r)=>{const{disabled:i=!1,onSelect:s,...o}=t,l=y.useRef(null),d=Vr(ni,t.__scopeMenu),c=qr(ni,t.__scopeMenu),u=n(r,l),m=y.useRef(!1);return e.jsx(si,{...o,ref:u,disabled:i,onClick:a(t.onClick,()=>{const e=l.current;if(!i&&e){const t=new CustomEvent(ri,{bubbles:!0,cancelable:!0});e.addEventListener(ri,e=>null==s?void 0:s(e),{once:!0}),v(e,t),t.defaultPrevented?m.current=!1:d.onClose()}}),onPointerDown:e=>{var n;null==(n=t.onPointerDown)||n.call(t,e),m.current=!0},onPointerUp:a(t.onPointerUp,e=>{var t;m.current||null==(t=e.currentTarget)||t.click()}),onKeyDown:a(t.onKeyDown,e=>{const t=""!==c.searchRef.current;i||t&&" "===e.key||Dr.includes(e.key)&&(e.currentTarget.click(),e.preventDefault())})})});ii.displayName=ni;var si=y.forwardRef((t,r)=>{const{__scopeMenu:i,disabled:o=!1,textValue:l,...d}=t,c=qr(ni,i),u=Ar(i),m=y.useRef(null),f=n(r,m),[p,g]=y.useState(!1),[h,x]=y.useState("");return y.useEffect(()=>{const e=m.current;e&&x((e.textContent??"").trim())},[d.children]),e.jsx(Mr.ItemSlot,{scope:i,disabled:o,textValue:l??h,children:e.jsx(at,{asChild:!0,...u,focusable:!o,children:e.jsx(s.div,{role:"menuitem","data-highlighted":p?"":void 0,"aria-disabled":o||void 0,"data-disabled":o?"":void 0,...d,ref:f,onPointerMove:a(t.onPointerMove,Ci(e=>{if(o)c.onItemLeave(e);else if(c.onItemEnter(e),!e.defaultPrevented){e.currentTarget.focus({preventScroll:!0})}})),onPointerLeave:a(t.onPointerLeave,Ci(e=>c.onItemLeave(e))),onFocus:a(t.onFocus,()=>g(!0)),onBlur:a(t.onBlur,()=>g(!1))})})})}),ai=y.forwardRef((t,n)=>{const{checked:r=!1,onCheckedChange:i,...s}=t;return e.jsx(pi,{scope:t.__scopeMenu,checked:r,children:e.jsx(ii,{role:"menuitemcheckbox","aria-checked":Si(r)?"mixed":r,...s,ref:n,"data-state":ki(r),onSelect:a(s.onSelect,()=>null==i?void 0:i(!!Si(r)||!r),{checkForDefaultPrevented:!1})})})});ai.displayName="MenuCheckboxItem";var oi="MenuRadioGroup",[li,di]=_r(oi,{value:void 0,onValueChange:()=>{}}),ci=y.forwardRef((t,n)=>{const{value:r,onValueChange:s,...a}=t,o=i(s);return e.jsx(li,{scope:t.__scopeMenu,value:r,onValueChange:o,children:e.jsx(ei,{...a,ref:n})})});ci.displayName=oi;var ui="MenuRadioItem",mi=y.forwardRef((t,n)=>{const{value:r,...i}=t,s=di(ui,t.__scopeMenu),o=r===s.value;return e.jsx(pi,{scope:t.__scopeMenu,checked:o,children:e.jsx(ii,{role:"menuitemradio","aria-checked":o,...i,ref:n,"data-state":ki(o),onSelect:a(i.onSelect,()=>{var e;return null==(e=s.onValueChange)?void 0:e.call(s,r)},{checkForDefaultPrevented:!1})})})});mi.displayName=ui;var fi="MenuItemIndicator",[pi,gi]=_r(fi,{checked:!1}),hi=y.forwardRef((t,n)=>{const{__scopeMenu:r,forceMount:i,...a}=t,o=gi(fi,r);return e.jsx(l,{present:i||Si(o.checked)||!0===o.checked,children:e.jsx(s.span,{...a,ref:n,"data-state":ki(o.checked)})})});hi.displayName=fi;var xi=y.forwardRef((t,n)=>{const{__scopeMenu:r,...i}=t;return e.jsx(s.div,{role:"separator","aria-orientation":"horizontal",...i,ref:n})});xi.displayName="MenuSeparator";var vi=y.forwardRef((t,n)=>{const{__scopeMenu:r,...i}=t,s=Pr(r);return e.jsx(g,{...s,...i,ref:n})});vi.displayName="MenuArrow";var[bi,ji]=_r("MenuSub"),Ni="MenuSubTrigger",yi=y.forwardRef((t,n)=>{const r=Fr(Ni,t.__scopeMenu),i=Vr(Ni,t.__scopeMenu),s=ji(Ni,t.__scopeMenu),o=qr(Ni,t.__scopeMenu),l=y.useRef(null),{pointerGraceTimerRef:d,onPointerGraceIntentChange:c}=o,u={__scopeMenu:t.__scopeMenu},m=y.useCallback(()=>{l.current&&window.clearTimeout(l.current),l.current=null},[]);return y.useEffect(()=>m,[m]),y.useEffect(()=>{const e=d.current;return()=>{window.clearTimeout(e),c(null)}},[d,c]),e.jsx(Ur,{asChild:!0,...u,children:e.jsx(si,{id:s.triggerId,"aria-haspopup":"menu","aria-expanded":r.open,"aria-controls":s.contentId,"data-state":Ti(r.open),...t,ref:h(n,s.onTriggerChange),onClick:e=>{var n;null==(n=t.onClick)||n.call(t,e),t.disabled||e.defaultPrevented||(e.currentTarget.focus(),r.open||r.onOpenChange(!0))},onPointerMove:a(t.onPointerMove,Ci(e=>{o.onItemEnter(e),e.defaultPrevented||t.disabled||r.open||l.current||(o.onPointerGraceIntentChange(null),l.current=window.setTimeout(()=>{r.onOpenChange(!0),m()},100))})),onPointerLeave:a(t.onPointerLeave,Ci(e=>{var t,n;m();const i=null==(t=r.content)?void 0:t.getBoundingClientRect();if(i){const t=null==(n=r.content)?void 0:n.dataset.side,s="right"===t,a=s?-5:5,l=i[s?"left":"right"],c=i[s?"right":"left"];o.onPointerGraceIntentChange({area:[{x:e.clientX+a,y:e.clientY},{x:l,y:i.top},{x:c,y:i.top},{x:c,y:i.bottom},{x:l,y:i.bottom}],side:t}),window.clearTimeout(d.current),d.current=window.setTimeout(()=>o.onPointerGraceIntentChange(null),300)}else{if(o.onTriggerLeave(e),e.defaultPrevented)return;o.onPointerGraceIntentChange(null)}})),onKeyDown:a(t.onKeyDown,e=>{var n;const s=""!==o.searchRef.current;t.disabled||s&&" "===e.key||kr[i.dir].includes(e.key)&&(r.onOpenChange(!0),null==(n=r.content)||n.focus(),e.preventDefault())})})})});yi.displayName=Ni;var wi="MenuSubContent",Di=y.forwardRef((t,r)=>{const i=Br(Gr,t.__scopeMenu),{forceMount:s=i.forceMount,...o}=t,d=Fr(Gr,t.__scopeMenu),c=Vr(Gr,t.__scopeMenu),u=ji(wi,t.__scopeMenu),m=y.useRef(null),f=n(r,m);return e.jsx(Mr.Provider,{scope:t.__scopeMenu,children:e.jsx(l,{present:s||d.open,children:e.jsx(Mr.Slot,{scope:t.__scopeMenu,children:e.jsx(Qr,{id:u.contentId,"aria-labelledby":u.triggerId,...o,ref:f,align:"start",side:"rtl"===c.dir?"left":"right",disableOutsidePointerEvents:!1,disableOutsideScroll:!1,trapFocus:!1,onOpenAutoFocus:e=>{var t;c.isUsingKeyboardRef.current&&(null==(t=m.current)||t.focus()),e.preventDefault()},onCloseAutoFocus:e=>e.preventDefault(),onFocusOutside:a(t.onFocusOutside,e=>{e.target!==u.trigger&&d.onOpenChange(!1)}),onEscapeKeyDown:a(t.onEscapeKeyDown,e=>{c.onClose(),e.preventDefault()}),onKeyDown:a(t.onKeyDown,e=>{var t;const n=e.currentTarget.contains(e.target),r=Cr[c.dir].includes(e.key);n&&r&&(d.onOpenChange(!1),null==(t=u.trigger)||t.focus(),e.preventDefault())})})})})})});function Ti(e){return e?"open":"closed"}function Si(e){return"indeterminate"===e}function ki(e){return Si(e)?"indeterminate":e?"checked":"unchecked"}function Ci(e){return t=>"mouse"===t.pointerType?e(t):void 0}Di.displayName=wi;var Ii=Hr,Mi=Ur,Ri=Wr,$i=Yr,_i=ei,Ei=ti,Pi=ii,Ai=ai,Oi=ci,Fi=mi,Li=hi,Vi=xi,Hi=vi,Ui=yi,Ki=Di,zi="DropdownMenu",[Bi,Wi]=o(zi,[Er]),Gi=Er(),[Ji,qi]=Bi(zi),Yi=t=>{const{__scopeDropdownMenu:n,children:i,dir:s,open:a,defaultOpen:o,onOpenChange:l,modal:d=!0}=t,c=Gi(n),u=y.useRef(null),[m=!1,f]=r({prop:a,defaultProp:o,onChange:l});return e.jsx(Ji,{scope:n,triggerId:S(),triggerRef:u,contentId:S(),open:m,onOpenChange:f,onOpenToggle:y.useCallback(()=>f(e=>!e),[f]),modal:d,children:e.jsx(Ii,{...c,open:m,onOpenChange:f,dir:s,modal:d,children:i})})};Yi.displayName=zi;var Xi="DropdownMenuTrigger",Zi=y.forwardRef((t,n)=>{const{__scopeDropdownMenu:r,disabled:i=!1,...o}=t,l=qi(Xi,r),d=Gi(r);return e.jsx(Mi,{asChild:!0,...d,children:e.jsx(s.button,{type:"button",id:l.triggerId,"aria-haspopup":"menu","aria-expanded":l.open,"aria-controls":l.open?l.contentId:void 0,"data-state":l.open?"open":"closed","data-disabled":i?"":void 0,disabled:i,...o,ref:h(n,l.triggerRef),onPointerDown:a(t.onPointerDown,e=>{i||0!==e.button||!1!==e.ctrlKey||(l.onOpenToggle(),l.open||e.preventDefault())}),onKeyDown:a(t.onKeyDown,e=>{i||(["Enter"," "].includes(e.key)&&l.onOpenToggle(),"ArrowDown"===e.key&&l.onOpenChange(!0),["Enter"," ","ArrowDown"].includes(e.key)&&e.preventDefault())})})})});Zi.displayName=Xi;var Qi=t=>{const{__scopeDropdownMenu:n,...r}=t,i=Gi(n);return e.jsx(Ri,{...i,...r})};Qi.displayName="DropdownMenuPortal";var es="DropdownMenuContent",ts=y.forwardRef((t,n)=>{const{__scopeDropdownMenu:r,...i}=t,s=qi(es,r),o=Gi(r),l=y.useRef(!1);return e.jsx($i,{id:s.contentId,"aria-labelledby":s.triggerId,...o,...i,ref:n,onCloseAutoFocus:a(t.onCloseAutoFocus,e=>{var t;l.current||null==(t=s.triggerRef.current)||t.focus(),l.current=!1,e.preventDefault()}),onInteractOutside:a(t.onInteractOutside,e=>{const t=e.detail.originalEvent,n=0===t.button&&!0===t.ctrlKey,r=2===t.button||n;s.modal&&!r||(l.current=!0)}),style:{...t.style,"--radix-dropdown-menu-content-transform-origin":"var(--radix-popper-transform-origin)","--radix-dropdown-menu-content-available-width":"var(--radix-popper-available-width)","--radix-dropdown-menu-content-available-height":"var(--radix-popper-available-height)","--radix-dropdown-menu-trigger-width":"var(--radix-popper-anchor-width)","--radix-dropdown-menu-trigger-height":"var(--radix-popper-anchor-height)"}})});ts.displayName=es;y.forwardRef((t,n)=>{const{__scopeDropdownMenu:r,...i}=t,s=Gi(r);return e.jsx(_i,{...s,...i,ref:n})}).displayName="DropdownMenuGroup";var ns=y.forwardRef((t,n)=>{const{__scopeDropdownMenu:r,...i}=t,s=Gi(r);return e.jsx(Ei,{...s,...i,ref:n})});ns.displayName="DropdownMenuLabel";var rs=y.forwardRef((t,n)=>{const{__scopeDropdownMenu:r,...i}=t,s=Gi(r);return e.jsx(Pi,{...s,...i,ref:n})});rs.displayName="DropdownMenuItem";var is=y.forwardRef((t,n)=>{const{__scopeDropdownMenu:r,...i}=t,s=Gi(r);return e.jsx(Ai,{...s,...i,ref:n})});is.displayName="DropdownMenuCheckboxItem";y.forwardRef((t,n)=>{const{__scopeDropdownMenu:r,...i}=t,s=Gi(r);return e.jsx(Oi,{...s,...i,ref:n})}).displayName="DropdownMenuRadioGroup";var ss=y.forwardRef((t,n)=>{const{__scopeDropdownMenu:r,...i}=t,s=Gi(r);return e.jsx(Fi,{...s,...i,ref:n})});ss.displayName="DropdownMenuRadioItem";var as=y.forwardRef((t,n)=>{const{__scopeDropdownMenu:r,...i}=t,s=Gi(r);return e.jsx(Li,{...s,...i,ref:n})});as.displayName="DropdownMenuItemIndicator";var os=y.forwardRef((t,n)=>{const{__scopeDropdownMenu:r,...i}=t,s=Gi(r);return e.jsx(Vi,{...s,...i,ref:n})});os.displayName="DropdownMenuSeparator";y.forwardRef((t,n)=>{const{__scopeDropdownMenu:r,...i}=t,s=Gi(r);return e.jsx(Hi,{...s,...i,ref:n})}).displayName="DropdownMenuArrow";var ls=y.forwardRef((t,n)=>{const{__scopeDropdownMenu:r,...i}=t,s=Gi(r);return e.jsx(Ui,{...s,...i,ref:n})});ls.displayName="DropdownMenuSubTrigger";var ds=y.forwardRef((t,n)=>{const{__scopeDropdownMenu:r,...i}=t,s=Gi(r);return e.jsx(Ki,{...s,...i,ref:n,style:{...t.style,"--radix-dropdown-menu-content-transform-origin":"var(--radix-popper-transform-origin)","--radix-dropdown-menu-content-available-width":"var(--radix-popper-available-width)","--radix-dropdown-menu-content-available-height":"var(--radix-popper-available-height)","--radix-dropdown-menu-trigger-width":"var(--radix-popper-anchor-width)","--radix-dropdown-menu-trigger-height":"var(--radix-popper-anchor-height)"}})});ds.displayName="DropdownMenuSubContent";var cs=Qi,us=ts,ms=ns,fs=rs,ps=is,gs=ss,hs=as,xs=os,vs=ls,bs=ds;const js=Yi,Ns=Zi;y.forwardRef(({className:t,inset:n,children:r,...i},s)=>e.jsxs(vs,{ref:s,className:d("flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent",n&&"pl-8",t),...i,children:[r,e.jsx(De,{className:"ml-auto h-4 w-4"})]})).displayName=vs.displayName;y.forwardRef(({className:t,...n},r)=>e.jsx(bs,{ref:r,className:d("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",t),...n})).displayName=bs.displayName;const ys=y.forwardRef(({className:t,sideOffset:n=4,...r},i)=>e.jsx(cs,{children:e.jsx(us,{ref:i,sideOffset:n,className:d("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",t),...r})}));ys.displayName=us.displayName;const ws=y.forwardRef(({className:t,inset:n,...r},i)=>e.jsx(fs,{ref:i,className:d("relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",n&&"pl-8",t),...r}));ws.displayName=fs.displayName;y.forwardRef(({className:t,children:n,checked:r,...i},s)=>e.jsxs(ps,{ref:s,className:d("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",t),checked:r,...i,children:[e.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:e.jsx(hs,{children:e.jsx(Te,{className:"h-4 w-4"})})}),n]})).displayName=ps.displayName;y.forwardRef(({className:t,children:n,...r},i)=>e.jsxs(gs,{ref:i,className:d("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",t),...r,children:[e.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:e.jsx(hs,{children:e.jsx(he,{className:"h-2 w-2 fill-current"})})}),n]})).displayName=gs.displayName;const Ds=y.forwardRef(({className:t,inset:n,...r},i)=>e.jsx(ms,{ref:i,className:d("px-2 py-1.5 text-sm font-semibold",n&&"pl-8",t),...r}));Ds.displayName=ms.displayName;const Ts=y.forwardRef(({className:t,...n},r)=>e.jsx(xs,{ref:r,className:d("-mx-1 my-1 h-px bg-muted",t),...n}));Ts.displayName=xs.displayName;var Ss="Avatar",[ks,Cs]=o(Ss),[Is,Ms]=ks(Ss),Rs=y.forwardRef((t,n)=>{const{__scopeAvatar:r,...i}=t,[a,o]=y.useState("idle");return e.jsx(Is,{scope:r,imageLoadingStatus:a,onImageLoadingStatusChange:o,children:e.jsx(s.span,{...i,ref:n})})});Rs.displayName=Ss;var $s="AvatarImage",_s=y.forwardRef((t,n)=>{const{__scopeAvatar:r,src:a,onLoadingStatusChange:o=()=>{},...l}=t,d=Ms($s,r),c=function(e,t){const[n,r]=y.useState("idle");return N(()=>{if(!e)return void r("error");let n=!0;const i=new window.Image,s=e=>()=>{n&&r(e)};return r("loading"),i.onload=s("loaded"),i.onerror=s("error"),i.src=e,t&&(i.referrerPolicy=t),()=>{n=!1}},[e,t]),n}(a,l.referrerPolicy),u=i(e=>{o(e),d.onImageLoadingStatusChange(e)});return N(()=>{"idle"!==c&&u(c)},[c,u]),"loaded"===c?e.jsx(s.img,{...l,ref:n,src:a}):null});_s.displayName=$s;var Es="AvatarFallback",Ps=y.forwardRef((t,n)=>{const{__scopeAvatar:r,delayMs:i,...a}=t,o=Ms(Es,r),[l,d]=y.useState(void 0===i);return y.useEffect(()=>{if(void 0!==i){const e=window.setTimeout(()=>d(!0),i);return()=>window.clearTimeout(e)}},[i]),l&&"loaded"!==o.imageLoadingStatus?e.jsx(s.span,{...a,ref:n}):null});Ps.displayName=Es;var As=Rs,Os=_s,Fs=Ps;const Ls=y.forwardRef(({className:t,...n},r)=>e.jsx(As,{ref:r,className:d("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",t),...n}));Ls.displayName=As.displayName;const Vs=y.forwardRef(({className:t,...n},r)=>e.jsx(Os,{ref:r,className:d("aspect-square h-full w-full",t),...n}));Vs.displayName=Os.displayName;const Hs=y.forwardRef(({className:t,...n},r)=>e.jsx(Fs,{ref:r,className:d("flex h-full w-full items-center justify-center rounded-full bg-muted",t),...n}));Hs.displayName=Fs.displayName;const Us=({onLogout:t})=>{const[n,r]=y.useState([]),[i,s]=y.useState([]),[a,o]=y.useState([]),[l,d]=y.useState([]),[c,u]=y.useState(null),[m,f]=y.useState(!1),[p,g]=y.useState(!1);y.useEffect(()=>{const e=window.document.documentElement;m?e.classList.add("dark"):e.classList.remove("dark")},[m]),y.useEffect(()=>{const e=(ke.getJSON(Ce.patients,[])||[]).map(e=>({...e,createdAt:e.createdAt?new Date(e.createdAt):new Date}));r(e);const t=(ke.getJSON(Ce.prescriptions,[])||[]).map(e=>({...e,startDate:e.startDate?new Date(e.startDate):new Date,endDate:e.endDate?new Date(e.endDate):void 0}));s(t);const n=(ke.getJSON(Ce.bloodTests,[])||[]).map(e=>({...e,testDate:e.testDate?new Date(e.testDate):new Date}));o(n);const i=ke.getJSON(Ce.drugAdministrations,[]);d(i||[]);const a=ke.getJSON(Ce.selectedPatientId,null);if(a){const t=e.find(e=>e.id===a)||null;u(t)}g(!0)},[]),y.useEffect(()=>{p&&ke.setJSON(Ce.patients,n)},[p,n]),y.useEffect(()=>{p&&ke.setJSON(Ce.prescriptions,i)},[p,i]),y.useEffect(()=>{p&&ke.setJSON(Ce.bloodTests,a)},[p,a]),y.useEffect(()=>{p&&ke.setJSON(Ce.drugAdministrations,l)},[p,l]),y.useEffect(()=>{p&&((null==c?void 0:c.id)?ke.setJSON(Ce.selectedPatientId,c.id):ke.remove(Ce.selectedPatientId))},[p,c]);const h=e=>{r([...n,e])};return e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 dark:from-slate-900 dark:to-blue-950",children:[e.jsx("header",{className:"bg-white dark:bg-slate-900 shadow-sm border-b border-slate-200 dark:border-slate-700",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"flex justify-between items-center py-6",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Ne,{className:"h-8 w-8 text-blue-600 dark:text-blue-300"}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-slate-900 dark:text-white",children:"TDM Friends"}),e.jsx("p",{className:"text-sm text-slate-600 dark:text-slate-300",children:"Precision Medicine의 시작"})]})]}),e.jsxs("div",{className:"flex items-center gap-6",children:[e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"text-sm text-slate-600 dark:text-slate-300",children:["등록된 환자 수: ",n.length]}),e.jsxs("p",{className:"text-sm text-slate-600 dark:text-slate-300",children:["선택된 환자: ",(null==c?void 0:c.name)||"None"]})]}),e.jsxs(js,{children:[e.jsx(Ns,{asChild:!0,children:e.jsxs(ie,{variant:"ghost",className:"flex items-center gap-2",children:[e.jsxs(Ls,{className:"h-9 w-9",children:[e.jsx(Vs,{src:"https://avatar.vercel.sh/user.png",alt:"User"}),e.jsx(Hs,{children:"사용자"})]}),e.jsx("span",{className:"font-medium",children:"사용자"})]})}),e.jsxs(ys,{className:"w-56",align:"end",forceMount:!0,children:[e.jsx(Ds,{className:"font-normal",children:e.jsxs("div",{className:"flex flex-col space-y-1",children:[e.jsx("p",{className:"text-sm font-medium leading-none",children:"사용자"}),e.jsx("p",{className:"text-xs leading-none text-muted-foreground",children:"user@pk-friends.com"}),e.jsx("p",{className:"text-xs leading-none text-muted-foreground pt-1",children:"소속: PK 프렌즈 대학병원"})]})}),e.jsx(Ts,{}),e.jsx(ws,{onSelect:e=>e.preventDefault(),children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsx("span",{children:m?"다크 모드":"라이트 모드"}),e.jsx(wr,{checked:m,onCheckedChange:f,className:"ml-4"})]})}),e.jsx(ws,{children:"프로필 설정"}),e.jsx(ws,{onClick:t,children:"로그아웃"})]})]})]})]})})}),e.jsx("main",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:e.jsxs(Tt,{defaultValue:"workflow",className:"space-y-6",children:[e.jsxs(St,{className:"grid w-full grid-cols-4 bg-white dark:bg-slate-800 border dark:border-slate-700 shadow-sm h-[52px]",children:[e.jsxs(kt,{value:"workflow",className:"flex items-center justify-center col-span-3 rounded-l-xl px-6 h-[52px] min-h-[52px] max-h-[52px] text-slate-900 dark:text-slate-200 dark:data-[state=active]:bg-slate-900 dark:data-[state=active]:text-white dark:data-[state=inactive]:bg-slate-800 dark:data-[state=inactive]:text-slate-400 dark:focus:bg-slate-700 dark:focus:text-white dark:hover:bg-slate-700 dark:hover:text-white border-r border-slate-200 dark:border-slate-700 leading-none",children:[e.jsx(Ne,{className:"h-4 w-4 mr-2"}),"Let's TDM"]}),e.jsxs(kt,{value:"management",className:"flex items-center justify-center col-span-1 rounded-r-xl px-6 h-[52px] min-h-[52px] max-h-[52px] text-slate-900 dark:text-slate-200 dark:data-[state=active]:bg-slate-900 dark:data-[state=active]:text-white dark:data-[state=inactive]:bg-slate-800 dark:data-[state=inactive]:text-slate-400 dark:focus:bg-slate-700 dark:focus:text-white dark:hover:bg-slate-700 dark:hover:text-white border-l border-slate-200 dark:border-slate-700 leading-none",children:[e.jsx(pe,{className:"h-4 w-4 mr-2"}),"환자 관리"]})]}),e.jsx(Ct,{value:"workflow",children:e.jsx(cr,{patients:n,prescriptions:i,bloodTests:a,selectedPatient:c,setSelectedPatient:u,onAddPatient:h,onAddPrescription:(e,t)=>{t?s(e?[...t,e]:t):e&&s([e,...i])},setPrescriptions:s,onAddBloodTest:e=>{o([...a,e])},onDeleteBloodTest:e=>{o(a.filter(t=>t.id!==e))},setBloodTests:o,onAddDrugAdministration:e=>{d([...l,e])},drugAdministrations:l,setDrugAdministrations:d,onUpdatePatient:e=>{r(n.map(t=>t.id===e.id?e:t))},onDeletePatient:e=>{r(n.filter(t=>t.id!==e))},onResetWorkflow:()=>{s([]),o([]),d([])}})}),e.jsx(Ct,{value:"management",children:e.jsxs(Q,{children:[e.jsxs(ee,{children:[e.jsxs(te,{className:"flex items-center gap-2",children:[e.jsx(pe,{className:"h-5 w-5"}),"환자 관리"]}),e.jsx(ne,{children:"환자 관리 및 히스토리 조회"})]}),e.jsx(re,{children:e.jsx(Gt,{onAddPatient:h,onUpdatePatient:e=>r(t=>t.map(t=>t.id===e.id?e:t)),onDeletePatient:e=>r(t=>t.filter(t=>t.id!==e)),patients:n,selectedPatient:c,setSelectedPatient:u})})]})})]})})]})};export{Us as default};
