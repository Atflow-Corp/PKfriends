import{j as e,F as t}from"./index-DN0jahsZ.js";import{C as a,d as s,a as i,b as n,c as d}from"./card-6WwEfC0_.js";import{B as r}from"./button-zhdQzyTn.js";import{r as o}from"./react-vendor-B8CcSR15.js";import{H as l}from"./Header-CtlF7BjZ.js";import{e as c,P as m,s as u,S as g,h as x,E as p}from"./html2canvas.esm-DuJ7Ndj1.js";import{i as h,D as w}from"./ui-vendor-zUX6a0wC.js";const f=()=>{const[f,j]=o.useState(null),[D,N]=o.useState(""),[S,v]=o.useState(""),[T,$]=o.useState([]),[y,b]=o.useState([]),[I,M]=o.useState([]),[A,C]=o.useState([]),[R,P]=o.useState(null),[O,U]=o.useState(null),[H,J]=o.useState(null);o.useEffect(()=>{(()=>{try{const t=(u.getJSON(g.patients,[])||[]).map(e=>({...e,createdAt:e.createdAt?new Date(e.createdAt):new Date}));$(t);const a=(u.getJSON(g.prescriptions,[])||[]).map(e=>({...e,startDate:e.startDate?new Date(e.startDate):new Date}));b(a);const s=(u.getJSON(g.bloodTests,[])||[]).map(e=>({...e,testDate:e.testDate?new Date(e.testDate):new Date}));M(s);const i=(u.getJSON(g.drugAdministrations,[])||[]).map(e=>({...e,date:e.date?new Date(e.date):new Date}));C(i);const n=new URLSearchParams(window.location.search).get("patientId");if(n&&t.length>0){const s=t.find(e=>e.id===n);s&&j(s);try{const t=window.localStorage.getItem(`tdmfriends:selectedDrug:${n}`);if(t){v(t);const s=a.find(e=>e.patientId===n&&e.drugName===t);s&&P(s);try{const e=window.localStorage.getItem(`tdmfriends:tdmResults:${n}:${t}`);if(e){const t=JSON.parse(e);U(t)}}catch(e){}try{const e=window.localStorage.getItem(`tdmfriends:tdmExtraSeries:${n}:${t}`);if(e){const t=JSON.parse(e);J(t)}}catch(e){}}}catch(e){}}}catch(e){}})(),N((new Date).toLocaleString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}))},[]);return f?e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx(l,{}),e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsx(a,{className:"mb-6",children:e.jsx(s,{className:"py-4",children:e.jsx("p",{className:"text-sm text-gray-600 text-center",children:"Report를 조회한 후 이 탭을 닫고 이전 창으로 복귀하면 계속해서 서비스를 이용하실 수 있습니다."})})}),e.jsx(a,{className:"mb-6",children:e.jsx(i,{children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsxs(n,{className:"text-xl",children:[f.name," 환자의 ",S," TDM 분석 보고서 - 분석일자: ",D]}),e.jsxs(d,{className:"mt-2",children:[f.name," 환자(",f.id,")의 Report를 조회하고 다운로드할 수 있습니다."]})]}),e.jsxs(r,{onClick:async()=>{try{const e=document.getElementById("report-content");if(!e)return void alert("보고서 내용을 찾을 수 없습니다.");const t=document.querySelector("[data-download-button]");t&&(t.disabled=!0,t.textContent="PDF 생성 중...");const a=await x(e,{scale:1.5,useCORS:!0,allowTaint:!0,backgroundColor:"#ffffff",logging:!1,width:e.scrollWidth,height:e.scrollHeight,scrollX:0,scrollY:0}),s=a.toDataURL("image/png",.95),i=new p({orientation:"portrait",unit:"mm",format:"a4"}),n=15,d=210-2*n,r=297-2*n,o=a.width,l=a.height,c=Math.min(d/o,r/l),m=o*c,u=l*c,g=r,h=Math.ceil(u/g);for(let x=0;x<h;x++){x>0&&i.addPage();const e=-x*g,t=x*g;Math.min(g,u-t);i.addImage(s,"PNG",n,n+e,m,u,void 0,"FAST")}const w=`${(null==f?void 0:f.name)||"환자"}_${S||"약품"}_TDM_분석보고서_${(new Date).toISOString().split("T")[0]}.pdf`;i.save(w),t&&(t.disabled=!1,t.textContent="Report Download")}catch(e){alert("PDF 생성 중 오류가 발생했습니다: "+e.message);const t=document.querySelector("[data-download-button]");t&&(t.disabled=!1,t.textContent="Report Download")}},className:"flex items-center gap-2","data-download-button":!0,children:[e.jsx(w,{className:"h-4 w-4"}),"Report Download"]})]})})}),e.jsxs(a,{className:"mb-6",id:"report-content",children:[e.jsx(i,{}),e.jsx(s,{children:e.jsx(c,{currentPatient:f,selectedPrescription:R,latestBloodTest:I.filter(e=>e.patientId===f.id&&e.drugName===S).sort((e,t)=>new Date(t.testDate).getTime()-new Date(e.testDate).getTime())[0]||null,drugAdministrations:A.filter(e=>e.patientId===f.id&&e.drugName===S),isExpanded:!0,onToggleExpanded:()=>{},disableHover:!0})}),e.jsx(s,{children:e.jsx(m,{showSimulation:!1,currentPatientName:null==f?void 0:f.name,selectedDrug:S,targetMin:null==O?void 0:O.targetMin,targetMax:null==O?void 0:O.targetMax,recentAUC:null==O?void 0:O.recentAUC,recentMax:null==O?void 0:O.recentMax,recentTrough:null==O?void 0:O.recentTrough,predictedAUC:null==O?void 0:O.predictedAUC,predictedMax:null==O?void 0:O.predictedMax,predictedTrough:null==O?void 0:O.predictedTrough,ipredSeries:null==H?void 0:H.ipredSeries,predSeries:null==H?void 0:H.predSeries,observedSeries:null==H?void 0:H.observedSeries,tdmIndication:null==R?void 0:R.indication,tdmTarget:null==R?void 0:R.tdmTarget,tdmTargetValue:null==R?void 0:R.tdmTargetValue,latestAdministration:A.filter(e=>e.patientId===f.id&&e.drugName===S).sort((e,t)=>new Date(`${e.date}T${e.time}`).getTime()-new Date(`${t.date}T${t.time}`).getTime()).slice(-1)[0]?{dose:A.filter(e=>e.patientId===f.id&&e.drugName===S).sort((e,t)=>new Date(`${e.date}T${e.time}`).getTime()-new Date(`${t.date}T${t.time}`).getTime()).slice(-1)[0].dose,unit:A.filter(e=>e.patientId===f.id&&e.drugName===S).sort((e,t)=>new Date(`${e.date}T${e.time}`).getTime()-new Date(`${t.date}T${t.time}`).getTime()).slice(-1)[0].unit,intervalHours:A.filter(e=>e.patientId===f.id&&e.drugName===S).sort((e,t)=>new Date(`${e.date}T${e.time}`).getTime()-new Date(`${t.date}T${t.time}`).getTime()).slice(-1)[0].intervalHours}:null,drugAdministrations:A.filter(e=>e.patientId===f.id&&e.drugName===S).map(e=>({id:e.id,patientId:e.patientId,drugName:e.drugName,date:e.date,time:e.time}))})})]})]}),e.jsx(t,{})]}):e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx(l,{}),e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsx(a,{children:e.jsx(s,{className:"py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx(h,{className:"h-16 w-16 text-muted-foreground mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"환자 정보를 찾을 수 없습니다."}),e.jsxs("p",{className:"text-sm text-gray-500 mt-2",children:["URL: ",window.location.href]}),e.jsxs("p",{className:"text-sm text-gray-500",children:["환자 수: ",T.length]})]})})})}),e.jsx(t,{})]})};export{f as default};
