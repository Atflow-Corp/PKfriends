import{j as e}from"./index-DYygwgAh.js";import{C as t,d as a,a as n,b as r,c as i}from"./card-DnEgFZPH.js";import{B as s}from"./button-DTTiIBlo.js";import{r as d}from"./react-vendor-B8CcSR15.js";import{H as l}from"./Header-BmPYv_g2.js";import{s as o,S as m,f as u,P as c,h as g,E as p}from"./html2canvas.esm-4DUxg9Ow.js";import{i as f,D as x}from"./ui-vendor-zUX6a0wC.js";const h=()=>{var h,w;const[v,S]=d.useState(""),[T,N]=d.useState(""),[D,j]=d.useState([]),[y,I]=d.useState([]),[b,$]=d.useState([]),_=new URLSearchParams("undefined"!=typeof window?window.location.search:"").get("patientId"),{patient:A,prescription:C,tdmResult:O,tdmExtraSeries:R,prescriptionInfo:U,inputTOXI:M}=(({patientId:e,drugName:t})=>{const[a,n]=d.useState(null),[r,i]=d.useState(null),[s,l]=d.useState(null),[u,c]=d.useState(null),[g,p]=d.useState(null),[f,x]=d.useState(void 0),[h,w]=d.useState(!0);return d.useEffect(()=>{e&&t?(()=>{try{const r=(o.getJSON(m.patients,[])||[]).map(e=>({...e,createdAt:e.createdAt?new Date(e.createdAt):new Date})).find(t=>t.id===e);r&&n(r);const s=(o.getJSON(m.prescriptions,[])||[]).map(e=>({...e,startDate:e.startDate?new Date(e.startDate):new Date})).find(a=>a.patientId===e&&a.drugName===t);s&&i(s);let d=window.localStorage.getItem(`tdmfriends:tdmResult:${e}:${t}`);d||(d=window.localStorage.getItem(`tdmfriends:tdmResult:${e}`));let u=null;if(d){const n=`tdmfriends:tdmResults:${e}:${t}`,r=window.localStorage.getItem(n);if(r)try{const e=JSON.parse(r);e&&e.length>0&&(u=e.filter(e=>e.timestamp||e.id).sort((e,t)=>{const a=e.timestamp?new Date(e.timestamp).getTime():parseInt(e.id||"0");return(t.timestamp?new Date(t.timestamp).getTime():parseInt(t.id||"0"))-a})[0])}catch(a){}}else{const n=`tdmfriends:tdmResults:${e}:${t}`,r=window.localStorage.getItem(n);if(r)try{const e=JSON.parse(r);e&&e.length>0&&(u=e.filter(e=>e.timestamp||e.id).sort((e,t)=>{const a=e.timestamp?new Date(e.timestamp).getTime():parseInt(e.id||"0");return(t.timestamp?new Date(t.timestamp).getTime():parseInt(t.id||"0"))-a})[0],(null==u?void 0:u.summary)?d=JSON.stringify(u.summary):(null==u?void 0:u.data)&&(d=JSON.stringify(u.data)))}catch(a){}}if(d&&l(JSON.parse(d)),(null==u?void 0:u.dataset)&&Array.isArray(u.dataset)&&u.dataset.length>0){const e=u.dataset[0];void 0!==e.TOXI&&x(e.TOXI)}const g=`tdmfriends:tdmExtraSeries:${e}:${t}`,f=window.localStorage.getItem(g);f&&c(JSON.parse(f));const h=`tdmfriends:prescription:${e}:${t}`,w=window.localStorage.getItem(h);if(w){const e=JSON.parse(w);p({tau:e.tau,amount:e.amount})}}catch(r){}finally{w(!1)}})():w(!1)},[e,t]),{patient:a,prescription:r,tdmResult:s,tdmExtraSeries:u,prescriptionInfo:g,inputTOXI:f,isLoading:h}})({patientId:_,drugName:T});d.useEffect(()=>{(()=>{try{const t=(o.getJSON(m.patients,[])||[]).map(e=>({...e,createdAt:e.createdAt?new Date(e.createdAt):new Date}));j(t);const a=(o.getJSON(m.bloodTests,[])||[]).map(e=>({...e,testDate:e.testDate?new Date(e.testDate):new Date}));I(a);const n=(o.getJSON(m.drugAdministrations,[])||[]).map(e=>({...e,date:e.date?new Date(e.date):new Date}));if($(n),_)try{const e=window.localStorage.getItem(`tdmfriends:selectedDrug:${_}`);e&&N(e)}catch(e){}}catch(e){}})(),S((new Date).toLocaleString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}))},[_]);return A?e.jsxs("div",{className:"min-h-screen bg-gray-50 dark:bg-background",children:[e.jsx(l,{}),e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsx(t,{className:"mb-6",children:e.jsx(a,{className:"py-4",children:e.jsx("p",{className:"text-sm text-gray-600 dark:text-muted-foreground text-center",children:"Report를 조회한 후 이 탭을 닫고 이전 창으로 복귀하면 계속해서 서비스를 이용하실 수 있습니다."})})}),e.jsx(t,{className:"mb-6",children:e.jsx(n,{children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsxs(r,{className:"text-xl",children:[A.name," 환자의 ",T," TDM 분석 보고서 - 분석일자: ",v]}),e.jsxs(i,{className:"mt-2",children:[A.name," 환자(",A.id,")의 Report를 조회하고 다운로드할 수 있습니다."]})]}),e.jsxs(s,{onClick:async()=>{try{const e=document.getElementById("report-content");if(!e)return void alert("보고서 내용을 찾을 수 없습니다.");const t=document.querySelector("[data-download-button]");t&&(t.disabled=!0,t.textContent="PDF 생성 중...");const a=await g(e,{scale:1.5,useCORS:!0,allowTaint:!0,backgroundColor:"#ffffff",logging:!1,width:e.scrollWidth,height:e.scrollHeight,scrollX:0,scrollY:0}),n=a.toDataURL("image/png",.95),r=new p({orientation:"portrait",unit:"mm",format:"a4"}),i=15,s=210-2*i,d=297-2*i,l=a.width,o=a.height,m=Math.min(s/l,d/o),u=l*m,c=o*m,f=d,x=Math.ceil(c/f);for(let g=0;g<x;g++){g>0&&r.addPage();const e=-g*f,t=g*f;Math.min(f,c-t);r.addImage(n,"PNG",i,i+e,u,c,void 0,"FAST")}const h=`${(null==A?void 0:A.name)||"환자"}_${T||"약품"}_TDM_분석보고서_${(new Date).toISOString().split("T")[0]}.pdf`;r.save(h),t&&(t.disabled=!1,t.textContent="Report Download")}catch(e){alert("PDF 생성 중 오류가 발생했습니다: "+e.message);const t=document.querySelector("[data-download-button]");t&&(t.disabled=!1,t.textContent="Report Download")}},className:"flex items-center gap-2","data-download-button":!0,children:[e.jsx(x,{className:"h-4 w-4"}),"Report Download"]})]})})}),e.jsxs(t,{className:"mb-6",id:"report-content",children:[e.jsx(n,{}),e.jsx(a,{children:e.jsx(u,{currentPatient:A,selectedPrescription:C,latestBloodTest:y.filter(e=>e.patientId===A.id&&e.drugName===T).sort((e,t)=>new Date(t.testDate).getTime()-new Date(e.testDate).getTime())[0]||null,drugAdministrations:b.filter(e=>e.patientId===A.id&&e.drugName===T),isExpanded:!0,onToggleExpanded:()=>{},disableHover:!0})}),e.jsx(a,{className:"pt-6 border-t",children:A&&T?O?e.jsx(c,{showSimulation:!0,currentPatientName:A.name,selectedDrug:T,targetMin:(null==C?void 0:C.tdmTargetValue)?parseFloat((null==(h=C.tdmTargetValue.split("-")[0])?void 0:h.trim())||"0"):null,targetMax:(null==C?void 0:C.tdmTargetValue)?parseFloat((null==(w=C.tdmTargetValue.split("-")[1])?void 0:w.trim())||"0"):null,recentAUC:(null==O?void 0:O.AUC_24_before)||(null==O?void 0:O.AUC_tau_before)||(null==O?void 0:O.AUC24h_before)||(null==O?void 0:O.AUCtau_before)||null,recentMax:(null==O?void 0:O.CMAX_before)||(null==O?void 0:O.CMax_before)||null,recentTrough:(null==O?void 0:O.CTROUGH_before)||(null==O?void 0:O.CTrough_before)||null,predictedAUC:(null==O?void 0:O.AUC_24_after)||(null==O?void 0:O.AUC_tau_after)||(null==O?void 0:O.AUC24h_after)||(null==O?void 0:O.AUCtau_after)||null,predictedMax:(null==O?void 0:O.CMAX_after)||(null==O?void 0:O.CMax_after)||null,predictedTrough:(null==O?void 0:O.CTROUGH_after)||(null==O?void 0:O.CTrough_after)||null,ipredSeries:null==R?void 0:R.ipredSeries,predSeries:null==R?void 0:R.predSeries,observedSeries:null==R?void 0:R.observedSeries,tdmIndication:null==C?void 0:C.indication,tdmTarget:null==C?void 0:C.tdmTarget,tdmTargetValue:null==C?void 0:C.tdmTargetValue,latestAdministration:b.filter(e=>e.patientId===A.id&&e.drugName===T).sort((e,t)=>{const a=new Date(`${e.date}T${e.time}`);return new Date(`${t.date}T${t.time}`).getTime()-a.getTime()})[0]?{dose:b.filter(e=>e.patientId===A.id&&e.drugName===T).sort((e,t)=>{const a=new Date(`${e.date}T${e.time}`);return new Date(`${t.date}T${t.time}`).getTime()-a.getTime()})[0].dose,unit:b.filter(e=>e.patientId===A.id&&e.drugName===T).sort((e,t)=>{const a=new Date(`${e.date}T${e.time}`);return new Date(`${t.date}T${t.time}`).getTime()-a.getTime()})[0].unit,intervalHours:b.filter(e=>e.patientId===A.id&&e.drugName===T).sort((e,t)=>{const a=new Date(`${e.date}T${e.time}`);return new Date(`${t.date}T${t.time}`).getTime()-a.getTime()})[0].intervalHours}:null,drugAdministrations:b.filter(e=>e.patientId===A.id&&e.drugName===T),steadyState:null==O?void 0:O.Steady_state,input_TOXI:void 0!==M?M:(null==O?void 0:O.input_TOXI)??0,tauBefore:(null==U?void 0:U.tau)||((null==C?void 0:C.frequency)?(()=>{const e=C.frequency,t=e.match(/(\d+(?:\.\d+)?)/);if(t){const a=parseFloat(t[1]);return e.includes("주")?24*a*7:a}return null})():null),amountBefore:(null==U?void 0:U.amount)||(null==C?void 0:C.dosage)||null}):e.jsxs("div",{className:"text-center py-8 text-gray-500 dark:text-muted-foreground",children:[e.jsx("p",{children:"TDM 분석 결과 데이터가 없습니다."}),e.jsx("p",{className:"text-sm mt-2",children:"시뮬레이션을 먼저 실행해주세요."})]}):null})]})]})]}):e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx(l,{}),e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsx(t,{children:e.jsx(a,{className:"py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx(f,{className:"h-16 w-16 text-muted-foreground mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"환자 정보를 찾을 수 없습니다."}),e.jsxs("p",{className:"text-sm text-gray-500 dark:text-muted-foreground mt-2",children:["URL: ",window.location.href]}),e.jsxs("p",{className:"text-sm text-gray-500 dark:text-muted-foreground",children:["환자 수: ",D.length]})]})})})})]})};export{h as default};
