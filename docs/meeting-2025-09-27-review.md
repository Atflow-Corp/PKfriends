## 2025-09-27 리뷰 로그: 환자 정보 & TDM 내역 / Let’s TDM 개선

### 목적

- **본 문서**: 9월 27일 리뷰 미팅에서 합의된 요구사항, 오류 이슈, 차트 사양, 액션 아이템을 정리한다.
- **범위**: 환자 정보/내역 조회, TDM 작업 흐름, 차트 사양(현용법/용법 조정), 단위/시간 처리, 보고서 생성 흐름.

## 환자 정보 & TDM 내역

- **환자 선택 시 호출**: 현재 진행 중인 모든 TDM + 과거 진행한 모든 TDM 내역 조회
- **동시성 제약**: 환자 1명에 대해 동일 약물로 복수 TDM을 동시에 진행할 수 없음
- **리스트업**: 진행 중/완료 내역 모두 목록에 표시
- **연동(미구현)**: 완료된 TDM의 과거 내역을 TDM 내역/신기능 데이터에 불러와야 하나 현재 미구현 — 구현 필요
- **선택 시 동작**:
  - 완료 TDM 선택 시: 시뮬레이션은 "현용법"까지만 노출, 용법 조정 결과는 제외
    - 단, 현용법 시뮬레이션 내에서 과거 TDM 결과 리포트를 볼 수 있는 링크 제공
  - 진행 중 TDM 선택 시: 전체 데이터 로드
  - 로드된 데이터는 수정 가능하며 시뮬레이션 계속 진행 가능
- **저장 범위**: 환자에 대해 약물별로 데이터 저장 (patientId + drugId 단위로 세션/데이터 분리)

## 신기능

- **최신 신기능 데이터**: 최대 5개까지 노출 (기록 N개 추가되도록 수정; 과거 데이터 연동은 미완)
- **혈청 크레아티닌 자동 계산**: 자동 계산 결과의 적절성 확인 (PK)

## 투약기록 (수정 09.29)

- **경로 통합**: 정맥 주사 + 정맥 수액 ⇒ 정맥(IV)로 통합, `bolus = 0`이면 주사로 간주
- **시간 조정 단위**: 투약 시간 테이블에서 시간 조정 시 1분 단위로 ± 조정 가능하도록 기능 추가

## Let’s TDM – 차트 공통 사양

- **기준 시간(Absolute vs Relative)**
  - 기준: 첫 투약 시점을 `0h`로 놓고 절대시간(hours since first dose)으로 계산/스케일링
  - 표기: UI 라벨은 투약일시 기준과 동일한 `mm.dd HH`로 노출(상대적 표기), 내부 데이터는 절대시간 유지
- **X축(before/after)**
  - Before 데이터: 투약 기록을 바탕으로 최신 데이터 기준 최대 72시간으로 제한
    - 이 제한 기준은 API 결과에 포함되어야 함 (PK)
    - UI에서는 72시간을 한 화면에 집약하여 간단히 볼 수 있도록 노출 지향
  - After 데이터: 예측 결과는 제한 없이 전체 노출(데이터 전부 표시)
  - Before/After 기준선 추가 (수정)
- **시간 표기(tick label)**
  - 형식: `mm.dd HH`
  - 흐름: 투약기록 입력은 실제 일시(`yyyyMMdd HH:mm`) → API는 절대시간(hours)로 계산 → 서비스 노출은 상대적 시간 라벨(`mm.dd HH`)로 변환하여 표시
  - 확인: 현재 input dataset에 시간 정보가 어떤 형태로 들어가 있는지 확인 필요 (세바님)

## 현용법 차트 – 이슈/제약

- **대조군/현용법 중복 노출 오류**: 대조군과 현용법 데이터가 동일하게 노출되는 문제 (세바님)
- **연동 수정 오류**: 용법 조정에서 데이터를 조정하면 현용법 > 환자의 현용법 데이터가 같이 수정되는 문제 (세바님)
- **72시간 초과 데이터 미노출**: 72시간을 초과하는 예측 데이터 및 실제 혈중농도 측정 데이터가 노출되지 않는 문제
  - AUC area 차트에서 오류 지속 확인
  - X축 After 데이터 제한을 해제/수정하면 해결될 것으로 예상
- **반코마이신 빨간점 미표기**: 반코마이신 실제 관측치(red dot)가 차트에 표시되지 않는 문제 확인 필요
- **불변성 보장**: "현재 용법 차트는 바뀌면 안됨" — 용법 조정 편집이 현용법 시리즈에 영향을 주지 않도록 데이터 불변성 보장

## 용법 조정 차트 – 요구사항

- **비교 노출**: 용법 조정 결과와 현용법 결과를 함께 노출하여 비교 가능하도록 수정
- **옵션 제한 (PK)**
  - 사용자가 입력한 현용법을 기준으로 적정용법을 찾을 때까지 API 반복 호출
  - 다수의 적정용법 결과가 도출되는 경우, API가 제공할 옵션 값을 지정해서 응답 (서버측 정책)
  - 시간 조정 옵션에 `weeks` 단위를 추가 (약물 별 투약 간격 가이드는 약물 정보 엑셀에 업데이트 예정)
- **결과 노출 범위**: 설정된 용량/시간 조정 범위에 들어오는 모든 후보 결과를 노출(필요 시 페이징/선택 UI 제공)

## 시뮬레이션 차트 – 추가 이슈

- 용법조정 차트에 환자 현용법 시리즈가 가장 아래 레이어로 깔려 가독성 저하 → 레이어 순서/투명도 조정 필요
- 예측 구간(after)에서 동일한 peak–trough 패턴 대신 무한 감쇄처럼 보이는 구간 존재 → 모델/스케일/데이터 변환 검증 필요

## 기타

- **AUC 목표치 (PK)**
  - 목표치는 24H 기준
  - API 전송 결과는 1회 투약 기준이므로 24시간 기준으로 변환한 값을 결과값으로 사용해야 함
  - AUC 데이터는 24시간 변환 값으로 API 결과를 전송 예정
- **단위 표기 오류 (세바님 확인)**
  - 반코마이신: `mg/L` → 정상 노출
  - 사이클로스포린: 실제 단위 `ng/mL`이나 차트에서 `mg/L`로 인지되어, 1/1000로 축소되어 0에 가깝게 보이는 오류 존재
- **분석 보고서 – 1회기 종료 기준**
  - 보고서 생성 버튼 클릭 시 데이터 Freezing
  - PDF 뷰어 화면으로 이동 후 다운로드 제공
  - 환자 정보 > 보고서 조회 히스토리 업데이트
  - TODO: 보고서 PDF 생성 시 용법 차트의 축 렌더링 기준 정의 필요
  - PDF 다운로드 화면: PK차트 데이터 바인딩 이슈로 빈 값 노출 — 데이터 소스/순서 검증 필요

## API/데이터 계약 사항 (요약)

- **Before 윈도우**: 최신 데이터 기준 최대 72시간 제한 값을 API 응답에 포함 (서버 제공)
- **시간 처리**: 입력(실제 일시) → 서버(절대시간, hours) → 클라이언트(라벨 `mm.dd HH`)
- **단위 처리**: 약물별 혈중농도 단위 정확히 매핑 (예: 사이클로스포린 `ng/mL` 유지)
- **AUC 변환**: 1회 투약 기준 결과를 24H 기준으로 변환해 사용/표출
- **저장 스키마**: 환자-약물(patientId+drugId) 단위로 TDM 세션/데이터 저장 및 조회

## 액션 아이템

- 입력 dataset의 시간 정보 구조 점검 및 `mm.dd HH` 변환 로직 확인/보완
- 현용법 차트의 대조군/현용법 동일 노출 및 연동 수정 오류 원인 파악/수정
- X축 After 제한 해제/완화로 72시간 초과 데이터 정상 노출 확인(AUC area 포함)
- 반코마이신 관측치(red dot) 미표기 원인 분석 및 표시 보정
- API 응답에 Before 72시간 제한 기준 포함하도록 필드 정의/반영
- 적정용법 후보 다건 응답 설계(범위 내 모두 반환) 및 `weeks` 단위 추가
- AUC 24H 변환 규칙 명시 및 서버 응답 값 일원화
- 단위 매핑 테이블 재검증(특히 `ng/mL` 약물) 및 차트 스케일링 검증
- 보고서 PDF 내 용법 차트 축 렌더링 정책 합의 및 구현
- 과거 종료 TDM 내역을 TDM 내역/신기능 데이터에 연동 구현
- 용법조정 차트 레이어 순서/투명도 조정으로 환자 현용법 시리즈 가독성 개선
- After 예측 구간이 무한 감쇄처럼 보이는 현상 원인 분석 및 보정
- PDF 다운로드 화면에서 PK차트 데이터 바인딩 오류로 빈 값 노출 이슈 해결

## 참고

- 본 문서는 9/27 리뷰 내용을 근거로 작성되었으며, 추가 변경사항은 후속 미팅 로그에 누적 업데이트 예정.
